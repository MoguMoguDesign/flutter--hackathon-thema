# Investigation Report: Firebase Project Setup

**Date**: 2025-11-29 17:08:13
**Branch**: feature/firebase-setup
**Issue**: [#7 Firebase プロジェクトセットアップ](https://github.com/MoguMoguDesign/flutter--hackathon-thema/issues/7)
**Priority**: High (Phase 1: 基盤構築)

---

## Executive Summary

GitHub Issue #7 requires Firebase integration for Flutter Web application. Investigation confirms that Firebase project creation is complete (myaku-haiku), and implementation requires:

1. Adding Firebase dependencies to pubspec.yaml
2. Initializing Firebase in main.dart
3. Configuring Firebase SDK for Web
4. Setting up Firestore and Storage security rules
5. Creating Firebase service classes in Shared layer

Implementation is **RECOMMENDED** and follows the project's three-layer architecture.

---

## Issue Requirements

### Tasks from Issue #7

- [x] Firebase プロジェクト作成 (Completed by user: myaku-haiku)
- [ ] Flutter Web 用の Firebase 設定
- [ ] `pubspec.yaml` に依存関係追加
  - `firebase_core`
  - `cloud_firestore`
  - `firebase_storage`
- [ ] Firebase 初期化コード（`main.dart`）
- [ ] Firestore セキュリティルール設定
- [ ] Storage セキュリティルール設定

### Firebase Project Information

- **Project ID**: myaku-haiku
- **Console URL**: https://console.firebase.google.com/u/0/project/myaku-haiku/overview?hl=ja
- **Platform**: Flutter Web

---

## Current Project State

### Technology Stack

| Component | Version/Package |
|-----------|----------------|
| Flutter | 3.35.1 (stable) |
| Dart | 3.9.0 |
| State Management | hooks_riverpod 3.0.3 |
| Routing | go_router 16.2.4 |
| Code Generation | build_runner, riverpod_generator, freezed |
| Static Analysis | very_good_analysis 10.x, riverpod_lint 3.x |

### Architecture: Three-Layer Structure

The project follows strict three-layer architecture (App → Feature → Shared):

```
lib/
├── app/                    # App Layer
│   ├── app_di/            # Dependency Injection
│   ├── app_router/        # Global routing (go_router)
│   ├── route_guard/       # Route guards
│   └── widgets/           # App-wide widgets
├── features/              # Feature Layer
│   ├── haiku/            # Haiku creation feature
│   ├── nickname/         # Nickname management
│   ├── posts/            # Posts display
│   └── post_creation/    # Post creation workflow
└── shared/                # Shared Layer
    ├── constants/         # App-wide constants
    ├── data/models/       # Common data models
    ├── error/             # Error handling
    ├── presentation/widgets/  # Reusable UI components
    ├── service/           # Common services (EMPTY - Firebase will go here)
    └── util/              # Utility functions
```

### Dependency Rules

- ✅ ALLOWED: App → Feature, App → Shared
- ✅ ALLOWED: Feature → Shared
- ❌ FORBIDDEN: Feature → Feature (direct dependencies)
- ❌ FORBIDDEN: Shared → Feature or Shared → App

---

## Existing Patterns Analysis

### 1. Riverpod State Management Pattern

**Pattern**: Modern @riverpod annotation with code generation

```dart
// Example: lib/app/app_di/nickname_provider.dart
import 'package:riverpod_annotation/riverpod_annotation.dart';

part 'nickname_provider.g.dart';

@Riverpod(keepAlive: true)
class TemporaryNickname extends _$TemporaryNickname {
  @override
  String? build() {
    return null;
  }

  void setNickname(String nickname) {
    state = nickname;
  }
}
```

**Key Points**:
- Use `@riverpod` annotation
- Code generation with `part` directive
- Detailed Japanese documentation comments
- `keepAlive` option for persistent state

### 2. Data Model Pattern

**Pattern**: Mix of Freezed and plain classes

```dart
// Example: lib/features/posts/data/models/post.dart
class Post {
  const Post({
    required this.id,
    required this.nickname,
    required this.haiku,
    required this.imageUrl,
    required this.createdAt,
    this.likeCount = 0,
  });

  final String id;
  final String nickname;
  final String haiku;
  final String imageUrl;
  final DateTime createdAt;
  final int likeCount;
}
```

**Key Points**:
- Not all models use Freezed (Post model is plain class)
- Will need JSON serialization for Firestore integration
- Consider adding Freezed + json_serializable for Firebase models

### 3. Widget Test Pattern

```dart
// Example: test/shared/presentation/pages/error_page_simple_test.dart
void main() {
  group('ErrorPage basic tests', () {
    testWidgets('Displays error icon', (WidgetTester tester) async {
      await tester.pumpWidget(const MaterialApp(home: ErrorPage(error: null)));
      expect(find.byIcon(Icons.error_outline), findsOneWidget);
    });
  });
}
```

**Key Points**:
- Use `testWidgets` for widget tests
- Wrap widgets in MaterialApp
- Group related tests with `group()`
- Test coverage is currently minimal (only 2 test files)

### 4. Web Configuration

**Current web/index.html**:
```html
<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">
  <meta charset="UTF-8">
  <title>flutterhackthema</title>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
```

**Key Points**:
- No Firebase SDK scripts present
- Will need to add Firebase Web SDK configuration
- Consider using FlutterFire CLI for automatic configuration

---

## Firebase Integration Strategy

### Architecture Placement

Based on three-layer architecture analysis:

#### 1. App Layer (lib/app/)

**File**: `lib/main.dart`

**Responsibility**:
- Firebase initialization in main() function
- Error handling for initialization failures
- Async initialization with proper loading state

**Implementation**:
```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  runApp(const ProviderScope(child: MainApp()));
}
```

#### 2. Shared Layer (lib/shared/service/)

**Files**:
- `lib/shared/service/firebase_service.dart` - Firebase initialization utilities
- `lib/shared/data/repositories/firestore_repository.dart` - Base Firestore repository
- `lib/shared/data/repositories/storage_repository.dart` - Base Storage repository

**Responsibility**:
- Provide abstract interfaces for Firebase services
- Common CRUD operations for Firestore
- File upload/download for Storage
- Error handling and logging

**Benefits**:
- Reusable across all Features
- Centralized Firebase logic
- Easier to test with mocks
- Follows DRY principle

#### 3. Feature Layer (lib/features/)

**Usage**:
- Each feature creates specific repositories extending Shared base classes
- Feature-specific business logic uses Shared Firebase services
- Example: `lib/features/posts/data/repositories/post_repository.dart`

**Example**:
```dart
// Shared base (lib/shared/data/repositories/firestore_repository.dart)
abstract class FirestoreRepository<T> {
  Future<T?> getById(String id);
  Future<List<T>> getAll();
  Future<void> create(T data);
}

// Feature implementation (lib/features/posts/data/repositories/post_repository.dart)
class PostRepository extends FirestoreRepository<Post> {
  // Implements abstract methods with Post-specific logic
}
```

### Required Dependencies

Add to `pubspec.yaml` dependencies section:

```yaml
dependencies:
  # Firebase
  firebase_core: ^3.12.0
  cloud_firestore: ^5.7.0
  firebase_storage: ^12.5.0

  # Configuration
  firebase_core_web: ^2.18.4  # Web platform support
```

**Version Strategy**:
- Use latest stable versions compatible with Flutter 3.35.1
- Follow FlutterFire versioning guidelines
- Run `fvm flutter pub get` after adding

### Web Configuration

**Option 1: Manual Configuration**

Update `web/index.html`:
```html
<head>
  <!-- ... existing head content ... -->

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.x.x/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.x.x/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.x.x/firebase-storage-compat.js"></script>

  <!-- Firebase Configuration -->
  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "myaku-haiku.firebaseapp.com",
      projectId: "myaku-haiku",
      storageBucket: "myaku-haiku.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
  </script>
</head>
```

**Option 2: FlutterFire CLI (RECOMMENDED)**

```bash
# Install FlutterFire CLI
dart pub global activate flutterfire_cli

# Configure Firebase for Web
flutterfire configure --project=myaku-haiku
```

This automatically:
- Generates `lib/firebase_options.dart`
- Configures Web platform settings
- Creates proper Firebase initialization code

### Security Rules

#### Firestore Security Rules

Create `firestore.rules` in project root:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Posts collection
    match /posts/{postId} {
      // Anyone can read posts
      allow read: if true;

      // Only allow creation with valid data
      allow create: if request.resource.data.keys().hasAll(['nickname', 'haikuText', 'imageUrl', 'createdAt'])
                    && request.resource.data.nickname is string
                    && request.resource.data.haikuText is string
                    && request.resource.data.imageUrl is string
                    && request.resource.data.createdAt is timestamp;

      // No updates or deletes for MVP
      allow update, delete: if false;
    }
  }
}
```

Deploy with:
```bash
firebase deploy --only firestore:rules
```

#### Storage Security Rules

Create `storage.rules` in project root:

```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Posts images directory
    match /posts/{imageId} {
      // Anyone can read images
      allow read: if true;

      // Allow uploads with size limit (5MB) and image types only
      allow create: if request.resource.size < 5 * 1024 * 1024
                    && request.resource.contentType.matches('image/.*');

      // No updates or deletes for MVP
      allow update, delete: if false;
    }
  }
}
```

Deploy with:
```bash
firebase deploy --only storage:rules
```

---

## Implementation Plan

### Phase 1: Dependencies and Configuration

**Files to modify**:
- `pubspec.yaml` - Add Firebase dependencies
- `web/index.html` - Add Firebase SDK (if manual) or use FlutterFire CLI
- `lib/firebase_options.dart` - Generated by FlutterFire CLI

**Commands**:
```bash
# Add dependencies
fvm flutter pub add firebase_core cloud_firestore firebase_storage

# Configure Firebase (recommended)
flutterfire configure --project=myaku-haiku

# Get dependencies
fvm flutter pub get
```

### Phase 2: Firebase Initialization

**File**: `lib/main.dart`

**Changes**:
```dart
import 'package:flutter/material.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:firebase_core/firebase_core.dart';

import 'package:flutterhackthema/app/app_router/app_router.dart';
import 'package:flutterhackthema/firebase_options.dart';

/// アプリケーションのエントリーポイント
///
/// Firebase初期化後、Riverpodの[ProviderScope]でアプリ全体をラップ
void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  try {
    await Firebase.initializeApp(
      options: DefaultFirebaseOptions.currentPlatform,
    );
  } catch (e) {
    // TODO: エラーハンドリングとログ出力
    debugPrint('Firebase initialization error: $e');
  }

  runApp(const ProviderScope(child: MainApp()));
}

// ... rest of MainApp class unchanged
```

### Phase 3: Shared Firebase Services

**Create files**:

1. **lib/shared/service/firebase_service.dart**
   - Firebase initialization helper methods
   - Firebase instance getters

2. **lib/shared/data/repositories/firestore_repository.dart**
   - Abstract base repository for Firestore
   - Common CRUD operations

3. **lib/shared/data/repositories/storage_repository.dart**
   - Abstract base repository for Storage
   - Upload/download methods

**Example structure**:
```dart
// lib/shared/service/firebase_service.dart
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_storage/firebase_storage.dart';

/// Firebase サービスの基本クラス
class FirebaseService {
  /// Firestore インスタンスを取得
  static FirebaseFirestore get firestore => FirebaseFirestore.instance;

  /// Storage インスタンスを取得
  static FirebaseStorage get storage => FirebaseStorage.instance;
}
```

### Phase 4: Security Rules Deployment

**Create files**:
- `firestore.rules` - Firestore security rules
- `storage.rules` - Storage security rules

**Deploy**:
```bash
firebase deploy --only firestore:rules,storage:rules
```

### Phase 5: Testing

**Create test files**:
- `test/shared/service/firebase_service_test.dart`
- `test/shared/data/repositories/firestore_repository_test.dart`
- `test/shared/data/repositories/storage_repository_test.dart`

**Test strategy**:
- Use `fake_cloud_firestore` for Firestore mocking
- Use `firebase_storage_mocks` for Storage mocking
- Test initialization error handling
- Test repository CRUD operations

---

## Risk Assessment

### High Risk Areas

1. **Web Platform Compatibility**
   - **Risk**: Firebase SDK version incompatibility with Flutter Web
   - **Mitigation**: Use FlutterFire CLI for automatic configuration
   - **Testing**: Test on Chrome, Safari, Edge browsers

2. **Security Rules**
   - **Risk**: Overly permissive rules exposing data
   - **Mitigation**: Start with restrictive rules, gradually open as needed
   - **Testing**: Use Firebase Emulator Suite for local testing

3. **Initialization Timing**
   - **Risk**: Firebase not initialized before first use
   - **Mitigation**: Use async main() with proper error handling
   - **Testing**: Test cold start and hot reload scenarios

### Medium Risk Areas

1. **Three-Layer Architecture Compliance**
   - **Risk**: Firebase logic scattered across layers
   - **Mitigation**: Strict placement in Shared layer
   - **Review**: Code review to verify no Feature → Feature dependencies

2. **Test Coverage**
   - **Risk**: Firebase services not properly tested
   - **Mitigation**: Write comprehensive unit tests with mocks
   - **Target**: Minimum 80% coverage for Firebase services

### Low Risk Areas

1. **Dependency Conflicts**
   - **Risk**: Firebase package version conflicts
   - **Mitigation**: Use latest compatible versions
   - **Resolution**: `fvm flutter pub upgrade` if needed

---

## Testing Strategy

### Unit Tests

**Target files**:
- Firebase service classes in Shared layer
- Repository base classes
- Firebase initialization logic

**Tools**:
- `fake_cloud_firestore` for Firestore mocking
- `mockito` for general mocking

**Coverage goal**: Minimum 80% for all Firebase-related code

### Widget Tests

**Target**:
- No direct Firebase widget tests needed (Firebase is backend)
- Test widgets that consume Firebase data with mocked providers

### Integration Tests

**Target**:
- End-to-end flow: Create post → Upload to Storage → Save to Firestore
- Read posts from Firestore and display

**Environment**:
- Use Firebase Emulator Suite for local testing
- Avoid using production Firebase during tests

---

## Compliance with Project Standards

### Three-Layer Architecture ✅

- **App Layer**: Firebase initialization only
- **Shared Layer**: Firebase services and base repositories
- **Feature Layer**: Feature-specific repositories extending Shared base
- **No violations**: No Feature → Feature dependencies

### Coding Standards ✅

- **Riverpod Pattern**: Use @riverpod annotation for providers
- **Documentation**: Japanese comments for public APIs
- **Naming**: snake_case files, PascalCase classes, camelCase variables
- **Imports**: Follow established import order
- **Const**: Use const constructors where possible

### Testing Requirements ✅

- **Coverage**: Minimum 80% for Firebase services
- **Test Structure**: Mirror source structure in test/
- **Widget Tests**: Use testWidgets pattern
- **Mocking**: Use proper mocking libraries

---

## Recommendations

### Implementation Priority

1. **High Priority** (Must complete for Issue #7):
   - Add Firebase dependencies to pubspec.yaml
   - Configure Firebase Web SDK (use FlutterFire CLI)
   - Initialize Firebase in main.dart
   - Create Firestore and Storage security rules
   - Deploy security rules to Firebase project

2. **Medium Priority** (Should complete for architecture compliance):
   - Create Shared layer Firebase services
   - Create base repository classes
   - Add comprehensive error handling
   - Write unit tests for Firebase services

3. **Low Priority** (Nice to have):
   - Add Firebase Emulator Suite for local development
   - Create Firebase initialization loading screen
   - Add detailed logging for Firebase operations

### Next Steps

1. **Immediate**: Proceed to PLAN phase
   - Design detailed implementation strategy
   - Break down into specific tasks
   - Plan file changes (create/modify/delete)
   - Define test strategy

2. **After Planning**: Execute IMPLEMENT phase
   - Follow implementation plan strictly
   - Write tests alongside implementation
   - Run required quality checks:
     - `fvm flutter pub run build_runner build --delete-conflicting-outputs`
     - `fvm flutter analyze`
     - `dart format --set-exit-if-changed .`
     - `fvm flutter test`

3. **Final**: Execute TEST phase
   - Verify all tests passing
   - Confirm Firebase initialization works
   - Test security rules with Firebase Emulator
   - Validate browser compatibility

---

## Conclusion

### Investigation Status

**STATUS**: ✅ COMPLETED

### Implementation Recommendation

**RECOMMENDATION**: ✅ IMPLEMENTATION REQUIRED

Firebase integration is essential for the project's core functionality (storing posts, images). The implementation:

- Aligns with three-layer architecture
- Follows existing Riverpod and coding patterns
- Requires comprehensive testing
- Has manageable risk with proper mitigation

### Architecture Layer Assignment

**PRIMARY LAYER**: Shared Layer

**RATIONALE**:
- Firebase services are used by multiple features (posts, post_creation)
- Shared layer provides centralized, reusable Firebase logic
- Prevents Feature → Feature dependencies
- Follows DRY principle

### Test Coverage Requirement

**LEVEL**: Comprehensive (80%+ coverage)

**INCLUDES**:
- Unit tests for Firebase services
- Unit tests for repository base classes
- Widget tests with mocked Firebase data
- Integration tests with Firebase Emulator

---

## References

### Documentation

- [FlutterFire Documentation](https://firebase.flutter.dev/)
- [Firebase Web SDK Guide](https://firebase.google.com/docs/web/setup)
- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [Storage Security Rules](https://firebase.google.com/docs/storage/security/start)

### Project Documentation

- `docs/ARCHITECTURE.md` - Three-layer architecture details
- `docs/STYLE_GUIDE.md` - Coding standards and conventions
- `docs/REQUIREMENTS.md` - Project requirements and features
- `CLAUDE.md` - Project-specific guidelines

### Related Issues

- Issue #7 - Firebase プロジェクトセットアップ (Current)
- Issue #10 - SharedPreferences による永続化 (Mentioned in nickname_provider.dart)

---

**Investigation completed**: 2025-11-29 17:08:13
**Next phase**: PLAN
**Branch**: feature/firebase-setup
**Estimated effort**: 1 hour (as specified in Issue #7 title)
