# Investigation Report: Gemini API Key Environment Variable Configuration

**Issue**: [#42 - Gemini API Keyの環境変数設定とVercel環境変数の更新](https://github.com/MoguMoguDesign/flutter--hackathon-thema/issues/42)
**Date**: 2025-11-30
**Branch**: `feature/gemini-api-key-env-config`
**Status**: COMPLETED

---

## 1. Issue Summary

### Background and Purpose
- Gemini API Keyをコードにハードコーディングせず、環境変数として管理する
- セキュリティ向上とAPIキーの柔軟な管理を実現する
- Vercelデプロイ環境でも同様の設定を適用する

### Tasks Requested
1. ローカル環境の設定 (`.env.example`, `.env`, `.gitignore`)
2. Vercel環境変数の設定
3. コード修正（環境変数を参照するように）
4. ドキュメント更新

---

## 2. Current State Analysis

### 2.1 API Key Configuration (Current)

**File**: `lib/shared/constants/api_config.dart`

```dart
class ApiConfig {
  ApiConfig._();

  /// Gemini API キー
  // ignore: do_not_hardcode_secrets
  static const String geminiApiKey = 'AIzaSyATSjXts7-jC-6KQTHmo7uDv_taJZmsokM';

  // ... other configurations
}
```

**Finding**: API Keyがハードコーディングされている（セキュリティリスク）

### 2.2 Environment Variable Files

| File | Status | Content |
|------|--------|---------|
| `.env` | Not exists | - |
| `.env.local` | Exists | Vercel OIDC Token only |
| `.env.example` | Not exists | - |

### 2.3 .gitignore Analysis

**Current State**:
- `.env` is NOT in `.gitignore` (Security Risk!)
- `.env.local` is NOT in `.gitignore` (Security Risk!)

**Critical Security Issue**:
`.env.local` contains a Vercel OIDC Token that should not be committed to Git.

### 2.4 Gemini API Usage Files

| File | Layer | Description |
|------|-------|-------------|
| `lib/shared/constants/api_config.dart` | Shared | API configuration with hardcoded key |
| `lib/shared/service/gemini_service.dart` | Shared | HTTP client for Gemini API |
| `lib/shared/data/repositories/image_generation_repository.dart` | Shared | Repository abstraction |
| `lib/shared/data/repositories/image_generation_repository_web.dart` | Shared | Web-specific implementation |

All files import `ApiConfig.geminiApiKey` for API key access.

### 2.5 Environment Variable Package Status

**Current**: No environment variable package installed

**Options for Flutter Web**:
1. `flutter_dotenv` - File-based, requires asset bundling (not suitable for Web production)
2. `--dart-define` - Build-time injection (recommended for Web)
3. JavaScript interop - Read from `window.ENV` (suitable for Vercel)

---

## 3. Architecture Compliance

### Three-Layer Architecture Check

| Layer | Files | Status |
|-------|-------|--------|
| Shared | `lib/shared/constants/api_config.dart` | Correct placement |
| Shared | `lib/shared/service/gemini_service.dart` | Correct placement |
| Shared | `lib/shared/data/repositories/` | Correct placement |

**Dependency Direction**: No violations found. All Gemini API code is in the Shared layer.

### Provider Pattern Check

```dart
// lib/shared/service/gemini_service.dart
@riverpod
GeminiService geminiService(Ref ref) {
  final service = GeminiService();
  ref.onDispose(service.dispose);
  return service;
}
```

**Status**: Correct usage of `@riverpod` annotation

---

## 4. Recommended Solution

### 4.1 Flutter Web Environment Variable Strategy

For Flutter Web deployed to Vercel, the recommended approach is:

1. **Build-time injection** via `--dart-define`:
   ```bash
   flutter build web --dart-define=GEMINI_API_KEY=$GEMINI_API_KEY
   ```

2. **Code modification** to use `String.fromEnvironment`:
   ```dart
   static const String geminiApiKey = String.fromEnvironment(
     'GEMINI_API_KEY',
     defaultValue: '',
   );
   ```

### 4.2 Vercel Configuration

Vercel supports environment variables directly:
1. Dashboard > Project Settings > Environment Variables
2. Add `GEMINI_API_KEY` for Production/Preview/Development

### 4.3 Local Development

For local development:
1. Create `.env` file with `GEMINI_API_KEY=xxx`
2. Use a script or Makefile to inject the variable during build/run

---

## 5. Security Fixes Required

### 5.1 .gitignore Updates

Add the following to `.gitignore`:
```gitignore
# Environment Variables
.env
.env.local
.env.*.local
```

### 5.2 Remove Sensitive Data

- Remove the hardcoded API key from `api_config.dart`
- Consider rotating the exposed API key

---

## 6. Files to Modify

| File | Action | Description |
|------|--------|-------------|
| `.gitignore` | Modify | Add `.env` and `.env.local` |
| `lib/shared/constants/api_config.dart` | Modify | Use `String.fromEnvironment` |
| `.env.example` | Create | Template for environment variables |
| `README.md` | Modify | Add environment variable setup instructions |
| `vercel.json` | Modify (if needed) | Build command with `--dart-define` |

---

## 7. Test Strategy

### Unit Tests
- Test `ApiConfig.hasGeminiApiKey` behavior when key is empty
- Test `GeminiService` error handling when API key is missing

### Integration Tests
- Verify image generation works with valid API key
- Verify appropriate error handling with invalid/missing API key

---

## 8. Risk Assessment

| Risk | Level | Mitigation |
|------|-------|------------|
| API key exposure in Git history | HIGH | Rotate API key after fix |
| Breaking existing functionality | MEDIUM | Thorough testing before deploy |
| Vercel build failure | LOW | Test build locally first |

---

## 9. Next Steps

1. **PLAN Phase**: Create detailed implementation plan
2. **IMPLEMENT Phase**: Execute the changes
3. **TEST Phase**: Verify all changes work correctly

---

## 10. Conclusion

```
status: COMPLETED
next: PLAN
branch: feature/gemini-api-key-env-config
architecture_layer: Shared
test_coverage_required: comprehensive
details: "Investigation complete. feature/gemini-api-key-env-config branch created. Security vulnerabilities identified: hardcoded API key and missing .gitignore entries. Implementation strategy recommended using String.fromEnvironment for Flutter Web compatibility."
```

---

## Appendix: New API Key

The new Gemini API key to be configured:
```
AIzaSyAFX6Zx0_FoGTfnthtK_MP2mmxdRfxiV4s
```

**Note**: This key should be set as an environment variable in Vercel, not committed to the repository.
