# Investigation Report: Image Generation API Integration

**Date**: 2025-11-29 21:39:37
**Branch**: feature/image-generation-api
**Issue**: [#14 画像生成（nanobanana API連携） 3時間](https://github.com/MoguMoguDesign/flutter--hackathon-thema/issues/14)
**Priority**: High (Phase 2: 機能実装)

---

## Executive Summary

GitHub Issue #14 requires implementation of AI image generation functionality for the haiku application. Investigation reveals:

1. **Current State**: `GeneratingPage` uses mock implementation (picsum.photos placeholder)
2. **API Options**: Two APIs documented - OpenAI DALL-E 3 and Google Gemini
3. **Recommendation**: Use Gemini API for better rate limits (60+ RPM vs 5-7 RPM for DALL-E)
4. **Architecture**: API client in Shared layer, state management with Riverpod

Implementation is **RECOMMENDED** following the project's three-layer architecture.

---

## Issue Requirements

### Tasks from Issue #14

- [ ] nanobanana 3 API client implementation (Gemini API recommended)
- [ ] Add `http` package to dependencies
- [ ] Prompt generation logic (haiku to image prompt conversion)
- [ ] Image generation processing
  - Loading display ("生成中...")
  - Store generated image in memory
- [ ] Error handling
- [ ] Timeout processing (60 seconds)
- [ ] API key management (environment variables / --dart-define)
- [ ] Regenerate functionality

### Dependencies

- Project structure setup (completed)
- Haiku creation (haiku input screen) (completed)

### Application Flow

```
[俳句の作成] → [画像生成] → [俳句の投稿]
   (Done)      (Issue #14)    (Future)
```

---

## Current Project State

### Technology Stack

| Component | Version/Package |
|-----------|----------------|
| Flutter | 3.24.0+ (FVM managed) |
| Dart | 3.9.0+ |
| State Management | hooks_riverpod 3.0.3 |
| Routing | go_router 16.2.4 |
| Code Generation | build_runner, riverpod_generator, freezed |
| Firebase | firebase_core, cloud_firestore, firebase_storage |

### Existing haiku Feature Files

```
lib/features/haiku/presentation/
├── pages/
│   ├── haiku_input_page.dart    # Haiku input (3 steps)
│   ├── generating_page.dart     # Loading screen (MOCK)
│   └── preview_page.dart        # Image preview
└── widgets/
    ├── haiku_preview.dart       # Vertical haiku display
    └── step_indicator.dart      # Step progress indicator
```

### Current Mock Implementation

**File**: `lib/features/haiku/presentation/pages/generating_page.dart`

```dart
// Current mock implementation (lines 30-49)
useEffect(() {
  Future<void> simulateGeneration() async {
    for (var i = 0; i <= 100; i += 5) {
      await Future<void>.delayed(const Duration(milliseconds: 150));
      if (context.mounted) {
        progress.value = i / 100;
      }
    }
    if (context.mounted) {
      PreviewRoute(
        firstLine: firstLine,
        secondLine: secondLine,
        thirdLine: thirdLine,
        imageUrl: 'https://picsum.photos/seed/haiku/400/500',  // MOCK
      ).go(context);
    }
  }
  simulateGeneration();
  return null;
}, []);
```

**Issue**: Uses placeholder image URL instead of real API call.

---

## API Comparison Analysis

### Available API Documentation

Project has existing curl examples in `docs/`:
- `openai_api_curl_examples.md` - OpenAI DALL-E 3 examples
- `gemini_api_curl_examples.md` - Google Gemini examples

### Rate Limit Comparison

| Feature | Gemini | DALL-E 3 |
|---------|--------|----------|
| Rate Limit | 60+ RPM | 5-7 RPM (Tier 1) |
| Parallel Requests | 50+ possible | ~5 limit |
| Image Output | base64 (direct) | URL (2hr expiry) |
| Cost | Lower | Higher |
| Japanese Prompts | Good | Good |

### Recommendation: Gemini API

**Reasons**:
1. Better rate limits for hackathon demo
2. Direct base64 output (no URL expiry issues)
3. Lower cost
4. Documented and tested in project

### Gemini API Details

```
Endpoint: https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:streamGenerateContent
Method: POST
Auth: API key in query parameter
Response: base64 encoded image in JSON
```

---

## Three-Layer Architecture Compliance

### Proposed Structure

```
lib/
├── shared/                          # Shared Layer
│   ├── data/
│   │   └── repositories/
│   │       └── image_generation_repository.dart  # NEW
│   ├── service/
│   │   └── gemini_service.dart      # NEW - HTTP client wrapper
│   └── models/
│       └── image_generation_result.dart  # NEW - Freezed model
│
└── features/
    └── haiku/
        ├── presentation/
        │   ├── providers/
        │   │   └── image_generation_provider.dart  # NEW - @riverpod
        │   ├── state/
        │   │   └── image_generation_state.dart     # NEW - Freezed state
        │   └── pages/
        │       └── generating_page.dart            # MODIFY
        └── service/
            └── haiku_prompt_service.dart           # NEW - Prompt logic
```

### Dependency Flow (Valid)

```
App Layer
    ↓
Feature Layer (haiku)
    ├── ImageGenerationProvider (uses)
    │       ↓
Shared Layer
    └── ImageGenerationRepository
            ↓
        GeminiService (HTTP calls)
```

---

## Detailed Implementation Plan

### 1. Dependencies (pubspec.yaml)

```yaml
dependencies:
  http: ^1.2.0  # For API calls
```

### 2. Shared Layer Components

#### 2.1 GeminiService (`lib/shared/service/gemini_service.dart`)

- HTTP client wrapper for Gemini API
- Handles request/response formatting
- Timeout configuration (60 seconds)
- Base64 image extraction

#### 2.2 ImageGenerationRepository (`lib/shared/data/repositories/image_generation_repository.dart`)

- Abstracts image generation operations
- Handles error transformation
- Provides testable interface

#### 2.3 ImageGenerationResult Model (`lib/shared/models/image_generation_result.dart`)

```dart
@freezed
class ImageGenerationResult with _$ImageGenerationResult {
  const factory ImageGenerationResult({
    required Uint8List imageData,
    required String mimeType,
    String? textResponse,
  }) = _ImageGenerationResult;
}
```

### 3. Feature Layer Components

#### 3.1 HaikuPromptService (`lib/features/haiku/service/haiku_prompt_service.dart`)

- Converts 3-line haiku to image generation prompt
- Japanese art style specification (ukiyo-e style)
- Prompt template management

```dart
class HaikuPromptService {
  String generatePrompt({
    required String firstLine,
    required String secondLine,
    required String thirdLine,
  }) {
    final haiku = '$firstLine $secondLine $thirdLine';
    return '''
「$haiku」 - 左記の俳句から連想される情景の画像を浮世絵風に生成してください。
俳句の文字列は画像の中に縦書きで埋め込んでください。
埋め込む際、五七五で改行してください。
''';
  }
}
```

#### 3.2 ImageGenerationState (`lib/features/haiku/presentation/state/image_generation_state.dart`)

```dart
@freezed
class ImageGenerationState with _$ImageGenerationState {
  const factory ImageGenerationState.initial() = _Initial;
  const factory ImageGenerationState.loading(double progress) = _Loading;
  const factory ImageGenerationState.success(Uint8List imageData) = _Success;
  const factory ImageGenerationState.error(String message) = _Error;
}
```

#### 3.3 ImageGenerationProvider (`lib/features/haiku/presentation/providers/image_generation_provider.dart`)

```dart
@riverpod
class ImageGeneration extends _$ImageGeneration {
  @override
  ImageGenerationState build() => const ImageGenerationState.initial();

  Future<void> generate({
    required String firstLine,
    required String secondLine,
    required String thirdLine,
  }) async {
    state = const ImageGenerationState.loading(0.0);

    try {
      final result = await ref.read(imageGenerationRepositoryProvider)
          .generateImage(prompt: prompt);
      state = ImageGenerationState.success(result.imageData);
    } catch (e) {
      state = ImageGenerationState.error(e.toString());
    }
  }
}
```

### 4. API Key Management

Two options available:

#### Option A: --dart-define (Recommended for Demo)

```bash
flutter run --dart-define=GEMINI_API_KEY=your_key_here
```

```dart
const geminiApiKey = String.fromEnvironment('GEMINI_API_KEY');
```

#### Option B: Environment Variables

```dart
import 'dart:io' show Platform;
final geminiApiKey = Platform.environment['GEMINI_API_KEY'];
```

---

## Error Handling Strategy

### Error Types

| Error Type | Description | User Message |
|------------|-------------|--------------|
| NetworkError | No internet connection | "ネットワーク接続を確認してください" |
| TimeoutError | Request exceeded 60s | "生成に時間がかかりすぎました。再試行してください" |
| ApiError | API returned error | "画像生成に失敗しました。再試行してください" |
| InvalidResponse | Unexpected response format | "予期しないエラーが発生しました" |

### Retry Strategy

- Automatic retry: Not implemented (manual regenerate button exists)
- User can tap "生成をやり直す" button on PreviewPage

---

## Test Strategy

### Unit Tests

| Test Target | Test File | Coverage |
|-------------|-----------|----------|
| GeminiService | `test/shared/service/gemini_service_test.dart` | HTTP mocking |
| ImageGenerationRepository | `test/shared/data/repositories/image_generation_repository_test.dart` | Error handling |
| HaikuPromptService | `test/features/haiku/service/haiku_prompt_service_test.dart` | Prompt generation |
| ImageGenerationProvider | `test/features/haiku/presentation/providers/image_generation_provider_test.dart` | State transitions |

### Widget Tests

| Widget | Test File | Coverage |
|--------|-----------|----------|
| GeneratingPage | `test/features/haiku/presentation/pages/generating_page_test.dart` | Loading states, error states |

### Mock Strategy

```dart
// Mock for HTTP client
class MockClient extends Mock implements http.Client {}

// Mock for repository in widget tests
class MockImageGenerationRepository extends Mock
    implements ImageGenerationRepository {}
```

### Test Execution Commands

```bash
# Run all tests
fvm flutter test

# Run specific feature tests
fvm flutter test test/features/haiku/

# Run with coverage
fvm flutter test --coverage
```

---

## Implementation Risks

### Risk 1: API Rate Limits

**Risk**: Hitting Gemini rate limits during demo
**Mitigation**:
- Gemini has 60+ RPM (sufficient)
- Implement client-side debounce
- Show clear feedback during generation

### Risk 2: Large Base64 Data

**Risk**: Memory issues with large image data
**Mitigation**:
- Use Uint8List for efficient memory
- Clear image data when navigating away
- Limit to single image at a time

### Risk 3: API Key Exposure

**Risk**: API key hardcoded or committed
**Mitigation**:
- Use --dart-define for runtime injection
- Add API key pattern to .gitignore
- Document key management in README

---

## Files to Create/Modify

### New Files

| Path | Purpose |
|------|---------|
| `lib/shared/service/gemini_service.dart` | Gemini API HTTP client |
| `lib/shared/data/repositories/image_generation_repository.dart` | Image generation abstraction |
| `lib/shared/models/image_generation_result.dart` | Result model (Freezed) |
| `lib/features/haiku/service/haiku_prompt_service.dart` | Prompt generation logic |
| `lib/features/haiku/presentation/providers/image_generation_provider.dart` | Riverpod provider |
| `lib/features/haiku/presentation/state/image_generation_state.dart` | State model (Freezed) |
| `test/shared/service/gemini_service_test.dart` | Service unit tests |
| `test/shared/data/repositories/image_generation_repository_test.dart` | Repository tests |
| `test/features/haiku/service/haiku_prompt_service_test.dart` | Prompt service tests |
| `test/features/haiku/presentation/providers/image_generation_provider_test.dart` | Provider tests |

### Modified Files

| Path | Changes |
|------|---------|
| `pubspec.yaml` | Add `http: ^1.2.0` |
| `lib/features/haiku/presentation/pages/generating_page.dart` | Replace mock with real API |
| `lib/features/haiku/presentation/pages/preview_page.dart` | Handle Uint8List image data |
| `lib/app/app_router/routes.dart` | Update PreviewRoute params |

---

## Mandatory Verification Commands

```bash
# Install dependencies
fvm flutter pub get

# Generate code (Freezed, Riverpod)
fvm flutter pub run build_runner build --delete-conflicting-outputs

# Static analysis
fvm flutter analyze

# Format code
dart format --set-exit-if-changed .

# Run tests
fvm flutter test
```

---

## Recommendations for PLAN Phase

1. **Priority Order**:
   - Add http dependency
   - Create GeminiService (Shared layer)
   - Create ImageGenerationRepository (Shared layer)
   - Create HaikuPromptService (Feature layer)
   - Create ImageGenerationProvider (Feature layer)
   - Modify GeneratingPage to use provider
   - Modify PreviewPage for Uint8List
   - Write tests
   - Manual testing with real API

2. **API Key for Development**:
   - Gemini API key already available: `AIzaSyATSjXts7-jC-6KQTHmo7uDv_taJZmsokM`
   - Use --dart-define during development

3. **Image Format Decision**:
   - Store as Uint8List in memory
   - Convert to Image.memory() for display
   - No need to save to Firebase Storage for MVP

---

## Conclusion

```
status: COMPLETED
next: PLAN
branch: feature/image-generation-api
architecture_layer: Feature (with Shared layer dependencies)
test_coverage_required: comprehensive
details: "Investigation complete. feature/image-generation-api branch created. Details in docs/investigate/investigate_20251129_213937.md. Implementation strategy recommended using Gemini API for better rate limits and direct base64 image response."
```

---

## Appendix: API Reference

### Gemini Image Generation Request

```bash
curl -s -X POST \
  -H "Content-Type: application/json" \
  "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:streamGenerateContent?key=${GEMINI_API_KEY}" \
  -d '{
    "contents": [{"role": "user", "parts": [{"text": "俳句の画像生成プロンプト"}]}],
    "generationConfig": {
      "responseModalities": ["IMAGE", "TEXT"],
      "imageConfig": {"aspectRatio": "4:5"}
    }
  }'
```

### Response Structure

```json
[{
  "candidates": [{
    "content": {
      "parts": [{
        "inlineData": {
          "mimeType": "image/jpeg",
          "data": "BASE64_ENCODED_IMAGE"
        }
      }]
    }
  }]
}]
```
