# Investigation Report: Issue #31 - Realtime Haiku Preview

**Investigation Date**: 2025-11-30 12:50:10
**Branch**: feature/realtime-haiku-preview
**Issue**: [#31 - 俳句入力中のリアルタイム縦書きプレビュー表示](https://github.com/MoguMoguDesign/flutter--hackathon-thema/issues/31)

## Summary

Investigation complete for implementing realtime vertical haiku preview during text input. The current implementation only updates the preview after pressing the "決定" button. The requested enhancement is to display the preview in realtime as the user types.

## Issue Details

### Title
[Feature]: 俳句入力中のリアルタイム縦書きプレビュー表示

### Description
Currently, the haiku creation screen updates the vertical preview only after the "決定" button is pressed. Users cannot see what their haiku looks like in real-time while typing. The enhancement request is to update the `HaikuPreview` component in realtime as the user inputs text.

### Motivation
1. **UX Improvement**: Users can immediately see how their haiku looks while typing
2. **Visual Character Count**: Vertical display makes it easier to verify haiku length and balance
3. **Early Error Detection**: Users can identify and fix issues before pressing the decision button
4. **UX Consistency**: Realtime preview is a standard feature expected by users

## Current Implementation Analysis

### File Structure
```
lib/features/haiku/
├── presentation/
│   ├── pages/
│   │   └── haiku_input_page.dart         ← Primary modification target
│   └── widgets/
│       ├── haiku_preview.dart            ← No changes needed (already reactive)
│       ├── haiku_hint_dialog.dart
│       └── step_indicator.dart
```

### Current Behavior (haiku_input_page.dart)

**Line 53**: TextEditingController initialization
```dart
final inputController = useTextEditingController();
```

**Lines 56-64**: Existing useEffect for validation
```dart
useEffect(() {
  void listener() {
    final text = inputController.text.trim();
    isValid.value = text.isNotEmpty && text.length <= 10;
  }
  inputController.addListener(listener);
  return () => inputController.removeListener(listener);
}, [inputController]);
```

**Lines 204-209**: HaikuPreview widget (only shows confirmed values)
```dart
HaikuPreview(
  firstLine: firstLine.value,
  secondLine: currentStep.value >= 1 ? secondLine.value : '',
  thirdLine: currentStep.value >= 2 ? thirdLine.value : '',
),
```

### HaikuPreview Widget (haiku_preview.dart)

**Lines 26-47**: StatelessWidget that accepts three line parameters
```dart
class HaikuPreview extends StatelessWidget {
  const HaikuPreview({
    this.firstLine = '',
    this.secondLine = '',
    this.thirdLine = '',
    super.key,
  });

  final String firstLine;
  final String secondLine;
  final String thirdLine;
  // ... implementation
}
```

**Key Finding**: HaikuPreview is already reactive. It will automatically update when its parameters change. No modifications needed to this widget.

## Architecture Compliance

### Three-Layer Architecture: COMPLIANT ✓

**Layer**: Feature Layer → Presentation
- Location: `lib/features/haiku/presentation/pages/haiku_input_page.dart`
- Dependency Direction: Feature → Shared (correct)
- No Feature-to-Feature dependencies (correct)

**Shared Components Used**:
- `AppTextField` (shared/presentation/widgets/inputs/)
- `AppFilledButton` (shared/presentation/widgets/)
- `AppBackButton` (shared/presentation/widgets/navigation/)
- `AppScaffoldWithBackground` (shared/presentation/widgets/)

### State Management: COMPLIANT ✓

**Pattern**: Flutter Hooks (flutter_hooks) with hooks_riverpod
- Uses `HookConsumerWidget` correctly
- Local state management via `useState`
- TextEditingController via `useTextEditingController`
- Side effects via `useEffect`
- No Riverpod provider changes needed for this feature

**Riverpod Usage**:
- `haikuProvider` is used for saving to Firestore
- No state management changes required for preview feature
- Purely local UI state modification

### Code Quality: EXCELLENT ✓

**Static Analysis**: ✓ Passed
```bash
$ fvm flutter analyze
No issues found! (ran in 1.7s)
```

**Code Format**: ✓ Verified
- Follows Dart style guide
- Proper documentation comments in Japanese
- Clear separation of concerns

## Existing Test Patterns

### haiku_input_page_test.dart (23 tests - ALL PASSING)

**Test Groups**:
1. Initial rendering tests
2. Validation logic (7 tests)
3. 10-character limit (3 tests)
4. Step navigation (4 tests)
5. Input validation (3 tests)
6. Rendering (4 tests)

**Key Testing Patterns Identified**:

1. **Surface Size Adjustment** (lines 11-19):
```dart
Future<void> setLargeTestSurface(WidgetTester tester) async {
  await tester.binding.setSurfaceSize(const Size(800, 1200));
}

Future<void> resetTestSurface(WidgetTester tester) async {
  await tester.binding.setSurfaceSize(null);
}
```

2. **ProviderScope Wrapper** (lines 21-24):
```dart
Future<void> pumpTestWidget(WidgetTester tester, Widget widget) async {
  await tester.pumpWidget(ProviderScope(child: MaterialApp(home: widget)));
}
```

3. **Widget Property Verification** (line 268-283):
```dart
testWidgets('入力した値がHaikuPreviewに表示される', (tester) async {
  await setLargeTestSurface(tester);
  await pumpTestWidget(tester, const HaikuInputPage());

  await tester.enterText(find.byType(AppTextField), 'あいう');
  await tester.pump();
  await tester.tap(find.byType(AppFilledButton));
  await tester.pumpAndSettle();

  final preview = tester.widget<HaikuPreview>(find.byType(HaikuPreview));
  expect(preview.firstLine, equals('あいう'));
  expect(preview.secondLine, isEmpty);
  expect(preview.thirdLine, isEmpty);
  await resetTestSurface(tester);
});
```

### haiku_preview_test.dart (5 tests - ALL PASSING)

**Test Coverage**:
- Empty state placeholder display
- Single line vertical text display
- Three lines vertical text display
- 10-character vertical text display
- Container styling verification

## Proposed Solution

### Implementation Approach

Modify the `HaikuPreview` widget call in `haiku_input_page.dart` (lines 204-209) to pass the current input text based on the active step:

**Current Code**:
```dart
HaikuPreview(
  firstLine: firstLine.value,
  secondLine: currentStep.value >= 1 ? secondLine.value : '',
  thirdLine: currentStep.value >= 2 ? thirdLine.value : '',
),
```

**Proposed Code**:
```dart
HaikuPreview(
  firstLine: currentStep.value == 0
    ? inputController.text
    : firstLine.value,
  secondLine: currentStep.value == 1
    ? inputController.text
    : (currentStep.value >= 1 ? secondLine.value : ''),
  thirdLine: currentStep.value == 2
    ? inputController.text
    : (currentStep.value >= 2 ? thirdLine.value : ''),
),
```

### Why This Works

1. **Existing Listener**: The `useEffect` already monitors `inputController` changes (lines 56-64)
2. **Reactive Widget**: `HaikuPreview` is a `StatelessWidget` that rebuilds when parameters change
3. **No Additional State**: No new state variables or listeners needed
4. **Minimal Changes**: Only 5-10 lines modified in one file
5. **No Breaking Changes**: Maintains all existing functionality

### Implementation Details

**Step 0 (上五)**:
- Display `inputController.text` in `firstLine`
- `secondLine` and `thirdLine` remain empty

**Step 1 (中七)**:
- Display confirmed `firstLine.value`
- Display `inputController.text` in `secondLine`
- `thirdLine` remains empty

**Step 2 (下五)**:
- Display confirmed `firstLine.value`
- Display confirmed `secondLine.value`
- Display `inputController.text` in `thirdLine`

**Step 3 (確認)**:
- All three lines show confirmed values
- No input field displayed

## Test Strategy

### New Test Cases Required

1. **Realtime Preview Tests**:
   - ステップ0で入力中のテキストがfirstLineにリアルタイム表示される
   - ステップ1で入力中のテキストがsecondLineにリアルタイム表示される
   - ステップ2で入力中のテキストがthirdLineにリアルタイム表示される

2. **Step Transition Tests**:
   - ステップ進行後、前のステップの確定値が保持される
   - 「決定」ボタン押下時、入力中のテキストが確定値として保存される
   - ステップ遷移時、新しいステップの入力フィールドがクリアされる

3. **Edge Case Tests**:
   - 日本語入力(かな漢字変換中)でも正しく表示される
   - 絵文字や特殊文字が縦書きで正しく表示される
   - 10文字制限を超える入力がプレビューに反映される (maxLengthで制限済み)
   - 空白文字のみの入力が適切に処理される

### Test Implementation Pattern

Following existing test pattern from `haiku_input_page_test.dart`:

```dart
testWidgets('ステップ0で入力中のテキストがfirstLineにリアルタイム表示される', (tester) async {
  await setLargeTestSurface(tester);
  await pumpTestWidget(tester, const HaikuInputPage());

  // Type text character by character
  await tester.enterText(find.byType(AppTextField), 'あ');
  await tester.pump();

  var preview = tester.widget<HaikuPreview>(find.byType(HaikuPreview));
  expect(preview.firstLine, equals('あ'));

  await tester.enterText(find.byType(AppTextField), 'あい');
  await tester.pump();

  preview = tester.widget<HaikuPreview>(find.byType(HaikuPreview));
  expect(preview.firstLine, equals('あい'));

  await resetTestSurface(tester);
});
```

## Impact Assessment

### Files to Modify
1. `lib/features/haiku/presentation/pages/haiku_input_page.dart` (5-10 lines)
2. `test/features/haiku/presentation/pages/haiku_input_page_test.dart` (add ~3-5 new tests)

### Files to Read (No Changes)
- `lib/features/haiku/presentation/widgets/haiku_preview.dart` (already reactive)
- `test/features/haiku/presentation/widgets/haiku_preview_test.dart` (existing tests sufficient)

### Breaking Changes
**None**: This is a purely additive enhancement that maintains all existing functionality.

### Performance Impact
**Minimal**:
- Text input triggers widget rebuild (already happening for validation)
- HaikuPreview is lightweight (only text display)
- No network calls or heavy computations
- Flutter's efficient diffing handles updates

### User Impact
**Positive**:
- Improved UX with realtime feedback
- Easier to verify haiku length and balance
- Reduced need to press "決定" multiple times
- Better alignment with user expectations

## Risk Analysis

### Low Risk Factors ✓
1. **Minimal Code Changes**: Only 5-10 lines modified
2. **No Architectural Changes**: Stays within Feature layer
3. **No State Management Changes**: Pure local UI update
4. **No Breaking Changes**: Maintains existing functionality
5. **Comprehensive Tests**: Existing 23 tests all passing
6. **Isolated Feature**: No dependencies on other features

### Mitigation Strategies
1. **Comprehensive Testing**: Add 3-5 new widget tests
2. **Manual Testing**: Test on multiple devices/screen sizes
3. **Japanese Input Testing**: Verify IME behavior
4. **Edge Case Coverage**: Test special characters, emojis, etc.

## Recommendations

### Implementation Priority: HIGH ✓

**Rationale**:
- Low implementation effort (~1-2 hours)
- High user value
- No architectural risks
- Clear implementation path

### Next Steps

1. **PLAN Phase**: Create detailed implementation plan
   - Exact code changes
   - Test cases specification
   - Code generation requirements

2. **IMPLEMENT Phase**: Execute implementation
   - Modify `haiku_input_page.dart`
   - Add widget tests
   - Run code generation: `fvm flutter pub run build_runner build --delete-conflicting-outputs`
   - Run static analysis: `fvm flutter analyze`
   - Run format check: `dart format --set-exit-if-changed .`
   - Run all tests: `fvm flutter test`

3. **TEST Phase**: Comprehensive verification
   - Unit tests
   - Widget tests
   - Manual testing (Japanese input, special characters)
   - Performance verification

## Technical Notes

### Code Generation
**Not Required**: No Riverpod provider changes, no Freezed model changes

### Commands to Run
```bash
# Static analysis
fvm flutter analyze

# Format check
dart format --set-exit-if-changed .

# Run tests
fvm flutter test

# Run specific test file
fvm flutter test test/features/haiku/presentation/pages/haiku_input_page_test.dart
```

### Quality Gates
All must pass:
- ✓ `fvm flutter analyze` - Zero errors
- ✓ `dart format --set-exit-if-changed .` - Properly formatted
- ✓ `fvm flutter test` - All tests passing
- ✓ Architecture compliance - Three-layer rules followed
- ✓ Documentation complete - Public APIs documented in Japanese

## Conclusion

**Status**: INVESTIGATION COMPLETED ✓
**Next Phase**: PLAN
**Branch**: feature/realtime-haiku-preview
**Architecture Layer**: Feature (Presentation)
**Test Coverage Required**: Comprehensive (Widget tests)

The investigation confirms that implementing realtime haiku preview is:
- **Feasible**: Clear implementation path identified
- **Low Risk**: Minimal code changes, no breaking changes
- **High Value**: Significant UX improvement
- **Well Tested**: Existing test infrastructure supports new tests
- **Architecture Compliant**: Stays within Feature layer boundaries

### Implementation Recommendation
**PROCEED TO PLAN PHASE**: This feature should be implemented as proposed. The solution is well-understood, low-risk, and provides significant user value.

---

**Investigation completed by**: Claude Code (Sonnet 4.5)
**Date**: 2025-11-30 12:50:10
