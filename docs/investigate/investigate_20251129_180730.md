# Investigation Report: Issue #10 - Nickname Input Screen Implementation

**Date**: 2025-11-29 18:07:30
**Branch**: feat/nickname
**Issue**: https://github.com/MoguMoguDesign/flutter--hackathon-thema/issues/10
**Priority**: High
**Phase**: Phase 2 - Feature Implementation

---

## 1. Issue Summary

### 1.1 Overview
Implementation of a nickname input screen for user identification.

### 1.2 Required Tasks (from Issue)
- [ ] Create `NicknamePage` widget
- [ ] Nickname input form
  - Text field
  - "Start" button
- [ ] Validation implementation
  - Prohibit empty strings
  - 1-20 character limit
- [ ] localStorage storage functionality (shared_preferences)
- [ ] Navigate to post list on successful save
- [ ] Auto-redirect logic for returning users

### 1.3 Dependencies
- Project structure setup (completed)
- Routing configuration (completed)

---

## 2. Current Implementation State

### 2.1 Existing Files

| File | Status | Notes |
|------|--------|-------|
| `lib/features/nickname/presentation/pages/nickname_page.dart` | Exists | Basic UI implemented |
| `lib/app/app_di/nickname_provider.dart` | Exists | Temporary in-memory provider |
| `lib/app/route_guard/nickname_guard.dart` | Exists | Redirect guard implemented |
| `lib/app/app_router/routes.dart` | Exists | NicknameRoute defined |

### 2.2 Feature Completion Analysis

| Requirement | Status | Details |
|-------------|--------|---------|
| NicknamePage widget | Partial | UI exists, but missing persistence |
| Text field input | Complete | Using shared AppTextField component |
| Submit button | Complete | Using shared PrimaryButton component |
| Empty string validation | Complete | `text.isNotEmpty` check in place |
| 1-20 char limit | Partial | Max 20 enforced, but min 1 validation could be improved |
| localStorage (shared_preferences) | NOT Started | shared_preferences dependency missing |
| Navigation to posts | Complete | `context.go('/posts')` implemented |
| Auto-redirect for returning users | NOT Started | Requires persistence layer |

### 2.3 Current Provider Architecture

The current implementation uses a temporary in-memory provider:

```dart
// lib/app/app_di/nickname_provider.dart
@Riverpod(keepAlive: true)
class TemporaryNickname extends _$TemporaryNickname {
  @override
  String? build() => null;

  void setNickname(String nickname) {
    state = nickname;
  }
}
```

**Issue**: This provider:
- Lives in App layer instead of Feature layer
- Has no persistence (loses data on app restart)
- Explicitly marked as temporary with TODO(#10) comment

---

## 3. Architecture Analysis

### 3.1 Three-Layer Compliance

**Current State**:
- Nickname provider is in App layer (`lib/app/app_di/`)
- Should be in Feature layer (`lib/features/nickname/`)

**Required Structure for Compliance**:
```
lib/features/nickname/
├── data/
│   ├── models/
│   │   └── nickname.dart (optional - simple String may suffice)
│   └── repositories/
│       └── nickname_repository.dart (shared_preferences access)
├── presentation/
│   ├── pages/
│   │   └── nickname_page.dart (exists)
│   ├── providers/
│   │   └── nickname_provider.dart (new - feature-level)
│   └── state/
│       └── nickname_state.dart (optional)
└── service/
    └── nickname_validator.dart (optional - validation logic)
```

### 3.2 Dependency Direction

- App layer correctly depends on Feature layer (routes.dart imports NicknamePage)
- Route guard in App layer depends on provider (needs refactoring)
- No Feature-to-Feature dependencies detected

---

## 4. Technical Analysis

### 4.1 Missing Dependencies

**Required Addition to pubspec.yaml**:
```yaml
dependencies:
  # Storage
  shared_preferences: ^2.3.4
```

### 4.2 SDK Version Issue

**Problem Detected**:
```
pubspec.yaml: sdk: '>=3.9.0 <4.0.0'
Current FVM Dart: 3.8.1
```

**Impact**: Build commands fail with version solving error.

**Resolution Options**:
1. Update FVM Flutter version to >=3.38.3 (Dart 3.9.0+)
2. Lower pubspec.yaml SDK constraint to `>=3.8.0 <4.0.0`

### 4.3 Current Validation Logic

```dart
// In nickname_page.dart
useEffect(() {
  void listener() {
    final text = nicknameController.text.trim();
    isValid.value = text.isNotEmpty && text.length <= 20;
  }
  nicknameController.addListener(listener);
  return () => nicknameController.removeListener(listener);
}, [nicknameController]);
```

**Analysis**:
- Empty string check: Correct
- Max 20 chars: Correct (also enforced by AppTextField maxLength)
- Min 1 char: Implicitly handled by `isNotEmpty`

### 4.4 Button Label Discrepancy

**Issue Requirement**: "Start" button
**Current Implementation**: "決定して次の行へ" (Decide and go to next line)
**Recommendation**: Consider changing to "はじめる" as specified in issue

---

## 5. Implementation Gaps

### 5.1 Critical Missing Components

1. **Persistence Layer**
   - No shared_preferences dependency
   - No repository for reading/writing nickname
   - App restart loses nickname data

2. **Auto-Redirect Logic**
   - Current guard only checks in-memory state
   - No check for persisted nickname on app launch

3. **Feature-Level Provider**
   - Provider should be in Feature layer
   - Should integrate with repository for persistence

### 5.2 Files to Create

| File | Purpose |
|------|---------|
| `lib/features/nickname/data/repositories/nickname_repository.dart` | SharedPreferences access |
| `lib/features/nickname/presentation/providers/nickname_provider.dart` | Feature-level state management |

### 5.3 Files to Modify

| File | Changes Required |
|------|------------------|
| `pubspec.yaml` | Add shared_preferences dependency |
| `lib/app/app_di/nickname_provider.dart` | Remove after migration |
| `lib/app/route_guard/nickname_guard.dart` | Update to use new provider |
| `lib/features/nickname/presentation/pages/nickname_page.dart` | Update provider import, button text |

---

## 6. Test Strategy

### 6.1 Required Tests

**Unit Tests**:
| Test File | Coverage |
|-----------|----------|
| `test/features/nickname/data/repositories/nickname_repository_test.dart` | Repository CRUD operations |
| `test/features/nickname/presentation/providers/nickname_provider_test.dart` | Provider state management |

**Widget Tests**:
| Test File | Coverage |
|-----------|----------|
| `test/features/nickname/presentation/pages/nickname_page_test.dart` | UI rendering, user interaction |
| `test/features/nickname/presentation/widgets/nickname_form_test.dart` | Form validation |

### 6.2 Test Patterns to Follow

Based on existing test in `test/shared/presentation/pages/error_page_simple_test.dart`:

```dart
void main() {
  group('NicknamePage tests', () {
    testWidgets('Displays nickname input field', (WidgetTester tester) async {
      // Wrap with ProviderScope for Riverpod
      await tester.pumpWidget(
        ProviderScope(
          child: MaterialApp(home: NicknamePage()),
        ),
      );
      expect(find.byType(AppTextField), findsOneWidget);
    });
  });
}
```

### 6.3 Mock Strategy

For shared_preferences testing:
```dart
// Use SharedPreferences.setMockInitialValues({}) in test setup
SharedPreferences.setMockInitialValues({});
```

---

## 7. Risk Assessment

### 7.1 Technical Risks

| Risk | Severity | Mitigation |
|------|----------|------------|
| SDK version mismatch | High | Resolve before implementation |
| Provider migration | Medium | Maintain backward compatibility during transition |
| Shared preferences async initialization | Medium | Handle async state properly |

### 7.2 Architecture Risks

| Risk | Severity | Mitigation |
|------|----------|------------|
| Breaking route guard during migration | Medium | Update imports carefully |
| Circular dependency introduction | Low | Follow strict layer dependencies |

---

## 8. Recommendations

### 8.1 Pre-Implementation Steps

1. **Resolve SDK Version**
   - Either update FVM Flutter version or lower SDK constraint
   - Verify `fvm flutter analyze` passes

2. **Add shared_preferences Dependency**
   ```yaml
   dependencies:
     shared_preferences: ^2.3.4
   ```

### 8.2 Implementation Order

1. Add shared_preferences to pubspec.yaml
2. Create nickname repository in data layer
3. Create feature-level provider with persistence
4. Update NicknamePage to use new provider
5. Update route guard to use new provider
6. Add auto-redirect logic on app initialization
7. Update button label to "はじめる"
8. Remove temporary provider from app_di
9. Write unit and widget tests

### 8.3 Provider Migration Strategy

**Phase 1**: Create new feature-level provider alongside temporary one
**Phase 2**: Update all consumers to use new provider
**Phase 3**: Remove temporary provider from app_di

---

## 9. Existing Component Reuse

### 9.1 Shared Components Already Used

- `AppTextField` - Reusable text input with consistent styling
- `PrimaryButton` - Main action button with loading state

### 9.2 Existing Patterns to Follow

- Riverpod @riverpod annotation pattern (see `nickname_provider.dart`)
- go_router TypedGoRoute pattern (see `routes.dart`)
- Widget test patterns (see `error_page_simple_test.dart`)

---

## 10. Conclusion

### 10.1 Summary

Issue #10 is **partially implemented**. The UI layer exists with basic functionality, but the persistence layer (shared_preferences) is completely missing. The current implementation uses a temporary in-memory provider that loses data on app restart.

### 10.2 Key Actions Required

1. Resolve SDK version compatibility issue
2. Add shared_preferences dependency
3. Implement proper three-layer architecture with repository pattern
4. Migrate provider from App layer to Feature layer
5. Implement auto-redirect logic for returning users
6. Write comprehensive tests

### 10.3 Estimated Scope

| Component | Effort Level |
|-----------|--------------|
| Repository implementation | Medium |
| Provider migration | Medium |
| Auto-redirect logic | Low |
| Button label update | Low |
| Test implementation | High |

---

## Output

```
status: COMPLETED
next: PLAN
branch: feat/nickname
architecture_layer: Feature
test_coverage_required: comprehensive
details: "Investigation complete. Branch feat/nickname exists. Details in docs/investigate/investigate_20251129_180730.md. Implementation strategy recommended for completing nickname persistence and auto-redirect functionality."
```
