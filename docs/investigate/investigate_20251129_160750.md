# Investigation Report: Project Structure Setup (Issue #8)

**Date**: 2025-11-29
**Issue**: [#8 プロジェクト構造の整備（Feature層・Shared層） 2時間](https://github.com/MoguMoguDesign/flutter--hackathon-thema/issues/8)
**Branch**: `feature/project-structure-setup`
**Priority**: High
**Phase**: Phase 1: 基盤構築

---

## Executive Summary

Issue #8 requires setting up the three-layer architecture foundation for the Flutter Hackathon Thema project. This investigation confirms that the implementation is necessary and feasible, with clear migration paths identified for existing code.

**Status**: COMPLETED
**Next Phase**: PLAN
**Architecture Layer**: Shared + Feature (multiple layers)
**Test Coverage Required**: Comprehensive

---

## Issue Requirements

### Tasks from Issue #8

1. Create `lib/shared/` directory structure
   - `widgets/` - Shared UI components
   - `models/` - Shared data models
   - `utilities/` - Utility functions

2. Create Feature structure under `lib/features/`
   - `nickname/` - Nickname feature
   - `posts/` - Posts list feature
   - `post_creation/` - Post creation feature

3. Move existing `lib/src/constants/` to `lib/shared/constants/`

---

## Current Project State

### Directory Structure Analysis

#### Existing Structure
```
lib/
├── app/                           # App Layer (well-structured)
│   ├── app_di/                    # Dependency Injection
│   │   ├── nickname_provider.dart
│   │   └── nickname_provider.g.dart
│   ├── app_router/                # Routing Configuration
│   │   ├── app_router.dart
│   │   ├── routes.dart
│   │   └── routes.g.dart
│   ├── route_guard/               # Route Guards
│   │   └── nickname_guard.dart
│   └── widgets/
│       └── pages/                 # Placeholder pages (to be migrated)
│           ├── placeholder_nickname_page.dart
│           ├── placeholder_posts_page.dart
│           ├── placeholder_create_post_page.dart
│           └── placeholder_preview_page.dart
├── features/                      # Feature Layer (EMPTY - needs setup)
├── shared/                        # Shared Layer (PARTIAL)
│   └── presentation/
│       └── pages/
│           └── error_page.dart
├── src/                           # Legacy location (to be removed)
│   └── constants/                 # TO BE MOVED to lib/shared/constants/
│       ├── app_colors.dart
│       ├── app_gradients.dart
│       └── app_text_styles.dart
├── base_ui.dart
└── main.dart
```

#### Test Structure
```
test/
├── app/
│   ├── route_guard/
│   └── app_router/
├── shared/
│   └── presentation/
│       └── pages/
│           └── error_page_simple_test.dart
└── widget_test.dart
```

### Test Status
- All tests passing: 6/6 tests
- Test files:
  - `test/shared/presentation/pages/error_page_simple_test.dart` (5 tests)
  - `test/widget_test.dart` (1 test - MainApp smoke test)
- Code coverage: Not measured yet

### Static Analysis Status
- `fvm flutter analyze`: No errors
- Dependencies resolved successfully
- 25 packages have newer versions (not blocking)

---

## Three-Layer Architecture Compliance

### Current Compliance Status

#### App Layer - COMPLIANT
- Location: `lib/app/`
- Structure:
  - `app_di/` - Dependency injection with Riverpod providers
  - `app_router/` - go_router configuration with TypedGoRoute
  - `route_guard/` - Route guards (nickname authentication guard)
  - `widgets/` - App-wide widgets (currently contains placeholder pages)
- Compliance: Proper structure, correct dependencies

#### Feature Layer - NEEDS SETUP
- Location: `lib/features/` (EMPTY)
- Required Features:
  1. `nickname/` - Nickname input feature
  2. `posts/` - Posts list feature
  3. `post_creation/` - Post creation feature
- Current Status: Directory exists but empty
- Migration Path: Placeholder pages in `lib/app/widgets/pages/` have migration instructions

#### Shared Layer - PARTIAL
- Location: `lib/shared/`
- Current Structure:
  - `presentation/pages/error_page.dart` - Error page component
- Missing Directories:
  - `constants/` (currently in `lib/src/constants/`)
  - `widgets/` (to be created)
  - `models/` (to be created)
  - `utilities/` (to be created)
  - `data/` (to be created for shared models)
  - `error/` (to be created for error handling)
  - `service/` (to be created for shared services)
  - `util/` (to be created for utilities)

### Dependency Direction Verification

Current dependencies follow proper direction (App → Feature → Shared):
- App layer correctly depends on shared constants
- No Feature-to-Feature dependencies (Features don't exist yet)
- Shared layer has no upward dependencies (COMPLIANT)

---

## Existing Code Patterns

### Riverpod State Management Pattern

The project uses hooks_riverpod 3.x with code generation:

```dart
// Pattern: @riverpod annotation with code generation
import 'package:riverpod_annotation/riverpod_annotation.dart';

part 'nickname_provider.g.dart';

@riverpod
class TemporaryNickname extends _$TemporaryNickname {
  @override
  String? build() {
    return null;
  }

  void setNickname(String nickname) {
    state = nickname;
  }
}
```

**Key Characteristics**:
- Use `@riverpod` annotation for providers
- Generate `.g.dart` files with build_runner
- Japanese documentation comments for public APIs
- Clear state initialization in `build()` method
- Descriptive method names (e.g., `setNickname`, `clearNickname`)

### go_router Routing Pattern

The project uses go_router 16.x with TypedGoRoute:

```dart
// Pattern: TypedGoRoute annotation for type-safe routing
@TypedGoRoute<NicknameRoute>(path: '/nickname')
class NicknameRoute extends GoRouteData with $NicknameRoute {
  const NicknameRoute();

  @override
  Widget build(BuildContext context, GoRouterState state) {
    return const PlaceholderNicknamePage();
  }
}
```

**Key Characteristics**:
- Use `@TypedGoRoute` annotation
- Generate `.g.dart` files with go_router_builder
- Type-safe navigation with `.go(context)`
- Route guards using redirect function
- Japanese documentation for route purposes

### Widget Structure Pattern

```dart
// Pattern: StatelessWidget with detailed documentation
/// ニックネーム入力画面のプレースホルダー
///
/// NOTE: これは一時的なプレースホルダー実装です
///
/// Issue #8 完了後に以下へ移行:
/// - lib/features/nickname/presentation/pages/nickname_page.dart
class PlaceholderNicknamePage extends ConsumerWidget {
  const PlaceholderNicknamePage({super.key});
  // ...
}
```

**Key Characteristics**:
- Prefer `ConsumerWidget` for Riverpod integration
- Use `const` constructors for performance
- Japanese documentation with migration notes
- Reference to GitHub issues for future work

### Constants Pattern

Current location: `lib/src/constants/`

```dart
// Pattern: Static class with const values and Japanese documentation
/// アプリケーション全体で使用するカラーパレットを定義する。
class AppColors {
  /// 純白色。
  /// 背景やコンテナの基本色として使用される。
  static const Color white = Color(0xFFFFFFFF);

  /// ユーザー用のプライマリカラー（明るい緑）。
  static const Color userPrimary = Color(0xFFB4EF03);
  // ...
}
```

**Key Characteristics**:
- Static classes with const values
- Japanese documentation for each constant
- Usage descriptions included
- Related constants grouped by category

### Test Pattern

```dart
// Pattern: Widget tests with descriptive test names
void main() {
  group('ErrorPage basic tests', () {
    testWidgets('Displays error icon', (WidgetTester tester) async {
      await tester.pumpWidget(
        const MaterialApp(home: ErrorPage(error: null)),
      );
      expect(find.byIcon(Icons.error_outline), findsOneWidget);
    });
    // ...
  });
}
```

**Key Characteristics**:
- Use `group()` for organizing related tests
- Descriptive test names in English
- Widget tests with MaterialApp wrapper
- Basic assertions using `expect()` and matchers

---

## Impact Analysis

### Files Requiring Import Updates

When moving `lib/src/constants/` to `lib/shared/constants/`, the following 6 files will need import updates:

1. `lib/shared/presentation/pages/error_page.dart`
   ```dart
   // Current
   import 'package:flutterhackthema/src/constants/app_colors.dart';
   import 'package:flutterhackthema/src/constants/app_text_styles.dart';

   // After migration
   import 'package:flutterhackthema/shared/constants/app_colors.dart';
   import 'package:flutterhackthema/shared/constants/app_text_styles.dart';
   ```

2. `lib/app/widgets/pages/placeholder_nickname_page.dart`
3. `lib/app/widgets/pages/placeholder_posts_page.dart`
4. `lib/app/widgets/pages/placeholder_create_post_page.dart`
5. `lib/app/widgets/pages/placeholder_preview_page.dart`
6. `docs/investigate/investigate_20251129_140127.md` (documentation only)

Additionally, `lib/src/constants/app_text_styles.dart` has a relative import:
```dart
// Current
import 'app_colors.dart';

// After migration (can remain relative or use absolute)
import 'app_colors.dart';  // or
import 'package:flutterhackthema/shared/constants/app_colors.dart';
```

### Placeholder Page Migration

All placeholder pages have clear migration instructions:

| Current Location | Target Location | Referenced Issue |
|-----------------|-----------------|------------------|
| `lib/app/widgets/pages/placeholder_nickname_page.dart` | `lib/features/nickname/presentation/pages/nickname_page.dart` | Issue #10 |
| `lib/app/widgets/pages/placeholder_posts_page.dart` | `lib/features/posts/presentation/pages/posts_page.dart` | Issue #12 |
| `lib/app/widgets/pages/placeholder_create_post_page.dart` | `lib/features/post_creation/presentation/pages/create_post_page.dart` | Issue #13 |
| `lib/app/widgets/pages/placeholder_preview_page.dart` | Feature TBD | Future issue |

**Note**: Issue #8 focuses on creating the directory structure. The actual migration of placeholder pages will happen in subsequent issues (#10, #12, #13).

### Test Impact

After creating the Feature structure, corresponding test directories will need to be created:

```
test/
├── features/
│   ├── nickname/
│   │   └── presentation/
│   │       └── pages/
│   ├── posts/
│   │   └── presentation/
│   │       └── pages/
│   └── post_creation/
│       └── presentation/
│           └── pages/
```

---

## Technology Stack Verification

### Dependencies Relevant to Issue #8

From `pubspec.yaml`:

**State Management**:
- `hooks_riverpod: ^3.0.3` - State management
- `riverpod_annotation: ^3.0.3` - Provider code generation
- `riverpod_generator: ^3.0.3` (dev) - Code generator

**Routing**:
- `go_router: ^16.2.4` - Declarative routing
- `go_router_builder: ^4.1.0` (dev) - Route code generation

**Code Generation**:
- `build_runner: ^2.6.0` (dev) - Code generation runner
- `freezed: ^3.2.3` (dev) - Immutable models
- `json_serializable: ^6.11.1` (dev) - JSON serialization

**Code Quality**:
- `very_good_analysis: ^10.0.0` (dev) - Strict static analysis
- `riverpod_lint: ^3.0.3` (dev) - Riverpod-specific linting

All dependencies are at appropriate versions for the project requirements.

---

## Risk Assessment

### Low Risk Items
- Creating new directory structure (non-breaking)
- Moving constants files (mechanical change with clear impact scope)
- Following established patterns

### Medium Risk Items
- Ensuring all imports are updated correctly after moving constants
- Potential for missing some relative imports

### Mitigation Strategies
1. Use IDE refactoring tools where possible
2. Run `fvm flutter analyze` after each change
3. Run `fvm flutter test` to verify no regressions
4. Use search tools to find all import statements
5. Update imports in logical groups (all constants imports together)

---

## Recommended Implementation Strategy

### Phase 1: Create Directory Structure
1. Create `lib/shared/` subdirectories:
   - `constants/`
   - `widgets/`
   - `models/`
   - `utilities/` (or `util/`)
   - `data/`
   - `error/`
   - `service/`

2. Create Feature module structures:
   ```
   lib/features/
   ├── nickname/
   │   ├── data/
   │   │   ├── models/
   │   │   └── repositories/
   │   ├── presentation/
   │   │   ├── providers/
   │   │   ├── pages/
   │   │   ├── widgets/
   │   │   └── state/
   │   └── service/
   ├── posts/
   │   ├── data/
   │   ├── presentation/
   │   └── service/
   └── post_creation/
       ├── data/
       ├── presentation/
       └── service/
   ```

3. Create corresponding test directories:
   ```
   test/
   ├── features/
   │   ├── nickname/
   │   ├── posts/
   │   └── post_creation/
   └── shared/
       ├── constants/
       ├── widgets/
       └── models/
   ```

### Phase 2: Move Constants Files
1. Move files from `lib/src/constants/` to `lib/shared/constants/`:
   - `app_colors.dart`
   - `app_gradients.dart`
   - `app_text_styles.dart`

2. Update imports in affected files (6 files total)

3. Remove empty `lib/src/` directory

### Phase 3: Validation
1. Run code generation: `fvm flutter pub run build_runner build --delete-conflicting-outputs`
2. Run static analysis: `fvm flutter analyze`
3. Run tests: `fvm flutter test`
4. Verify all imports are correct
5. Verify app builds and runs: `fvm flutter run`

### Phase 4: Documentation
1. Update CLAUDE.md if necessary
2. Create memory file documenting the new structure
3. Commit changes with proper Angular-style commit message

---

## Open Questions & Clarifications

1. **Utilities vs Util naming**: Should we use `utilities/` or `util/`?
   - **Recommendation**: Use `util/` for consistency with common Flutter conventions

2. **Feature-specific constants**: Where should feature-specific constants go?
   - **Recommendation**: Keep in feature directory (e.g., `features/nickname/constants/`)
   - Only truly shared constants go in `shared/constants/`

3. **Placeholder page handling**: Should we create `.gitkeep` files in empty Feature directories?
   - **Recommendation**: Yes, to ensure empty directories are tracked by Git

4. **Test directory structure**: Should we create test directories now or when tests are written?
   - **Recommendation**: Create the structure now to establish the pattern

---

## Success Criteria

The implementation will be considered successful when:

- [ ] All required directory structures are created
- [ ] Constants files are moved from `lib/src/constants/` to `lib/shared/constants/`
- [ ] All imports are updated and working
- [ ] `lib/src/` directory is removed
- [ ] `fvm flutter analyze` passes with zero errors
- [ ] `fvm flutter test` passes all tests (6/6)
- [ ] `fvm flutter run` builds and runs successfully
- [ ] Code follows three-layer architecture principles
- [ ] No Feature-to-Feature dependencies exist
- [ ] Documentation is updated

---

## Dependencies & Blockers

### Dependencies
- None - This is a foundational task

### Blockers
- None identified

### Related Issues
- Issue #10: Nickname feature implementation (depends on #8)
- Issue #12: Posts list feature implementation (depends on #8)
- Issue #13: Post creation feature implementation (depends on #8)

---

## Conclusion

Issue #8 is ready for implementation. The investigation confirms:

1. **Clear Requirements**: Directory structure requirements are well-defined
2. **No Blockers**: No technical blockers identified
3. **Low Risk**: Changes are mechanical and testable
4. **Established Patterns**: Clear patterns exist for Riverpod, go_router, and widget structure
5. **Good Foundation**: Existing code quality is high with passing tests and clean analysis

**Recommendation**: Proceed to PLAN phase to create detailed implementation steps.

---

## Appendix

### Commands Used During Investigation

```bash
# Branch creation
git checkout -b feature/project-structure-setup

# Directory exploration
ls -R lib/

# Dependency analysis
fvm flutter pub get
fvm flutter analyze

# Test execution
fvm flutter test

# Search for imports
grep -r "flutterhackthema/src/constants" lib/
```

### Referenced Files

Key files reviewed during investigation:
- `lib/src/constants/app_colors.dart` - 187 lines, comprehensive color palette
- `lib/src/constants/app_text_styles.dart` - 73 lines, Typography definitions
- `lib/src/constants/app_gradients.dart` - 111 lines, Gradient theme system
- `lib/app/app_router/routes.dart` - 94 lines, TypedGoRoute definitions
- `lib/app/app_router/app_router.dart` - 51 lines, Router configuration
- `lib/app/route_guard/nickname_guard.dart` - 45 lines, Authentication guard
- `lib/app/app_di/nickname_provider.dart` - 44 lines, Riverpod provider
- `lib/shared/presentation/pages/error_page.dart` - 109 lines, Error page component
- `test/shared/presentation/pages/error_page_simple_test.dart` - 47 lines, Widget tests
- `pubspec.yaml` - Dependencies configuration

---

**Investigation Completed**: 2025-11-29 16:07:50
**Next Step**: Create detailed PLAN document
**Branch**: `feature/project-structure-setup`
**Investigator**: Claude Code
