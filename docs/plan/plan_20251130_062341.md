# Implementation Plan: Gemini API Key Environment Variable Configuration

**Issue**: [#42 - Gemini API Keyの環境変数設定とVercel環境変数の更新](https://github.com/MoguMoguDesign/flutter--hackathon-thema/issues/42)
**Investigation**: `docs/investigate/investigate_20251130_061952.md`
**Date**: 2025-11-30
**Branch**: `feature/gemini-api-key-env-config`

---

## 1. Implementation Strategy

### 1.1 Selected Approach

**Strategy**: Build-time environment variable injection using `String.fromEnvironment`

**Rationale**:
- Flutter Web での `flutter_dotenv` はアセットバンドルが必要で、ビルド後の環境変数変更が困難
- `--dart-define` はビルド時にコンパイル定数として注入でき、Vercel との相性が良い
- 既存のコード構造を最小限の変更で対応可能
- セキュリティ面で API キーがソースコードに含まれない

### 1.2 Architecture Compliance

- **Layer**: Shared Layer (変更なし)
- **Dependency Direction**: 三層アーキテクチャに準拠 (App -> Feature -> Shared)
- **Provider Pattern**: 既存の `@riverpod` パターンを維持

---

## 2. Task Breakdown

### Priority 1: Security Fixes (Critical)

| # | Task | Priority | Est. Time |
|---|------|----------|-----------|
| 1.1 | `.gitignore` に環境変数ファイルを追加 | P0 | 5 min |
| 1.2 | `api_config.dart` のハードコード API キーを削除 | P0 | 10 min |

### Priority 2: Core Implementation

| # | Task | Priority | Est. Time |
|---|------|----------|-----------|
| 2.1 | `.env.example` テンプレートファイルを作成 | P1 | 5 min |
| 2.2 | `api_config.dart` を `String.fromEnvironment` に変更 | P1 | 15 min |
| 2.3 | API キー未設定時のエラーハンドリングを追加 | P1 | 20 min |
| 2.4 | Makefile にビルドコマンドを追加 | P1 | 10 min |

### Priority 3: Vercel Configuration

| # | Task | Priority | Est. Time |
|---|------|----------|-----------|
| 3.1 | `vercel.json` にビルドコマンドを追加 | P2 | 10 min |
| 3.2 | Vercel ダッシュボードで環境変数を設定 | P2 | 5 min |

### Priority 4: Documentation

| # | Task | Priority | Est. Time |
|---|------|----------|-----------|
| 4.1 | `README.md` に環境変数設定方法を追記 | P3 | 15 min |

### Priority 5: Testing

| # | Task | Priority | Est. Time |
|---|------|----------|-----------|
| 5.1 | `ApiConfig` のユニットテストを追加 | P1 | 20 min |
| 5.2 | `GeminiService` のエラーハンドリングテストを追加 | P1 | 20 min |
| 5.3 | 既存テストが通ることを確認 | P1 | 10 min |

---

## 3. File Change Plan

### 3.1 Files to Modify

| File | Layer | Action | Description |
|------|-------|--------|-------------|
| `.gitignore` | Root | Modify | 環境変数ファイルを除外に追加 |
| `lib/shared/constants/api_config.dart` | Shared | Modify | `String.fromEnvironment` を使用 |
| `lib/shared/service/gemini_service.dart` | Shared | Modify | API キー未設定時のエラーチェックを追加 |
| `lib/shared/data/repositories/image_generation_repository_web.dart` | Shared | Modify | API キー未設定時のエラーチェックを追加 |
| `Makefile` | Root | Modify | 環境変数付きビルドコマンドを追加 |
| `vercel.json` | Root | Modify | ビルドコマンドを追加 |
| `README.md` | Root | Modify | 環境変数設定方法を追記 |

### 3.2 Files to Create

| File | Layer | Description |
|------|-------|-------------|
| `.env.example` | Root | 環境変数のテンプレート |
| `test/shared/constants/api_config_test.dart` | Test | ApiConfig のユニットテスト |

### 3.3 Files to Delete

None

---

## 4. Detailed Implementation

### 4.1 `.gitignore` Changes

```gitignore
# Environment Variables
.env
.env.local
.env.*.local
```

### 4.2 `api_config.dart` Changes

```dart
/// API 設定
///
/// 環境変数から API キーを読み込む設定クラス。
/// ビルド時に --dart-define=GEMINI_API_KEY=xxx で注入する。
class ApiConfig {
  ApiConfig._();

  /// Gemini API キー
  ///
  /// ビルド時に --dart-define=GEMINI_API_KEY=xxx で注入する。
  /// 環境変数が設定されていない場合は空文字列を返す。
  static const String geminiApiKey = String.fromEnvironment(
    'GEMINI_API_KEY',
    defaultValue: '',
  );

  /// Gemini API キーが設定されているかをチェック
  ///
  /// Returns: API キーが設定されている場合は true
  static bool get hasGeminiApiKey => geminiApiKey.isNotEmpty;

  // ... other configurations remain unchanged
}
```

### 4.3 `.env.example` Content

```bash
# Gemini API Key
# Get your key from: https://aistudio.google.com/app/apikey
GEMINI_API_KEY=your_api_key_here
```

### 4.4 Makefile Changes

```makefile
# Environment variable file
ENV_FILE := .env

# Load environment variables if .env exists
ifneq (,$(wildcard $(ENV_FILE)))
    include $(ENV_FILE)
    export
endif

# Build with environment variables
build-web-env: ## Web用アプリをビルド（環境変数付き）
	fvm flutter build web --dart-define=GEMINI_API_KEY=$(GEMINI_API_KEY)

build-web-release-env: ## Web用リリースアプリをビルド（環境変数付き）
	fvm flutter build web --release --web-renderer canvaskit --dart-define=GEMINI_API_KEY=$(GEMINI_API_KEY)

run-env: ## 環境変数付きでアプリを起動
	fvm flutter run --dart-define=GEMINI_API_KEY=$(GEMINI_API_KEY)
```

### 4.5 `vercel.json` Changes

```json
{
  "buildCommand": "flutter/bin/flutter build web --release --web-renderer canvaskit --dart-define=GEMINI_API_KEY=$GEMINI_API_KEY",
  "outputDirectory": "build/web",
  "rewrites": [
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ],
  "headers": [
    {
      "source": "/assets/(.*)",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "public, max-age=31536000, immutable"
        }
      ]
    }
  ]
}
```

### 4.6 API Key Missing Error Handling

Add to `gemini_service.dart`:

```dart
/// 画像を生成する前に API キーの設定をチェックする
void _validateApiKey() {
  if (!ApiConfig.hasGeminiApiKey) {
    throw const ApiKeyMissingException(
      'GEMINI_API_KEY is not configured. '
      'Please set the environment variable.',
    );
  }
}
```

New exception class in `gemini_api_exception.dart`:

```dart
/// API キーが設定されていない場合の例外
class ApiKeyMissingException extends GeminiApiException {
  const ApiKeyMissingException([super.message]);
}
```

---

## 5. Test Strategy

### 5.1 Unit Tests

#### `test/shared/constants/api_config_test.dart`

```dart
void main() {
  group('ApiConfig', () {
    test('hasGeminiApiKey returns false when key is empty', () {
      // String.fromEnvironment returns empty string when not set
      // This test validates the logic
    });

    test('geminiBaseUrl is correctly configured', () {
      expect(
        ApiConfig.geminiBaseUrl,
        'https://generativelanguage.googleapis.com/v1beta',
      );
    });

    test('geminiImageModel is correctly configured', () {
      expect(ApiConfig.geminiImageModel, 'gemini-3-pro-image-preview');
    });
  });
}
```

#### `test/shared/service/gemini_service_test.dart` (Update)

```dart
group('API Key Validation', () {
  test('throws ApiKeyMissingException when API key is empty', () async {
    // Test that appropriate exception is thrown
  });
});
```

### 5.2 Coverage Requirements

- **Target**: 80% code coverage for modified files
- **Must Test**:
  - `ApiConfig.hasGeminiApiKey` behavior
  - `ApiKeyMissingException` handling in `GeminiService`
  - Error propagation to repository layer

### 5.3 Test Execution Commands

```bash
# Run all tests
fvm flutter test

# Run with coverage
fvm flutter test --coverage

# Run specific test file
fvm flutter test test/shared/constants/api_config_test.dart
```

---

## 6. Verification Checklist

### 6.1 Pre-Implementation

- [ ] Branch `feature/gemini-api-key-env-config` is created
- [ ] Investigation document is reviewed

### 6.2 Implementation

- [ ] `.gitignore` updated with `.env`, `.env.local`, `.env.*.local`
- [ ] `api_config.dart` updated to use `String.fromEnvironment`
- [ ] `ApiKeyMissingException` added to exceptions
- [ ] Error handling added to `GeminiService`
- [ ] Error handling added to `image_generation_repository_web.dart`
- [ ] `.env.example` created
- [ ] Makefile updated with env commands
- [ ] `vercel.json` updated with build command
- [ ] `README.md` updated with setup instructions

### 6.3 Testing

- [ ] New unit tests added for `ApiConfig`
- [ ] New unit tests added for `ApiKeyMissingException`
- [ ] Existing tests pass
- [ ] Coverage is acceptable

### 6.4 Quality Gates

- [ ] `fvm flutter analyze` passes
- [ ] `dart format --set-exit-if-changed .` passes
- [ ] `fvm flutter test` passes
- [ ] Code generation is up-to-date

### 6.5 Deployment

- [ ] Vercel environment variable `GEMINI_API_KEY` is set
- [ ] New API key is used: `AIzaSyAFX6Zx0_FoGTfnthtK_MP2mmxdRfxiV4s`
- [ ] Deployment is successful

---

## 7. Risk Analysis

| Risk | Level | Mitigation |
|------|-------|------------|
| API key already in Git history | HIGH | Rotate API key after deployment |
| Build failure on Vercel | MEDIUM | Test build locally first |
| Breaking existing functionality | MEDIUM | Comprehensive testing |
| Environment variable not set | LOW | Clear error messages and documentation |

---

## 8. Rollback Plan

If issues arise:
1. Revert to previous commit
2. Set hardcoded API key temporarily (for emergency only)
3. Investigate and fix the issue
4. Re-deploy with corrected implementation

---

## 9. Post-Implementation Tasks

1. **Rotate API Key**: The old API key has been exposed in Git history
2. **Monitor**: Check Vercel deployment logs for any issues
3. **Document**: Update team on new environment variable setup process

---

## 10. Conclusion

```
status: SUCCESS
next: IMPLEMENT
details: "Flutter implementation plan creation complete. Comprehensive coverage supported. Details recorded in plan_20251130_062341.md. Moving to implementation phase."
```

### Summary

- **Total Estimated Time**: ~2 hours
- **Files to Modify**: 7 files
- **Files to Create**: 2 files
- **New Tests**: 2 test files/groups
- **Risk Level**: Medium (mitigated by comprehensive testing)

### Next Steps

1. Run `/implement` to execute this plan
2. After implementation, run quality checks: `make implement-check`
3. Create PR using `/pr`
