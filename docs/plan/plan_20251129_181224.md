# Implementation Plan: Issue #10 - Nickname Input Screen

**Date**: 2025-11-29 18:12:24
**Branch**: feat/nickname
**Investigation Reference**: `docs/investigate/investigate_20251129_180730.md`
**Issue**: https://github.com/MoguMoguDesign/flutter--hackathon-thema/issues/10
**Priority**: High

---

## 1. Executive Summary

### 1.1 Goal
Complete the nickname input screen implementation with persistent storage and auto-redirect functionality.

### 1.2 Current State
- Basic UI exists in `lib/features/nickname/presentation/pages/nickname_page.dart`
- Temporary in-memory provider exists in `lib/app/app_di/nickname_provider.dart`
- Route guard exists but uses non-persistent state
- **Missing**: shared_preferences dependency, persistence layer, feature-level provider

### 1.3 Target State
- Complete three-layer architecture compliance
- Persistent nickname storage via shared_preferences
- Auto-redirect for returning users
- Comprehensive test coverage

---

## 2. Pre-Implementation Requirements

### 2.1 SDK Version Resolution (CRITICAL)

**Issue**: pubspec.yaml requires Dart SDK `>=3.9.0`, but FVM has Dart `3.8.1`

**Resolution**: Lower SDK constraint (faster, recommended for hackathon)

```yaml
# pubspec.yaml
environment:
  sdk: '>=3.8.0 <4.0.0'  # Changed from >=3.9.0
  flutter: '>=3.24.0'
```

### 2.2 Add shared_preferences Dependency

```yaml
# pubspec.yaml - add to dependencies
dependencies:
  shared_preferences: ^2.3.4
```

---

## 3. Implementation Strategy

### 3.1 Approach: Provider Migration with Persistence

**Phase 1**: Add infrastructure (dependency, repository)
**Phase 2**: Create feature-level provider
**Phase 3**: Migrate consumers to new provider
**Phase 4**: Update UI and remove temporary provider
**Phase 5**: Write tests

### 3.2 Architecture Compliance

Following the three-layer architecture (App -> Feature -> Shared):

```
lib/features/nickname/
├── data/
│   └── repositories/
│       └── nickname_repository.dart      [NEW]
│       └── nickname_repository.g.dart    [GENERATED]
├── presentation/
│   ├── pages/
│   │   └── nickname_page.dart            [MODIFY]
│   └── providers/
│       └── nickname_provider.dart        [NEW]
│       └── nickname_provider.g.dart      [GENERATED]
└── service/                              [OPTIONAL - skip for now]
```

---

## 4. File Change Plan

### 4.1 Files to Create

| File | Purpose | Layer |
|------|---------|-------|
| `lib/features/nickname/data/repositories/nickname_repository.dart` | SharedPreferences access | Feature/Data |
| `lib/features/nickname/presentation/providers/nickname_provider.dart` | Feature-level state management | Feature/Presentation |

### 4.2 Files to Modify

| File | Changes | Priority |
|------|---------|----------|
| `pubspec.yaml` | Add shared_preferences, lower SDK constraint | P0 |
| `lib/features/nickname/presentation/pages/nickname_page.dart` | Update provider import, change button text to "はじめる" | P1 |
| `lib/app/route_guard/nickname_guard.dart` | Update to use new feature-level provider | P1 |
| `lib/main.dart` | Add SharedPreferences initialization | P1 |

### 4.3 Files to Delete

| File | Reason | When |
|------|--------|------|
| `lib/app/app_di/nickname_provider.dart` | Replace with feature-level provider | After migration complete |
| `lib/app/app_di/nickname_provider.g.dart` | Generated file for deleted provider | After migration complete |

---

## 5. Detailed Implementation Tasks

### Task 1: Pre-Implementation Setup [P0]

**1.1** Modify `pubspec.yaml`
- Lower SDK constraint to `>=3.8.0 <4.0.0`
- Add `shared_preferences: ^2.3.4` dependency

**1.2** Run dependency installation
```bash
fvm flutter pub get
```

**1.3** Verify setup
```bash
fvm flutter analyze
```

---

### Task 2: Create Nickname Repository [P1]

**File**: `lib/features/nickname/data/repositories/nickname_repository.dart`

**Design**:
```dart
import 'package:riverpod_annotation/riverpod_annotation.dart';
import 'package:shared_preferences/shared_preferences.dart';

part 'nickname_repository.g.dart';

/// ニックネームの永続化を管理するリポジトリ
///
/// SharedPreferencesを使用してニックネームを保存・取得します。
@Riverpod(keepAlive: true)
NicknameRepository nicknameRepository(NicknameRepositoryRef ref) {
  return NicknameRepository();
}

/// ニックネームの永続化を管理するリポジトリ
class NicknameRepository {
  static const String _nicknameKey = 'nickname';

  /// 保存されているニックネームを取得
  ///
  /// ニックネームが保存されていない場合は null を返します。
  Future<String?> getNickname() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getString(_nicknameKey);
  }

  /// ニックネームを保存
  ///
  /// [nickname] 保存するニックネーム
  Future<bool> saveNickname(String nickname) async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.setString(_nicknameKey, nickname);
  }

  /// ニックネームを削除
  Future<bool> clearNickname() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.remove(_nicknameKey);
  }
}
```

---

### Task 3: Create Feature-Level Provider [P1]

**File**: `lib/features/nickname/presentation/providers/nickname_provider.dart`

**Design**:
```dart
import 'package:riverpod_annotation/riverpod_annotation.dart';

import '../../data/repositories/nickname_repository.dart';

part 'nickname_provider.g.dart';

/// ニックネームの状態を管理するプロバイダー
///
/// アプリ起動時に SharedPreferences からニックネームを読み込み、
/// 状態を管理します。
@Riverpod(keepAlive: true)
class NicknameNotifier extends _$NicknameNotifier {
  /// ニックネームの初期状態を構築
  ///
  /// SharedPreferences から保存されているニックネームを読み込みます。
  @override
  Future<String?> build() async {
    final repository = ref.read(nicknameRepositoryProvider);
    return repository.getNickname();
  }

  /// ニックネームを設定して永続化
  ///
  /// [nickname] 設定するニックネーム
  Future<void> setNickname(String nickname) async {
    final repository = ref.read(nicknameRepositoryProvider);
    await repository.saveNickname(nickname);
    state = AsyncData(nickname);
  }

  /// ニックネームをクリア
  Future<void> clearNickname() async {
    final repository = ref.read(nicknameRepositoryProvider);
    await repository.clearNickname();
    state = const AsyncData(null);
  }
}
```

---

### Task 4: Update NicknamePage [P1]

**File**: `lib/features/nickname/presentation/pages/nickname_page.dart`

**Changes**:
1. Update import to use feature-level provider
2. Change button text from "決定して次の行へ" to "はじめる"
3. Handle async state from provider
4. Add loading state handling

**Key Code Changes**:
```dart
// Update import
import '../providers/nickname_provider.dart';

// Update provider usage
ref.read(nicknameNotifierProvider.notifier).setNickname(
  nicknameController.text.trim(),
);

// Update button text
PrimaryButton(
  text: 'はじめる',
  onPressed: isValid.value
      ? () async {
          await ref
              .read(nicknameNotifierProvider.notifier)
              .setNickname(nicknameController.text.trim());
          if (context.mounted) {
            context.go('/posts');
          }
        }
      : null,
),
```

---

### Task 5: Update Route Guard [P1]

**File**: `lib/app/route_guard/nickname_guard.dart`

**Changes**:
1. Update import to use feature-level provider
2. Handle async state from new provider

**Key Code Changes**:
```dart
// Update import
import 'package:flutterhackthema/features/nickname/presentation/providers/nickname_provider.dart';

// Update guard logic to handle AsyncValue
String? nicknameGuard(
  BuildContext context,
  GoRouterState state,
  WidgetRef ref,
) {
  final nicknameAsync = ref.read(nicknameNotifierProvider);
  final String? nickname = nicknameAsync.valueOrNull;

  // Rest of guard logic remains the same
}
```

---

### Task 6: Remove Temporary Provider [P2]

**After migration verified**:
1. Delete `lib/app/app_di/nickname_provider.dart`
2. Delete `lib/app/app_di/nickname_provider.g.dart`

---

### Task 7: Code Generation [P1]

Run after creating new files:
```bash
fvm flutter pub run build_runner build --delete-conflicting-outputs
```

---

## 6. Test Strategy

### 6.1 Unit Tests

| Test File | Test Coverage |
|-----------|---------------|
| `test/features/nickname/data/repositories/nickname_repository_test.dart` | Repository CRUD operations |
| `test/features/nickname/presentation/providers/nickname_provider_test.dart` | Provider state transitions |

**Repository Test Example**:
```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:shared_preferences/shared_preferences.dart';

import 'package:flutterhackthema/features/nickname/data/repositories/nickname_repository.dart';

void main() {
  group('NicknameRepository', () {
    late NicknameRepository repository;

    setUp(() {
      SharedPreferences.setMockInitialValues({});
      repository = NicknameRepository();
    });

    test('getNickname returns null when no nickname saved', () async {
      final nickname = await repository.getNickname();
      expect(nickname, isNull);
    });

    test('saveNickname stores nickname correctly', () async {
      await repository.saveNickname('TestUser');
      final nickname = await repository.getNickname();
      expect(nickname, equals('TestUser'));
    });

    test('clearNickname removes stored nickname', () async {
      await repository.saveNickname('TestUser');
      await repository.clearNickname();
      final nickname = await repository.getNickname();
      expect(nickname, isNull);
    });
  });
}
```

**Provider Test Example**:
```dart
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:shared_preferences/shared_preferences.dart';

import 'package:flutterhackthema/features/nickname/presentation/providers/nickname_provider.dart';

void main() {
  group('NicknameNotifier', () {
    setUp(() {
      SharedPreferences.setMockInitialValues({});
    });

    test('initial state returns null when no nickname saved', () async {
      final container = ProviderContainer();
      addTearDown(container.dispose);

      final nickname = await container.read(nicknameNotifierProvider.future);
      expect(nickname, isNull);
    });

    test('setNickname updates state and persists', () async {
      final container = ProviderContainer();
      addTearDown(container.dispose);

      await container
          .read(nicknameNotifierProvider.notifier)
          .setNickname('TestUser');

      final nickname = await container.read(nicknameNotifierProvider.future);
      expect(nickname, equals('TestUser'));
    });
  });
}
```

### 6.2 Widget Tests

| Test File | Test Coverage |
|-----------|---------------|
| `test/features/nickname/presentation/pages/nickname_page_test.dart` | UI rendering, user interaction, validation |

**Widget Test Example**:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:shared_preferences/shared_preferences.dart';

import 'package:flutterhackthema/features/nickname/presentation/pages/nickname_page.dart';
import 'package:flutterhackthema/shared/presentation/widgets/inputs/app_text_field.dart';
import 'package:flutterhackthema/shared/presentation/widgets/buttons/primary_button.dart';

void main() {
  group('NicknamePage Widget Tests', () {
    setUp(() {
      SharedPreferences.setMockInitialValues({});
    });

    testWidgets('displays nickname input field', (WidgetTester tester) async {
      await tester.pumpWidget(
        const ProviderScope(
          child: MaterialApp(home: NicknamePage()),
        ),
      );
      await tester.pumpAndSettle();

      expect(find.byType(AppTextField), findsOneWidget);
    });

    testWidgets('displays start button', (WidgetTester tester) async {
      await tester.pumpWidget(
        const ProviderScope(
          child: MaterialApp(home: NicknamePage()),
        ),
      );
      await tester.pumpAndSettle();

      expect(find.text('はじめる'), findsOneWidget);
    });

    testWidgets('button is disabled when input is empty', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(
        const ProviderScope(
          child: MaterialApp(home: NicknamePage()),
        ),
      );
      await tester.pumpAndSettle();

      final button = tester.widget<ElevatedButton>(
        find.byType(ElevatedButton),
      );
      expect(button.onPressed, isNull);
    });

    testWidgets('button is enabled when valid input', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(
        const ProviderScope(
          child: MaterialApp(home: NicknamePage()),
        ),
      );
      await tester.pumpAndSettle();

      await tester.enterText(find.byType(TextField), 'TestUser');
      await tester.pump();

      final button = tester.widget<ElevatedButton>(
        find.byType(ElevatedButton),
      );
      expect(button.onPressed, isNotNull);
    });

    testWidgets('validates max length 20 characters', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(
        const ProviderScope(
          child: MaterialApp(home: NicknamePage()),
        ),
      );
      await tester.pumpAndSettle();

      // Enter 21 characters - should be truncated to 20
      await tester.enterText(
        find.byType(TextField),
        '123456789012345678901',
      );
      await tester.pump();

      final textField = tester.widget<TextField>(find.byType(TextField));
      expect(textField.controller?.text.length, lessThanOrEqualTo(20));
    });
  });
}
```

### 6.3 Test Directory Structure

```
test/
└── features/
    └── nickname/
        ├── data/
        │   └── repositories/
        │       └── nickname_repository_test.dart
        └── presentation/
            ├── pages/
            │   └── nickname_page_test.dart
            └── providers/
                └── nickname_provider_test.dart
```

---

## 7. Implementation Order (Execution Checklist)

### Phase 1: Setup (P0)
- [ ] 1.1 Modify pubspec.yaml (SDK constraint + shared_preferences)
- [ ] 1.2 Run `fvm flutter pub get`
- [ ] 1.3 Verify `fvm flutter analyze` passes

### Phase 2: Data Layer (P1)
- [ ] 2.1 Create `lib/features/nickname/data/repositories/` directory
- [ ] 2.2 Create `nickname_repository.dart`
- [ ] 2.3 Run code generation

### Phase 3: Presentation Layer (P1)
- [ ] 3.1 Create `lib/features/nickname/presentation/providers/` directory
- [ ] 3.2 Create `nickname_provider.dart`
- [ ] 3.3 Run code generation

### Phase 4: Integration (P1)
- [ ] 4.1 Update `nickname_page.dart` (import, button text, async handling)
- [ ] 4.2 Update `nickname_guard.dart` (import, async handling)
- [ ] 4.3 Verify routing and guard functionality

### Phase 5: Cleanup (P2)
- [ ] 5.1 Delete `lib/app/app_di/nickname_provider.dart`
- [ ] 5.2 Delete `lib/app/app_di/nickname_provider.g.dart`

### Phase 6: Testing (P1)
- [ ] 6.1 Create repository test file
- [ ] 6.2 Create provider test file
- [ ] 6.3 Create widget test file
- [ ] 6.4 Run all tests: `fvm flutter test`

### Phase 7: Verification (P0)
- [ ] 7.1 Run `fvm flutter analyze`
- [ ] 7.2 Run `dart format --set-exit-if-changed .`
- [ ] 7.3 Run `fvm flutter test`
- [ ] 7.4 Manual testing: fresh install -> nickname -> posts -> app restart -> auto-redirect

---

## 8. Risk Analysis and Mitigation

| Risk | Severity | Likelihood | Mitigation |
|------|----------|------------|------------|
| SDK version incompatibility | High | Confirmed | Lower SDK constraint to >=3.8.0 |
| Provider migration breaks routing | Medium | Low | Test guard thoroughly before removing old provider |
| Async initialization race condition | Medium | Medium | Use AsyncValue pattern properly |
| SharedPreferences unavailable | Low | Very Low | Handle exceptions gracefully |
| Test flakiness with SharedPreferences | Medium | Medium | Use setMockInitialValues consistently |

---

## 9. Acceptance Criteria

### Functional Requirements
- [ ] User can enter nickname (1-20 characters)
- [ ] Empty string is rejected
- [ ] Nickname is saved to SharedPreferences
- [ ] User is redirected to posts page after saving
- [ ] Returning user is auto-redirected to posts page
- [ ] Button displays "はじめる"

### Technical Requirements
- [ ] Three-layer architecture compliance (Feature layer)
- [ ] Riverpod @riverpod annotation pattern
- [ ] No Feature-to-Feature dependencies
- [ ] All code passes `fvm flutter analyze`
- [ ] All code formatted with `dart format`
- [ ] All tests pass
- [ ] Public APIs documented in Japanese

### Test Coverage Requirements
- [ ] Unit tests for NicknameRepository
- [ ] Unit tests for NicknameNotifier
- [ ] Widget tests for NicknamePage

---

## 10. Quality Gates

Before completing implementation:

1. `fvm flutter analyze` - Zero errors
2. `dart format --set-exit-if-changed .` - Properly formatted
3. `fvm flutter test` - All tests passing
4. `fvm flutter pub run build_runner build --delete-conflicting-outputs` - Generation complete
5. Architecture compliance verified
6. Public APIs documented in Japanese

---

## 11. Output

```
status: SUCCESS
next: IMPLEMENT
details: "Flutter implementation plan creation complete. Comprehensive test coverage supported. Details recorded in plan_20251129_181224.md. Moving to implementation phase."
```
