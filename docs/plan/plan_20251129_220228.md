# PLAN Phase Report: 10文字制限実装

## Plan Metadata

- Date: 2025-11-29 22:02:28
- Branch: feature/haiku-creation
- Previous Phase: INVESTIGATE
- Investigation Report: docs/investigate/investigate_20251129_213048.md
- Planner: Claude Code
- Phase: PLAN

---

## Executive Summary

**Objective**: 俳句入力画面（HaikuInputPage）に**各行10文字制限**を実装する

**Scope**:
- 既存実装への軽微な修正（1ファイル）
- 包括的なテストスイート作成（3ファイル新規）
- 品質ゲート準拠

**Complexity**: Low（シンプルな機能追加）

**Estimated Effort**: Small
- Implementation: 30分
- Testing: 1-2時間
- Total: 2-3時間

**Risk Level**: Very Low

---

## Requirements Analysis

### User Request

> "全体的には良いが、10文字制限実装の詳細設計でお願いします。"

### Interpretation

- ✅ 既存実装は良好（調査フェーズで確認済み）
- ✅ 新規要件: **各行10文字以内**の制限を追加
- ✅ 3ステップ全て（上の句、真ん中の行、下の句）に適用

### Updated Requirements

| Requirement | Status | Details |
|-------------|--------|---------|
| 各行の最大文字数 | ⚠️ 新規 | 10文字以内 |
| 空文字禁止 | ✅ 実装済 | 既存実装で対応済み |
| 入力フォーム | ✅ 実装済 | 3ステップ形式 |
| バリデーション表示 | ✅ 実装済 | ボタンの有効/無効で表現 |
| 縦書きプレビュー | ✅ 実装済 | リアルタイム表示 |

---

## Implementation Strategy

### Approach: Minimal Change with Maximum Test Coverage

**Philosophy**:
- 既存の優れた実装を維持
- 最小限の変更で10文字制限を追加
- 包括的なテストで品質保証

### Key Decision

**Option Selected**: AppTextFieldの`maxLength`パラメータを使用

**Rationale**:
- ✅ 既にAppTextFieldは`maxLength`をサポート
- ✅ Flutterネイティブの文字数制限機能
- ✅ ユーザーフレンドリー（入力時に自動で制限）
- ✅ 追加のバリデーションロジック不要
- ✅ アクセシビリティ対応済み

**Alternative Considered**: 手動バリデーション
- ❌ より複雑
- ❌ エラーハンドリングが必要
- ❌ ユーザーエクスペリエンスが劣る

---

## Detailed Design

### 1. Code Modification

#### File: `lib/features/haiku/presentation/pages/haiku_input_page.dart`

**Location**: Line 129-135 (AppTextField widget)

**Current Code**:
```dart
AppTextField(
  controller: inputController,
  label: _stepLabels[currentStep.value],
  hintText: _stepHints[currentStep.value],
  autofocus: true,
)
```

**Modified Code**:
```dart
AppTextField(
  controller: inputController,
  label: _stepLabels[currentStep.value],
  hintText: _stepHints[currentStep.value],
  autofocus: true,
  maxLength: 10,  // ← Add this line
)
```

**Change Summary**:
- **Lines Changed**: 1 line added
- **Impact**: Low
- **Backwards Compatible**: Yes
- **Breaking Change**: No

### 2. Validation Logic (Optional Enhancement)

**Current Validation** (Line 32-33):
```dart
void listener() {
  isValid.value = inputController.text.trim().isNotEmpty;
}
```

**Recommended Enhancement**:
```dart
void listener() {
  final text = inputController.text.trim();
  isValid.value = text.isNotEmpty && text.length <= 10;
}
```

**Rationale**:
- Defense in depth
- Explicit validation in code
- Better for testing
- No UX impact (TextField already enforces limit)

### 3. Visual Feedback

**TextField Behavior with maxLength**:
- Flutter automatically shows character counter
- Counter format: "10/10" when at limit
- Prevents typing beyond limit
- No manual implementation needed

**Expected UI**:
```
[ラベル: 上の句]
┌─────────────────────────┐
│ あいうえおかきくけこ     │  10/10
└─────────────────────────┘
```

---

## Architecture Compliance

### Three-Layer Architecture

#### ✅ App Layer
- No changes required
- Routing unchanged

#### ✅ Feature Layer
- **Modified**: `lib/features/haiku/presentation/pages/haiku_input_page.dart`
- **Impact**: Presentation layer only
- **Dependencies**: Uses existing Shared layer components

#### ✅ Shared Layer
- No changes required
- AppTextField already supports maxLength

### Dependency Direction

```
App Layer
    ↓ (no change)
Feature Layer (haiku)
    ├── presentation/pages/haiku_input_page.dart  [MODIFIED]
    └── presentation/widgets/...                  [UNCHANGED]
    ↓ (using)
Shared Layer
    └── presentation/widgets/inputs/app_text_field.dart  [UNCHANGED]
```

**Analysis**: ✅ Compliant with architecture constraints

---

## File Change Plan

### Files to Modify

| File | Type | Lines Changed | Risk | Reason |
|------|------|---------------|------|--------|
| `lib/features/haiku/presentation/pages/haiku_input_page.dart` | MODIFY | +1-2 lines | Very Low | Add maxLength parameter |

### Files to Create (Tests)

| File | Type | Lines | Purpose |
|------|------|-------|---------|
| `test/features/haiku/presentation/pages/haiku_input_page_test.dart` | NEW | ~200 | Widget tests for HaikuInputPage |
| `test/features/haiku/presentation/widgets/haiku_preview_test.dart` | NEW | ~100 | Widget tests for HaikuPreview |
| `test/features/haiku/presentation/widgets/step_indicator_test.dart` | NEW | ~80 | Widget tests for StepIndicator |

### Files Unchanged

- `lib/shared/presentation/widgets/inputs/app_text_field.dart` - Already supports maxLength
- `lib/app/app_router/routes.dart` - No routing changes
- All other haiku feature files

---

## Comprehensive Test Strategy

### Test Coverage Goals

- **Target**: 100% line coverage for modified code
- **Minimum**: 90% overall coverage for haiku feature
- **Focus**: Critical user paths and edge cases

### Test Pyramid

```
        ┌─────────────┐
        │  E2E Tests  │  (Optional - 1 test)
        │   (Manual)  │
        └─────────────┘
             ↑
      ┌──────────────────┐
      │  Widget Tests    │  (Primary - ~25 tests)
      │  (flutter_test)  │
      └──────────────────┘
             ↑
      ┌──────────────────┐
      │  Unit Tests      │  (Supporting - ~10 tests)
      │   (mockito)      │
      └──────────────────┘
```

### 1. Unit Tests (Validation Logic)

**File**: `test/features/haiku/presentation/pages/haiku_input_page_test.dart`

**Test Cases** (10 tests):

```dart
group('Validation logic', () {
  test('Empty text is invalid', () {
    // Assert isValid = false
  });

  test('Non-empty text <=10 chars is valid', () {
    // Assert isValid = true
  });

  test('Text exactly 10 chars is valid', () {
    // Assert isValid = true for "あいうえおかきくけこ"
  });

  test('Text >10 chars is invalid', () {
    // This should not happen with TextField limit
    // But test the validation logic directly
  });

  test('Whitespace-only text is invalid', () {
    // Assert trim() behavior
  });

  test('Text with leading/trailing spaces is validated correctly', () {
    // Test trim() behavior
  });

  test('Japanese characters count correctly', () {
    // 1 hiragana = 1 character
  });

  test('Mixed ASCII and Japanese count correctly', () {
    // Verify character counting
  });

  test('Emoji count correctly', () {
    // 1 emoji = varies, test behavior
  });

  test('Newlines are handled correctly', () {
    // Should be trimmed or prevented
  });
});
```

### 2. Widget Tests - HaikuInputPage (15 tests)

**File**: `test/features/haiku/presentation/pages/haiku_input_page_test.dart`

**Test Categories**:

#### A. Rendering Tests (5 tests)

```dart
group('HaikuInputPage rendering', () {
  testWidgets('Displays step indicator', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));
    expect(find.byType(StepIndicator), findsOneWidget);
  });

  testWidgets('Displays haiku preview', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));
    expect(find.byType(HaikuPreview), findsOneWidget);
  });

  testWidgets('Displays input field with correct label for step 0', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));
    expect(find.text('上の句'), findsOneWidget);
  });

  testWidgets('Displays back button', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));
    expect(find.byType(AppBackButton), findsOneWidget);
  });

  testWidgets('Displays submit button', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));
    expect(find.byType(AppFilledButton), findsOneWidget);
  });
});
```

#### B. 10-Character Limit Tests (3 tests) ⭐ **NEW**

```dart
group('10-character limit enforcement', () {
  testWidgets('TextField accepts exactly 10 characters', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));

    final textField = find.byType(AppTextField);
    await tester.enterText(textField, 'あいうえおかきくけこ'); // 10 chars
    await tester.pump();

    final textFieldWidget = tester.widget<TextField>(
      find.descendant(
        of: textField,
        matching: find.byType(TextField),
      ),
    );

    expect(textFieldWidget.controller?.text, 'あいうえおかきくけこ');
    expect(textFieldWidget.controller?.text.length, 10);
  });

  testWidgets('TextField prevents input beyond 10 characters', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));

    final textField = find.byType(AppTextField);

    // Try to enter 11 characters
    await tester.enterText(textField, 'あいうえおかきくけこさ'); // 11 chars
    await tester.pump();

    final textFieldWidget = tester.widget<TextField>(
      find.descendant(
        of: textField,
        matching: find.byType(TextField),
      ),
    );

    // Should only have 10 characters
    expect(textFieldWidget.controller?.text.length, lessThanOrEqualTo(10));
  });

  testWidgets('Character counter shows correctly at limit', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));

    final textField = find.byType(AppTextField);
    await tester.enterText(textField, 'あいうえおかき'); // 7 chars
    await tester.pump();

    // Flutter automatically shows "7/10" counter
    expect(find.text('7/10'), findsOneWidget);
  });
});
```

#### C. Step Navigation Tests (4 tests)

```dart
group('Step navigation', () {
  testWidgets('Starts at step 0 (上の句)', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));
    expect(find.text('上の句を入力'), findsOneWidget);
  });

  testWidgets('Advances to step 1 after first input', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));

    await tester.enterText(find.byType(AppTextField), '古池や');
    await tester.tap(find.byType(AppFilledButton));
    await tester.pumpAndSettle();

    expect(find.text('真ん中の行を入力'), findsOneWidget);
  });

  testWidgets('Advances to step 2 after second input', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));

    // Step 0 → 1
    await tester.enterText(find.byType(AppTextField), '古池や');
    await tester.tap(find.byType(AppFilledButton));
    await tester.pumpAndSettle();

    // Step 1 → 2
    await tester.enterText(find.byType(AppTextField), '蛙飛込');
    await tester.tap(find.byType(AppFilledButton));
    await tester.pumpAndSettle();

    expect(find.text('下の句を入力'), findsOneWidget);
  });

  testWidgets('Input field clears after advancing steps', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));

    await tester.enterText(find.byType(AppTextField), '古池や');
    await tester.tap(find.byType(AppFilledButton));
    await tester.pumpAndSettle();

    final textFieldWidget = tester.widget<TextField>(find.byType(TextField));
    expect(textFieldWidget.controller?.text, isEmpty);
  });
});
```

#### D. Validation Tests (3 tests)

```dart
group('Input validation', () {
  testWidgets('Button disabled with empty input', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));

    final button = tester.widget<AppFilledButton>(find.byType(AppFilledButton));
    expect(button.onPressed, isNull);
  });

  testWidgets('Button enabled with valid input', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));

    await tester.enterText(find.byType(AppTextField), '古池や');
    await tester.pump();

    final button = tester.widget<AppFilledButton>(find.byType(AppFilledButton));
    expect(button.onPressed, isNotNull);
  });

  testWidgets('Button disabled with whitespace-only input', (tester) async {
    await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));

    await tester.enterText(find.byType(AppTextField), '   ');
    await tester.pump();

    final button = tester.widget<AppFilledButton>(find.byType(AppFilledButton));
    expect(button.onPressed, isNull);
  });
});
```

### 3. Widget Tests - HaikuPreview (5 tests)

**File**: `test/features/haiku/presentation/widgets/haiku_preview_test.dart`

```dart
group('HaikuPreview widget', () {
  testWidgets('Displays placeholder when all lines empty', (tester) async {
    await tester.pumpWidget(
      const MaterialApp(
        home: Scaffold(
          body: HaikuPreview(
            firstLine: '',
            secondLine: '',
            thirdLine: '',
          ),
        ),
      ),
    );

    expect(find.text('俳句がここに\n表示されます'), findsOneWidget);
  });

  testWidgets('Displays first line only when provided', (tester) async {
    await tester.pumpWidget(
      const MaterialApp(
        home: Scaffold(
          body: HaikuPreview(
            firstLine: '古池や',
            secondLine: '',
            thirdLine: '',
          ),
        ),
      ),
    );

    expect(find.byType(_VerticalText), findsOneWidget);
  });

  testWidgets('Displays all three lines when provided', (tester) async {
    await tester.pumpWidget(
      const MaterialApp(
        home: Scaffold(
          body: HaikuPreview(
            firstLine: '古池や',
            secondLine: '蛙飛込',
            thirdLine: '水の音',
          ),
        ),
      ),
    );

    expect(find.byType(_VerticalText), findsNWidgets(3));
  });

  testWidgets('Vertical text renders correctly', (tester) async {
    await tester.pumpWidget(
      const MaterialApp(
        home: Scaffold(
          body: HaikuPreview(
            firstLine: 'abc',
            secondLine: '',
            thirdLine: '',
          ),
        ),
      ),
    );

    // Each character should be in separate Text widget
    expect(find.text('a'), findsOneWidget);
    expect(find.text('b'), findsOneWidget);
    expect(find.text('c'), findsOneWidget);
  });

  testWidgets('Lines arranged right-to-left', (tester) async {
    // Test visual layout
    // Verify thirdLine is leftmost, firstLine is rightmost
  });
});
```

### 4. Widget Tests - StepIndicator (5 tests)

**File**: `test/features/haiku/presentation/widgets/step_indicator_test.dart`

```dart
group('StepIndicator widget', () {
  testWidgets('Shows 3 steps by default', (tester) async {
    await tester.pumpWidget(
      const MaterialApp(
        home: Scaffold(
          body: StepIndicator(currentStep: 0),
        ),
      ),
    );

    final containers = tester.widgetList<Container>(
      find.descendant(
        of: find.byType(StepIndicator),
        matching: find.byType(Container),
      ),
    );

    // Should have 3 circle containers
    expect(containers.where((c) =>
      (c.decoration as BoxDecoration?)?.shape == BoxShape.circle
    ).length, 3);
  });

  testWidgets('Current step is larger and filled', (tester) async {
    await tester.pumpWidget(
      const MaterialApp(
        home: Scaffold(
          body: StepIndicator(currentStep: 0),
        ),
      ),
    );

    // First step should be 16x16 (active)
    // Others should be 12x12 (inactive)
  });

  testWidgets('Completed steps are filled', (tester) async {
    await tester.pumpWidget(
      const MaterialApp(
        home: Scaffold(
          body: StepIndicator(currentStep: 2),
        ),
      ),
    );

    // Steps 0 and 1 should be filled (completed)
    // Step 2 should be filled (current)
  });

  testWidgets('Lines between steps show progress', (tester) async {
    await tester.pumpWidget(
      const MaterialApp(
        home: Scaffold(
          body: StepIndicator(currentStep: 1),
        ),
      ),
    );

    // Line after step 0 should be filled (completed)
    // Line after step 1 should be unfilled (not completed)
  });

  testWidgets('Label "手順" is displayed', (tester) async {
    await tester.pumpWidget(
      const MaterialApp(
        home: Scaffold(
          body: StepIndicator(currentStep: 0),
        ),
      ),
    );

    expect(find.text('手順'), findsOneWidget);
  });
});
```

### Test Execution Strategy

#### Development Phase
```bash
# Watch mode during development
fvm flutter test --watch test/features/haiku/
```

#### Pre-Commit
```bash
# Run all haiku tests
fvm flutter test test/features/haiku/

# Verify coverage
fvm flutter test --coverage test/features/haiku/
genhtml coverage/lcov.info -o coverage/html
open coverage/html/index.html
```

#### CI/CD
```bash
# Full test suite
fvm flutter test

# Coverage report
fvm flutter test --coverage
```

---

## Tech Stack Compatibility

### Dependencies Required

| Package | Version | Usage | Status |
|---------|---------|-------|--------|
| flutter_test | SDK | Widget testing | ✅ Available |
| flutter_hooks | ^0.21.2 | State management | ✅ Installed |
| mockito | ^5.5.0 | Mocking (optional) | ✅ Installed |

### Code Generation

**Not Required** - This implementation does not use:
- ❌ Riverpod providers (@riverpod)
- ❌ Freezed models (@freezed)
- ❌ JSON serialization

**Rationale**: Maintaining existing flutter_hooks pattern

### Static Analysis

**Linters**:
- very_good_analysis ^10.0.0 ✅
- flutter_lints ^6.0.0 ✅
- riverpod_lint ^3.0.3 (not applicable)

**Compliance Check**:
```bash
fvm flutter analyze
```

Expected: **0 issues**

---

## Risk Analysis and Mitigation

### Risk Matrix

| Risk | Probability | Impact | Severity | Mitigation |
|------|------------|--------|----------|------------|
| Breaking existing functionality | Very Low | High | Low | Comprehensive tests |
| TextField counter UI clash | Low | Low | Very Low | Test visual appearance |
| Character counting edge cases | Low | Medium | Low | Edge case tests (emoji, etc.) |
| Test flakiness | Low | Low | Very Low | Use `pumpAndSettle()` |
| Incomplete test coverage | Medium | Medium | Low | Code coverage reports |

### Detailed Risk Assessment

#### Risk 1: Breaking Existing Functionality
**Probability**: Very Low
**Impact**: High
**Mitigation**:
- Only adding one parameter
- No logic changes to existing code
- AppTextField already supports maxLength
- Comprehensive regression tests

#### Risk 2: UI/UX Changes
**Probability**: Low
**Impact**: Low
**Mitigation**:
- Flutter's default counter is non-intrusive
- Can be styled/hidden if needed
- Visual testing in dev environment

#### Risk 3: Character Counting Edge Cases
**Probability**: Low
**Impact**: Medium
**Scenarios**:
- Emoji (may count as 2+ characters)
- Combining characters
- Zero-width joiners
**Mitigation**:
- Test with various character types
- Document behavior
- Flutter's TextField handles this natively

#### Risk 4: Test Maintenance
**Probability**: Medium
**Impact**: Low
**Mitigation**:
- Well-structured test code
- Clear test names
- Test utilities for common setups
- Regular test review

---

## Implementation Task Breakdown

### Phase 1: Code Modification (15 minutes)

#### Task 1.1: Update HaikuInputPage
**File**: `lib/features/haiku/presentation/pages/haiku_input_page.dart`
**Action**: Add `maxLength: 10` parameter
**Lines**: 1 line
**Difficulty**: Trivial

**Steps**:
1. Open file
2. Locate AppTextField widget (line ~130)
3. Add `maxLength: 10,` parameter
4. Save file

#### Task 1.2: Enhance Validation (Optional)
**File**: Same as above
**Action**: Update validation logic
**Lines**: 1 line
**Difficulty**: Trivial

**Steps**:
1. Locate listener function (line ~32)
2. Update validation to include length check
3. Save file

#### Task 1.3: Format Code
**Command**:
```bash
dart format lib/features/haiku/presentation/pages/haiku_input_page.dart
```

### Phase 2: Test Creation (60-90 minutes)

#### Task 2.1: Create HaikuInputPage Tests
**File**: `test/features/haiku/presentation/pages/haiku_input_page_test.dart`
**Lines**: ~200
**Time**: 30-40 minutes

**Structure**:
```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:flutter/material.dart';
import 'package:flutterhackthema/features/haiku/presentation/pages/haiku_input_page.dart';

void main() {
  group('Validation logic', () { /* 10 tests */ });
  group('HaikuInputPage rendering', () { /* 5 tests */ });
  group('10-character limit enforcement', () { /* 3 tests */ });
  group('Step navigation', () { /* 4 tests */ });
  group('Input validation', () { /* 3 tests */ });
}
```

#### Task 2.2: Create HaikuPreview Tests
**File**: `test/features/haiku/presentation/widgets/haiku_preview_test.dart`
**Lines**: ~100
**Time**: 15-20 minutes

#### Task 2.3: Create StepIndicator Tests
**File**: `test/features/haiku/presentation/widgets/step_indicator_test.dart`
**Lines**: ~80
**Time**: 15-20 minutes

### Phase 3: Quality Gates (15 minutes)

#### Task 3.1: Static Analysis
```bash
fvm flutter analyze
```
**Expected**: 0 issues

#### Task 3.2: Code Formatting
```bash
dart format --set-exit-if-changed .
```
**Expected**: All files formatted

#### Task 3.3: Test Execution
```bash
fvm flutter test test/features/haiku/
```
**Expected**: All tests passing

#### Task 3.4: Coverage Report
```bash
fvm flutter test --coverage test/features/haiku/
```
**Expected**: >90% coverage

### Phase 4: Documentation (10 minutes)

#### Task 4.1: Update Comments
- Verify Japanese documentation comments
- Add comment explaining 10-char limit

#### Task 4.2: Update IMPLEMENT Document
- Create `docs/implement/implement_{TIMESTAMP}.md`
- Document changes made
- Record test results

---

## Success Criteria

### Code Quality

- ✅ Zero `flutter analyze` errors
- ✅ Code properly formatted with `dart format`
- ✅ Follows STYLE_GUIDE.md conventions
- ✅ Japanese documentation comments complete

### Functionality

- ✅ TextField accepts up to 10 characters
- ✅ TextField prevents input beyond 10 characters
- ✅ Character counter displays correctly
- ✅ All 3 steps enforce 10-char limit
- ✅ Existing functionality unchanged
- ✅ Validation logic works correctly

### Testing

- ✅ All unit tests pass (10/10)
- ✅ All widget tests pass (25/25)
- ✅ Test coverage ≥90% for modified code
- ✅ No flaky tests
- ✅ Tests execute in <30 seconds

### Architecture

- ✅ Three-layer architecture maintained
- ✅ Dependency rules followed (Feature → Shared)
- ✅ No new dependencies added
- ✅ Code generation not required

---

## Rollback Plan

### If Issues Arise

**Simple Rollback**:
```bash
git checkout lib/features/haiku/presentation/pages/haiku_input_page.dart
```

**Complete Rollback**:
```bash
git reset --hard HEAD~1
```

**Risk**: Very Low
- Changes are minimal
- No database migrations
- No API changes
- Isolated to single feature

---

## Post-Implementation Validation

### Manual Testing Checklist

- [ ] Open HaikuInputPage
- [ ] Enter 10 characters in step 1
- [ ] Verify cannot enter 11th character
- [ ] Verify character counter shows "10/10"
- [ ] Submit and move to step 2
- [ ] Repeat for step 2
- [ ] Repeat for step 3
- [ ] Verify vertical preview displays correctly
- [ ] Complete flow and navigate to GeneratingPage
- [ ] Verify haiku data passed correctly

### Automated Testing

```bash
# Run tests
fvm flutter test test/features/haiku/

# Expected output:
# ✓ 35 tests passed (0 failed, 0 skipped)
```

### Static Analysis

```bash
# Analyze code
fvm flutter analyze

# Expected output:
# No issues found!
```

---

## Next Phase: IMPLEMENT

### Transition Checklist

- ✅ Plan documented and approved
- ✅ Architecture verified
- ✅ Test strategy defined
- ✅ Tasks broken down
- ✅ Risks identified
- ✅ Success criteria established

### Entry Criteria for IMPLEMENT Phase

1. ✅ This plan document reviewed
2. ✅ Branch `feature/haiku-creation` exists
3. ✅ Development environment ready
4. ✅ FVM Flutter configured

### Execute IMPLEMENT Phase

```bash
/implement
```

**OR** proceed directly with implementation following this plan.

---

## Appendix A: Test Code Templates

### Template 1: Basic Widget Test

```dart
testWidgets('Description of test', (WidgetTester tester) async {
  // Setup
  await tester.pumpWidget(
    const MaterialApp(
      home: HaikuInputPage(),
    ),
  );

  // Action
  await tester.enterText(find.byType(AppTextField), 'test text');
  await tester.pump();

  // Assert
  expect(find.text('expected'), findsOneWidget);
});
```

### Template 2: Navigation Test

```dart
testWidgets('Navigation test', (WidgetTester tester) async {
  await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));

  // Action: Complete step
  await tester.enterText(find.byType(AppTextField), '古池や');
  await tester.tap(find.byType(AppFilledButton));
  await tester.pumpAndSettle(); // Wait for animations

  // Assert: New page loaded
  expect(find.text('真ん中の行を入力'), findsOneWidget);
});
```

### Template 3: Validation Test

```dart
testWidgets('Validation test', (WidgetTester tester) async {
  await tester.pumpWidget(const MaterialApp(home: HaikuInputPage()));

  // Initial state: Button disabled
  final button1 = tester.widget<AppFilledButton>(find.byType(AppFilledButton));
  expect(button1.onPressed, isNull);

  // Enter valid text
  await tester.enterText(find.byType(AppTextField), 'valid');
  await tester.pump();

  // Button enabled
  final button2 = tester.widget<AppFilledButton>(find.byType(AppFilledButton));
  expect(button2.onPressed, isNotNull);
});
```

---

## Appendix B: Expected Test Output

```bash
$ fvm flutter test test/features/haiku/

Running tests...
00:01 +1: test/features/haiku/presentation/pages/haiku_input_page_test.dart: Validation logic Empty text is invalid
00:02 +2: test/features/haiku/presentation/pages/haiku_input_page_test.dart: Validation logic Non-empty text <=10 chars is valid
00:03 +3: test/features/haiku/presentation/pages/haiku_input_page_test.dart: Validation logic Text exactly 10 chars is valid
...
00:25 +25: test/features/haiku/presentation/widgets/haiku_preview_test.dart: HaikuPreview widget Lines arranged right-to-left
00:26 +30: test/features/haiku/presentation/widgets/step_indicator_test.dart: StepIndicator widget Label "手順" is displayed
00:27 +35: All tests passed!

✓ 35 tests passed (0 failed, 0 skipped)
```

---

## Appendix C: File Tree After Implementation

```
lib/features/haiku/
└── presentation/
    ├── pages/
    │   └── haiku_input_page.dart          [MODIFIED - +1 line]
    └── widgets/
        ├── haiku_preview.dart              [UNCHANGED]
        └── step_indicator.dart             [UNCHANGED]

test/features/haiku/                        [NEW DIRECTORY]
└── presentation/
    ├── pages/
    │   └── haiku_input_page_test.dart      [NEW - ~200 lines]
    └── widgets/
        ├── haiku_preview_test.dart         [NEW - ~100 lines]
        └── step_indicator_test.dart        [NEW - ~80 lines]
```

---

## Conclusion

### Summary

**Implementation Scope**: Minimal, focused, low-risk
- 1 file modified
- 1 line added
- 3 test files created
- ~380 lines of tests

**Confidence Level**: Very High
- Well-defined requirements
- Simple implementation
- Comprehensive test coverage
- Low architectural impact
- Easy rollback if needed

**Ready for Implementation**: ✅ YES

### Recommendation

**Proceed to IMPLEMENT Phase** with confidence.

All planning criteria met:
- ✅ Requirements clear
- ✅ Design complete
- ✅ Tests specified
- ✅ Risks mitigated
- ✅ Architecture compliant
- ✅ Success criteria defined

---

**End of Plan Document**
