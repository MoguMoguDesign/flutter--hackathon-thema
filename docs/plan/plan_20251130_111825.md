# Implementation Plan: Post Detail Screen

**Issue:** [#44] ã¿ã‚“ãªã®æŠ•ç¨¿ã®è©³ç´°ç”»é¢ã‚’å®Ÿè£…ã™ã‚‹ (Implement Post Detail Screen)
**Branch:** feat/shousaigamen
**Plan Created:** 2025-11-30
**Planner:** Claude Code
**Investigation Report:** docs/investigate/investigate_20251130_111353.md
**Architecture Layer:** Feature (haiku)
**Estimated Time:** 1-2 hours
**Priority:** Medium (ğŸŸ¡)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Implementation Strategy](#2-implementation-strategy)
3. [Detailed Task Breakdown](#3-detailed-task-breakdown)
4. [File Change Plan](#4-file-change-plan)
5. [Test Strategy](#5-test-strategy)
6. [Tech Stack Verification](#6-tech-stack-verification)
7. [Risk Analysis and Mitigation](#7-risk-analysis-and-mitigation)
8. [Quality Assurance Steps](#8-quality-assurance-steps)
9. [Implementation Timeline](#9-implementation-timeline)
10. [Success Criteria](#10-success-criteria)

---

## 1. Executive Summary

### 1.1 Overview

This plan outlines the implementation of a post detail screen (`/posts/:postId`) for the Flutter Hackathon Thema project. The feature will allow users to view detailed information about individual haiku posts, including the ability to like posts and share them on social media platforms.

### 1.2 Key Objectives

- âœ… Fetch and display individual haiku posts from Firestore
- âœ… Show author nickname, haiku text, image (4:5 aspect ratio), and like count
- âœ… Implement like button functionality with count increment
- âœ… Provide navigation back to post list
- âœ… Handle loading states with `CircularProgressIndicator`
- âœ… Implement error handling with retry option
- âœ… Achieve comprehensive test coverage

### 1.3 Architecture Compliance

**Layer:** Feature Layer (`lib/features/haiku/`)

**Dependency Rules:**
- âœ… No Feature-to-Feature dependencies
- âœ… Uses Shared layer components only
- âœ… App layer provides routing configuration
- âœ… Self-contained within haiku feature

### 1.4 Deliverables

**Code:**
- 2 new state/provider files (+ 2 generated files)
- 4 modified existing files
- 3 new test files (+ 1 modified test file)

**Documentation:**
- Updated inline documentation (Japanese)
- Test coverage report

**Quality Gates:**
- âœ… `fvm flutter analyze` passes
- âœ… `dart format` compliance
- âœ… `fvm flutter test` all passing
- âœ… Code generation complete

---

## 2. Implementation Strategy

### 2.1 Phased Approach

The implementation will follow a **bottom-up approach** with three phases:

#### Phase 1: Data Layer Foundation (Priority: HIGH)
1. Update `HaikuModel` with new fields
2. Add repository methods for like functionality
3. Update existing provider for nickname storage
4. Add repository tests

**Why First:** Establishes the data foundation that all other layers depend on.

#### Phase 2: Presentation Layer Implementation (Priority: HIGH)
1. Create Freezed state class
2. Create Riverpod providers
3. Update detail page UI with state management
4. Add like button UI component
5. Add provider tests

**Why Second:** Builds on the data foundation to create the user interface.

#### Phase 3: Testing and Quality Assurance (Priority: MEDIUM)
1. Add widget tests
2. Run code generation
3. Execute all quality checks
4. Manual testing on Chrome
5. Verify wireframe compliance

**Why Last:** Ensures the implementation meets all quality and functional requirements.

### 2.2 Development Workflow

```
[Phase 1: Data Layer]
    â†“
[Run code generation]
    â†“
[Run tests for data layer]
    â†“
[Phase 2: Presentation Layer]
    â†“
[Run code generation]
    â†“
[Run tests for presentation layer]
    â†“
[Phase 3: QA]
    â†“
[Final validation]
```

### 2.3 Key Design Decisions

#### Decision 1: Nickname Storage Strategy
**Choice:** Store nickname in HaikuModel (denormalized)
**Rationale:**
- Simpler implementation
- No additional Firestore queries
- Matches wireframe requirements
- Consistent with investigation recommendations

#### Decision 2: Like Count Implementation
**Choice:** Use Firestore `FieldValue.increment()`
**Rationale:**
- Atomic operation (prevents race conditions)
- Server-side increment (accurate counts)
- No need for transactions
- Built-in Firestore feature

#### Decision 3: State Management Pattern
**Choice:** FutureProvider for data fetching, AsyncNotifier for like actions
**Rationale:**
- Follows existing patterns in codebase
- FutureProvider handles loading/error states automatically
- AsyncNotifier manages stateful operations
- Consistent with hooks_riverpod 3.x patterns

---

## 3. Detailed Task Breakdown

### Phase 1: Data Layer Foundation

#### Task 1.1: Update HaikuModel
**File:** `lib/features/haiku/data/models/haiku_model.dart`
**Priority:** HIGH
**Estimated Time:** 10 minutes

**Steps:**
1. Add `int? likeCount` field
2. Add `String? nickname` field
3. Update constructor with new fields
4. Update `fromJson` factory with default values:
   ```dart
   likeCount: json['likeCount'] as int? ?? 0,
   nickname: json['nickname'] as String?,
   ```
5. Update `toJson` method
6. Update `copyWith` method
7. Update equality operators
8. Update `toString` method
9. Add Japanese doc comments

**Acceptance Criteria:**
- âœ… Model compiles without errors
- âœ… Default values handle backward compatibility
- âœ… All methods include new fields
- âœ… Japanese documentation added

#### Task 1.2: Add Repository Method for Like Increment
**File:** `lib/features/haiku/data/repositories/haiku_repository.dart`
**Priority:** HIGH
**Estimated Time:** 15 minutes

**Steps:**
1. Add `incrementLikeCount` method:
   ```dart
   /// ã„ã„ã­æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã™ã‚‹
   ///
   /// [haikuId] ã„ã„ã­å¯¾è±¡ã®ä¿³å¥ID
   ///
   /// Firestoreã®`FieldValue.increment()`ã‚’ä½¿ç”¨ã—ã¦
   /// ã‚¢ãƒˆãƒŸãƒƒã‚¯ã«ã„ã„ã­æ•°ã‚’å¢—ã‚„ã—ã¾ã™ã€‚
   Future<void> incrementLikeCount(String haikuId) async {
     final stopwatch = Stopwatch()..start();

     try {
       _logger.i('Incrementing like count for haiku: $haikuId');

       await collection.doc(haikuId).update({
         'likeCount': FieldValue.increment(1),
       });

       stopwatch.stop();
       _logger.i(
         'Like count incremented successfully (${stopwatch.elapsedMilliseconds}ms)',
       );
     } catch (e, stackTrace) {
       stopwatch.stop();
       _logger.e(
         'Failed to increment like count',
         error: e,
         stackTrace: stackTrace,
       );
       rethrow;
     }
   }
   ```
2. Import `FieldValue` from Firestore
3. Add error handling
4. Add logging
5. Add Japanese doc comments

**Acceptance Criteria:**
- âœ… Method uses `FieldValue.increment(1)`
- âœ… Error handling implemented
- âœ… Logging added
- âœ… Japanese documentation complete

#### Task 1.3: Update HaikuProvider for Nickname
**File:** `lib/features/haiku/presentation/providers/haiku_provider.dart`
**Priority:** HIGH
**Estimated Time:** 15 minutes

**Steps:**
1. Import nickname provider:
   ```dart
   import 'package:flutterhackthema/features/nickname/presentation/providers/nickname_provider.dart';
   ```
2. Update `saveHaiku` method to fetch and store nickname:
   ```dart
   Future<String> saveHaiku({
     required String firstLine,
     required String secondLine,
     required String thirdLine,
   }) async {
     _logger.i('Saving haiku to Firestore');

     state = const AsyncValue.loading();

     state = await AsyncValue.guard(() async {
       final repository = ref.read(haikuRepositoryProvider);
       final nickname = await ref.read(nicknameNotifierProvider.future);

       final haiku = HaikuModel(
         id: '',
         firstLine: firstLine,
         secondLine: secondLine,
         thirdLine: thirdLine,
         createdAt: DateTime.now(),
         nickname: nickname,
         likeCount: 0, // Initialize with 0
       );

       final docId = await repository.create(haiku);
       return docId;
     });

     // ... rest of method
   }
   ```
3. Initialize `likeCount` to 0 for new haikus
4. Add Japanese doc comments

**Acceptance Criteria:**
- âœ… Nickname fetched from nicknameNotifierProvider
- âœ… Nickname stored with haiku
- âœ… likeCount initialized to 0
- âœ… No breaking changes to existing functionality

#### Task 1.4: Add Repository Tests
**File:** `test/features/haiku/data/repositories/haiku_repository_test.dart`
**Priority:** HIGH
**Estimated Time:** 20 minutes

**Steps:**
1. Add test group for `incrementLikeCount`:
   ```dart
   group('incrementLikeCount', () {
     test('increments like count by 1', () async {
       // Arrange
       const docId = 'like-test';
       final haiku = HaikuModel(
         id: docId,
         firstLine: 'å¤æ± ã‚„',
         secondLine: 'è›™é£›ã³è¾¼ã‚€',
         thirdLine: 'æ°´ã®éŸ³',
         createdAt: DateTime(2025, 1, 1),
         likeCount: 5,
       );
       await repository.create(haiku, docId: docId);

       // Act
       await repository.incrementLikeCount(docId);

       // Assert
       final result = await repository.read(docId);
       expect(result!.likeCount, equals(6));
     });

     test('throws error for non-existent haiku', () async {
       // Act & Assert
       expect(
         () => repository.incrementLikeCount('non-existent'),
         throwsA(isA<FirebaseException>()),
       );
     });
   });
   ```
2. Add tests for model backward compatibility

**Acceptance Criteria:**
- âœ… Test passes for successful increment
- âœ… Test passes for error case
- âœ… Backward compatibility tested
- âœ… Code coverage maintained

### Phase 2: Presentation Layer Implementation

#### Task 2.1: Create HaikuDetailState
**File:** `lib/features/haiku/presentation/state/haiku_detail_state.dart`
**Priority:** HIGH
**Estimated Time:** 10 minutes

**Steps:**
1. Create new file with Freezed annotation:
   ```dart
   // FLUTTER HACKATHON THEMA - DO NOT DELETE THIS FILE
   // [Standard file header]

   import 'package:freezed_annotation/freezed_annotation.dart';
   import '../../data/models/haiku_model.dart';

   part 'haiku_detail_state.freezed.dart';

   /// ä¿³å¥è©³ç´°ç”»é¢ã®çŠ¶æ…‹
   ///
   /// Freezedã‚’ä½¿ç”¨ã—ã¦ä¸å¤‰ãªçŠ¶æ…‹ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚
   /// åˆæœŸçŠ¶æ…‹ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†ã€ã‚¨ãƒ©ãƒ¼ã®
   /// 4ã¤ã®çŠ¶æ…‹ã‚’æŒã¡ã¾ã™ã€‚
   @freezed
   class HaikuDetailState with _$HaikuDetailState {
     /// åˆæœŸçŠ¶æ…‹
     const factory HaikuDetailState.initial() = _Initial;

     /// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­
     const factory HaikuDetailState.loading() = _Loading;

     /// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†
     ///
     /// [haiku] è¡¨ç¤ºã™ã‚‹ä¿³å¥ãƒ‡ãƒ¼ã‚¿
     /// [nickname] ä½œè€…ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆnullã®å ´åˆã¯"åŒ¿å"ã‚’è¡¨ç¤ºï¼‰
     const factory HaikuDetailState.loaded({
       required HaikuModel haiku,
       String? nickname,
     }) = _Loaded;

     /// ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹
     ///
     /// [message] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     const factory HaikuDetailState.error(String message) = _Error;
   }
   ```
2. Add file header
3. Add Japanese doc comments
4. Follow existing state patterns

**Acceptance Criteria:**
- âœ… Freezed annotation correct
- âœ… Four states defined (initial, loading, loaded, error)
- âœ… Japanese documentation complete
- âœ… Follows project file header format

#### Task 2.2: Create HaikuDetailProvider
**File:** `lib/features/haiku/presentation/providers/haiku_detail_provider.dart`
**Priority:** HIGH
**Estimated Time:** 20 minutes

**Steps:**
1. Create provider for fetching haiku detail:
   ```dart
   // FLUTTER HACKATHON THEMA - DO NOT DELETE THIS FILE
   // [Standard file header]

   import 'package:riverpod_annotation/riverpod_annotation.dart';
   import '../../data/models/haiku_model.dart';
   import '../../data/repositories/haiku_repository.dart';
   import 'haiku_provider.dart';

   part 'haiku_detail_provider.g.dart';

   /// ä¿³å¥è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
   ///
   /// [haikuId] å–å¾—ã™ã‚‹ä¿³å¥ã®ID
   ///
   /// Firestoreã‹ã‚‰æŒ‡å®šã•ã‚ŒãŸIDã®ä¿³å¥ã‚’å–å¾—ã—ã¾ã™ã€‚
   /// ä¿³å¥ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯nullã‚’è¿”ã—ã¾ã™ã€‚
   @riverpod
   Future<HaikuModel?> haikuDetail(Ref ref, String haikuId) async {
     final repository = ref.watch(haikuRepositoryProvider);
     return await repository.read(haikuId);
   }

   /// ã„ã„ã­æ©Ÿèƒ½ã‚’ç®¡ç†ã™ã‚‹Notifier
   ///
   /// ã„ã„ã­ãƒœã‚¿ãƒ³ã®ã‚¿ãƒƒãƒ—æ™‚ã«Firestoreã®ã„ã„ã­æ•°ã‚’
   /// ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã€è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¾ã™ã€‚
   @riverpod
   class LikeNotifier extends _$LikeNotifier {
     /// åˆæœŸçŠ¶æ…‹ã‚’æ§‹ç¯‰
     @override
     FutureOr<void> build() {}

     /// ã„ã„ã­æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã™ã‚‹
     ///
     /// [haikuId] ã„ã„ã­å¯¾è±¡ã®ä¿³å¥ID
     ///
     /// Firestoreã®ã„ã„ã­æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã€
     /// è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã—ã¦å†å–å¾—ã‚’ä¿ƒã—ã¾ã™ã€‚
     Future<void> incrementLike(String haikuId) async {
       state = const AsyncValue.loading();

       state = await AsyncValue.guard(() async {
         await ref.read(haikuRepositoryProvider).incrementLikeCount(haikuId);

         // è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
         ref.invalidate(haikuDetailProvider(haikuId));
       });
     }
   }
   ```
2. Add file header
3. Add Japanese doc comments
4. Import required dependencies

**Acceptance Criteria:**
- âœ… FutureProvider fetches haiku by ID
- âœ… LikeNotifier handles like increment
- âœ… Provider invalidation triggers refetch
- âœ… Japanese documentation complete
- âœ… Error handling through AsyncValue.guard

#### Task 2.3: Update HaikuDetailPage
**File:** `lib/features/haiku/presentation/pages/haiku_detail_page.dart`
**Priority:** HIGH
**Estimated Time:** 30 minutes

**Steps:**
1. Convert from `StatelessWidget` to `HookConsumerWidget`
2. Remove hardcoded haiku data
3. Watch `haikuDetailProvider`
4. Implement state-based UI rendering:
   ```dart
   @override
   Widget build(BuildContext context, WidgetRef ref) {
     final haikuAsync = ref.watch(haikuDetailProvider(haikuId));

     return AppScaffoldWithBackground(
       body: SafeArea(
         child: CustomScrollView(
           slivers: [
             const AppSliverHeader(),
             SliverToBoxAdapter(
               child: Align(
                 alignment: Alignment.centerLeft,
                 child: AppBackButton(onPressed: () {
                   const HaikuListRoute().go(context);
                 }),
               ),
             ),
             haikuAsync.when(
               data: (haiku) {
                 if (haiku == null) {
                   return _buildError(context, 'ä¿³å¥ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                 }
                 return _buildLoaded(context, ref, haiku);
               },
               loading: () => _buildLoading(),
               error: (error, stack) => _buildError(
                 context,
                 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ',
               ),
             ),
           ],
         ),
       ),
     );
   }
   ```
5. Add like button UI
6. Handle loading state
7. Handle error state
8. Update author display to use nickname

**Like Button Implementation:**
```dart
Widget _buildLikeButton(WidgetRef ref, HaikuModel haiku) {
  return InkWell(
    onTap: () {
      ref.read(likeNotifierProvider.notifier).incrementLike(haiku.id);
    },
    child: Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        const Icon(
          Icons.favorite_border,
          color: Colors.white,
          size: 20,
        ),
        const SizedBox(width: 4),
        Text(
          '${haiku.likeCount ?? 0}',
          style: const TextStyle(
            fontSize: 14,
            color: Colors.white,
          ),
        ),
      ],
    ),
  );
}
```

**Acceptance Criteria:**
- âœ… Converts to HookConsumerWidget
- âœ… Watches haikuDetailProvider
- âœ… Handles all AsyncValue states (loading, data, error)
- âœ… Like button functional
- âœ… Nickname displayed (fallback to "åŒ¿å")
- âœ… Maintains existing UI components (SNS buttons, back button)
- âœ… Japanese doc comments added

#### Task 2.4: Add Provider Tests
**File:** `test/features/haiku/presentation/providers/haiku_detail_provider_test.dart`
**Priority:** MEDIUM
**Estimated Time:** 25 minutes

**Steps:**
1. Create test file with Mockito setup:
   ```dart
   import 'package:flutter_test/flutter_test.dart';
   import 'package:hooks_riverpod/hooks_riverpod.dart';
   import 'package:mockito/annotations.dart';
   import 'package:mockito/mockito.dart';

   import 'package:flutterhackthema/features/haiku/data/models/haiku_model.dart';
   import 'package:flutterhackthema/features/haiku/data/repositories/haiku_repository.dart';
   import 'package:flutterhackthema/features/haiku/presentation/providers/haiku_detail_provider.dart';
   import 'package:flutterhackthema/features/haiku/presentation/providers/haiku_provider.dart';

   import 'haiku_detail_provider_test.mocks.dart';

   @GenerateMocks([HaikuRepository])
   void main() {
     group('haikuDetailProvider', () {
       late MockHaikuRepository mockRepository;
       late ProviderContainer container;

       setUp(() {
         mockRepository = MockHaikuRepository();
         container = ProviderContainer(
           overrides: [
             haikuRepositoryProvider.overrideWithValue(mockRepository),
           ],
         );
       });

       tearDown(() {
         container.dispose();
       });

       test('fetches haiku successfully', () async {
         // Arrange
         const haikuId = 'test-id';
         final haiku = HaikuModel(
           id: haikuId,
           firstLine: 'å¤æ± ã‚„',
           secondLine: 'è›™é£›ã³è¾¼ã‚€',
           thirdLine: 'æ°´ã®éŸ³',
           createdAt: DateTime(2025, 1, 1),
           likeCount: 10,
           nickname: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
         );
         when(mockRepository.read(haikuId)).thenAnswer((_) async => haiku);

         // Act
         final result = await container.read(haikuDetailProvider(haikuId).future);

         // Assert
         expect(result, equals(haiku));
         verify(mockRepository.read(haikuId)).called(1);
       });

       test('returns null for non-existent haiku', () async {
         // Arrange
         const haikuId = 'non-existent';
         when(mockRepository.read(haikuId)).thenAnswer((_) async => null);

         // Act
         final result = await container.read(haikuDetailProvider(haikuId).future);

         // Assert
         expect(result, isNull);
       });
     });

     group('LikeNotifier', () {
       late MockHaikuRepository mockRepository;
       late ProviderContainer container;

       setUp(() {
         mockRepository = MockHaikuRepository();
         container = ProviderContainer(
           overrides: [
             haikuRepositoryProvider.overrideWithValue(mockRepository),
           ],
         );
       });

       tearDown(() {
         container.dispose();
       });

       test('increments like count successfully', () async {
         // Arrange
         const haikuId = 'test-id';
         when(mockRepository.incrementLikeCount(haikuId))
             .thenAnswer((_) async => Future.value());

         // Act
         final notifier = container.read(likeNotifierProvider.notifier);
         await notifier.incrementLike(haikuId);

         // Assert
         verify(mockRepository.incrementLikeCount(haikuId)).called(1);
       });

       test('handles error correctly', () async {
         // Arrange
         const haikuId = 'test-id';
         final exception = Exception('Firestore error');
         when(mockRepository.incrementLikeCount(haikuId)).thenThrow(exception);

         // Act
         final notifier = container.read(likeNotifierProvider.notifier);
         await notifier.incrementLike(haikuId);

         // Assert
         final state = container.read(likeNotifierProvider);
         expect(state.hasError, isTrue);
       });
     });
   }
   ```
2. Test successful haiku fetch
3. Test null return for non-existent haiku
4. Test like increment success
5. Test like increment error handling

**Acceptance Criteria:**
- âœ… All provider tests pass
- âœ… Mock repository used
- âœ… Error cases covered
- âœ… Code coverage maintained

### Phase 3: Testing and Quality Assurance

#### Task 3.1: Add Widget Tests
**File:** `test/features/haiku/presentation/pages/haiku_detail_page_test.dart`
**Priority:** MEDIUM
**Estimated Time:** 30 minutes

**Steps:**
1. Create widget test file:
   ```dart
   import 'package:flutter/material.dart';
   import 'package:flutter_test/flutter_test.dart';
   import 'package:hooks_riverpod/hooks_riverpod.dart';

   import 'package:flutterhackthema/features/haiku/data/models/haiku_model.dart';
   import 'package:flutterhackthema/features/haiku/presentation/pages/haiku_detail_page.dart';
   import 'package:flutterhackthema/features/haiku/presentation/providers/haiku_detail_provider.dart';

   void main() {
     group('HaikuDetailPage', () {
       testWidgets('shows loading indicator while fetching', (tester) async {
         // Arrange
         await tester.pumpWidget(
           ProviderScope(
             overrides: [
               haikuDetailProvider('test-id').overrideWith(
                 (ref) => Future.delayed(
                   const Duration(seconds: 1),
                   () => null,
                 ),
               ),
             ],
             child: const MaterialApp(
               home: HaikuDetailPage(haikuId: 'test-id'),
             ),
           ),
         );

         // Assert
         expect(find.byType(CircularProgressIndicator), findsOneWidget);
       });

       testWidgets('displays haiku data when loaded', (tester) async {
         // Arrange
         final haiku = HaikuModel(
           id: 'test-id',
           firstLine: 'å¤æ± ã‚„',
           secondLine: 'è›™é£›ã³è¾¼ã‚€',
           thirdLine: 'æ°´ã®éŸ³',
           createdAt: DateTime(2025, 1, 1),
           likeCount: 15,
           nickname: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
           imageUrl: 'https://example.com/image.png',
         );

         await tester.pumpWidget(
           ProviderScope(
             overrides: [
               haikuDetailProvider('test-id').overrideWith(
                 (ref) => Future.value(haiku),
               ),
             ],
             child: const MaterialApp(
               home: HaikuDetailPage(haikuId: 'test-id'),
             ),
           ),
         );

         await tester.pumpAndSettle();

         // Assert
         expect(find.text('ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ ä½œ'), findsOneWidget);
         expect(find.text('15'), findsOneWidget);
         expect(find.byIcon(Icons.favorite_border), findsOneWidget);
       });

       testWidgets('shows error message on fetch failure', (tester) async {
         // Arrange
         await tester.pumpWidget(
           ProviderScope(
             overrides: [
               haikuDetailProvider('test-id').overrideWith(
                 (ref) => Future.error(Exception('Test error')),
               ),
             ],
             child: const MaterialApp(
               home: HaikuDetailPage(haikuId: 'test-id'),
             ),
           ),
         );

         await tester.pumpAndSettle();

         // Assert
         expect(find.text('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'), findsOneWidget);
       });

       testWidgets('like button tap increments count', (tester) async {
         // Arrange
         final haiku = HaikuModel(
           id: 'test-id',
           firstLine: 'å¤æ± ã‚„',
           secondLine: 'è›™é£›ã³è¾¼ã‚€',
           thirdLine: 'æ°´ã®éŸ³',
           createdAt: DateTime(2025, 1, 1),
           likeCount: 10,
         );

         await tester.pumpWidget(
           ProviderScope(
             overrides: [
               haikuDetailProvider('test-id').overrideWith(
                 (ref) => Future.value(haiku),
               ),
             ],
             child: const MaterialApp(
               home: HaikuDetailPage(haikuId: 'test-id'),
             ),
           ),
         );

         await tester.pumpAndSettle();

         // Act
         await tester.tap(find.byIcon(Icons.favorite_border));
         await tester.pumpAndSettle();

         // Assert
         // Verify like button was tapped (behavior tested in provider tests)
         expect(find.byIcon(Icons.favorite_border), findsOneWidget);
       });
     });
   }
   ```
2. Test loading state
3. Test loaded state with data
4. Test error state
5. Test like button interaction

**Acceptance Criteria:**
- âœ… Loading state tested
- âœ… Loaded state with data tested
- âœ… Error state tested
- âœ… Like button tap tested
- âœ… All widget tests pass

#### Task 3.2: Run Code Generation
**Priority:** HIGH
**Estimated Time:** 5 minutes

**Steps:**
1. Run build_runner:
   ```bash
   fvm flutter pub run build_runner build --delete-conflicting-outputs
   ```
2. Verify generated files:
   - `haiku_model.g.dart`
   - `haiku_detail_state.freezed.dart`
   - `haiku_detail_provider.g.dart`
3. Check for generation errors
4. Resolve any conflicts

**Acceptance Criteria:**
- âœ… All files generated successfully
- âœ… No generation errors
- âœ… Files compile without errors

#### Task 3.3: Run Quality Checks
**Priority:** HIGH
**Estimated Time:** 10 minutes

**Steps:**
1. Run static analysis:
   ```bash
   fvm flutter analyze
   ```
   - Fix any analysis errors
   - Resolve linter warnings

2. Run code formatting:
   ```bash
   dart format --set-exit-if-changed .
   ```
   - Apply formatting if needed

3. Run all tests:
   ```bash
   fvm flutter test
   ```
   - Ensure all tests pass
   - Check for test failures

4. Verify test coverage:
   ```bash
   fvm flutter test --coverage
   ```
   - Aim for >80% coverage on new code

**Acceptance Criteria:**
- âœ… Zero analysis errors
- âœ… Code properly formatted
- âœ… All tests passing
- âœ… Coverage requirements met

#### Task 3.4: Manual Testing
**Priority:** MEDIUM
**Estimated Time:** 15 minutes

**Test Scenarios:**

1. **Basic Navigation**
   - Navigate from post list to detail
   - Verify back button returns to list
   - Test with multiple different posts

2. **Data Display**
   - Verify image loads correctly (4:5 aspect ratio)
   - Verify nickname displays (or "åŒ¿å" if null)
   - Verify like count displays correctly
   - Check SNS share buttons present

3. **Like Functionality**
   - Tap like button
   - Verify count increments
   - Tap multiple times
   - Verify persistence (refresh page)

4. **Loading States**
   - Slow network simulation
   - Verify loading indicator appears
   - Verify smooth transition to loaded state

5. **Error Handling**
   - Invalid haiku ID
   - Verify error message displays
   - Network error simulation
   - Verify retry mechanism

6. **Edge Cases**
   - Haiku with no image
   - Haiku with no nickname
   - Haiku with 0 likes
   - Very long nickname

**Acceptance Criteria:**
- âœ… All test scenarios pass
- âœ… UI matches wireframe
- âœ… No console errors
- âœ… Smooth user experience

---

## 4. File Change Plan

### 4.1 Files to Modify

| File | Type | Changes | Lines Affected | Complexity |
|------|------|---------|---------------|------------|
| `lib/features/haiku/data/models/haiku_model.dart` | Model | Add `likeCount`, `nickname` fields | ~20 lines | Low |
| `lib/features/haiku/data/repositories/haiku_repository.dart` | Repository | Add `incrementLikeCount` method | ~30 lines | Low |
| `lib/features/haiku/presentation/providers/haiku_provider.dart` | Provider | Update `saveHaiku` to include nickname | ~10 lines | Low |
| `lib/features/haiku/presentation/pages/haiku_detail_page.dart` | UI | Convert to HookConsumerWidget, add state management | ~100 lines | Medium |
| `test/features/haiku/data/repositories/haiku_repository_test.dart` | Test | Add `incrementLikeCount` tests | ~30 lines | Low |

**Total Modified:** 5 files
**Estimated Lines Changed:** ~190 lines

### 4.2 Files to Create

| File | Type | Purpose | Est. Lines | Complexity |
|------|------|---------|-----------|------------|
| `lib/features/haiku/presentation/state/haiku_detail_state.dart` | State | Freezed state class | ~40 lines | Low |
| `lib/features/haiku/presentation/providers/haiku_detail_provider.dart` | Provider | Detail data provider | ~60 lines | Medium |
| `test/features/haiku/presentation/providers/haiku_detail_provider_test.dart` | Test | Provider unit tests | ~120 lines | Medium |
| `test/features/haiku/presentation/pages/haiku_detail_page_test.dart` | Test | Widget tests | ~150 lines | Medium |

**Total Created:** 4 files (+ 2 generated files)
**Estimated Lines:** ~370 lines

### 4.3 Auto-Generated Files

| File | Generator | Depends On |
|------|-----------|------------|
| `lib/features/haiku/data/models/haiku_model.g.dart` | json_serializable | haiku_model.dart |
| `lib/features/haiku/presentation/state/haiku_detail_state.freezed.dart` | freezed | haiku_detail_state.dart |
| `lib/features/haiku/presentation/providers/haiku_detail_provider.g.dart` | riverpod_generator | haiku_detail_provider.dart |
| `test/features/haiku/presentation/providers/haiku_detail_provider_test.mocks.dart` | mockito | haiku_detail_provider_test.dart |
| `test/features/haiku/presentation/pages/haiku_detail_page_test.mocks.dart` | mockito | haiku_detail_page_test.dart |

**Total Auto-Generated:** 5 files

### 4.4 Files Not Modified

**Routing:** No changes required
- `lib/app/app_router/routes.dart` - Already configured

**Shared Components:** No changes required
- All shared UI components already available

### 4.5 Change Impact Analysis

| Layer | Files Changed | Risk Level | Mitigation |
|-------|--------------|------------|------------|
| Data | 2 modified | Low | Backward compatible changes, comprehensive tests |
| Presentation | 2 modified, 2 new | Medium | Follow existing patterns, provider tests |
| Tests | 1 modified, 2 new | Low | Independent test files |
| App | 0 modified | None | No app-level changes |
| Shared | 0 modified | None | No shared changes |

**Overall Risk:** Low to Medium

---

## 5. Test Strategy

### 5.1 Test Coverage Goals

| Layer | Coverage Target | Test Types |
|-------|----------------|------------|
| Data Layer | 100% | Unit tests |
| Presentation Layer | 90% | Unit + Widget tests |
| Overall | 85% | Comprehensive |

### 5.2 Unit Tests

#### Data Layer Tests

**File:** `test/features/haiku/data/repositories/haiku_repository_test.dart`

**Test Cases:**
1. âœ… `incrementLikeCount` increments like count by 1
2. âœ… `incrementLikeCount` throws error for non-existent haiku
3. âœ… `HaikuModel.fromJson` handles missing `likeCount` (backward compatibility)
4. âœ… `HaikuModel.fromJson` handles missing `nickname` (backward compatibility)

**Mock Strategy:** FakeFirebaseFirestore injection

#### Provider Tests

**File:** `test/features/haiku/presentation/providers/haiku_detail_provider_test.dart`

**Test Cases:**
1. âœ… `haikuDetailProvider` fetches haiku successfully
2. âœ… `haikuDetailProvider` returns null for non-existent haiku
3. âœ… `haikuDetailProvider` handles Firestore errors
4. âœ… `LikeNotifier.incrementLike` calls repository method
5. âœ… `LikeNotifier.incrementLike` invalidates detail provider
6. âœ… `LikeNotifier.incrementLike` handles errors correctly

**Mock Strategy:** Mockito with @GenerateMocks

### 5.3 Widget Tests

**File:** `test/features/haiku/presentation/pages/haiku_detail_page_test.dart`

**Test Cases:**
1. âœ… Shows loading indicator while fetching
2. âœ… Displays haiku data when loaded
3. âœ… Shows author nickname (or "åŒ¿å" if null)
4. âœ… Displays like count correctly
5. âœ… Shows like button
6. âœ… Shows error message on fetch failure
7. âœ… Shows error message for non-existent haiku
8. âœ… Like button tap triggers incrementLike
9. âœ… Back button navigates to list
10. âœ… SNS share buttons present

**Test Strategy:** ProviderScope overrides with mock data

### 5.4 Integration Testing

**Scope:** Manual testing on Chrome

**Test Scenarios:**
- End-to-end navigation flow
- Data persistence verification
- Error recovery
- Performance testing

### 5.5 Test Execution Plan

```bash
# 1. Run unit tests for data layer
fvm flutter test test/features/haiku/data/

# 2. Generate mocks for new provider tests
fvm flutter pub run build_runner build --delete-conflicting-outputs

# 3. Run provider tests
fvm flutter test test/features/haiku/presentation/providers/haiku_detail_provider_test.dart

# 4. Run widget tests
fvm flutter test test/features/haiku/presentation/pages/haiku_detail_page_test.dart

# 5. Run all tests
fvm flutter test

# 6. Generate coverage report
fvm flutter test --coverage
genhtml coverage/lcov.info -o coverage/html
open coverage/html/index.html
```

---

## 6. Tech Stack Verification

### 6.1 Required Dependencies

**Main Dependencies:**
```yaml
dependencies:
  hooks_riverpod: ^3.0.3  # âœ… Available - State management
  riverpod_annotation: ^3.0.0  # âœ… Available - Provider code generation
  freezed_annotation: ^2.4.4  # âœ… Available - State class generation
  go_router: ^16.2.4  # âœ… Available - Routing
  cloud_firestore: ^4.15.5  # âœ… Available - Firestore integration
  json_annotation: ^4.9.0  # âœ… Available - JSON serialization
  flutter_hooks: ^0.20.5  # âœ… Available - React-like hooks
  logger: ^2.5.0  # âœ… Available - Logging
```

**Dev Dependencies:**
```yaml
dev_dependencies:
  build_runner: ^2.4.13  # âœ… Available - Code generation
  riverpod_generator: ^3.0.0  # âœ… Available - Riverpod code generation
  freezed: ^3.2.3  # âœ… Available - Freezed code generation
  json_serializable: ^6.8.0  # âœ… Available - JSON code generation
  mockito: ^5.4.4  # âœ… Available - Testing mocks
  fake_cloud_firestore: ^3.0.1  # âœ… Available - Firestore testing
  very_good_analysis: ^10.0.0  # âœ… Available - Linting
  riverpod_lint: ^3.0.3  # âœ… Available - Riverpod-specific linting
```

**Status:** âœ… All dependencies available - No new dependencies required

### 6.2 Flutter SDK Compatibility

**Required:** >=3.24.0
**Current:** Managed via FVM (stable channel)
**Status:** âœ… Compatible

### 6.3 Dart SDK Compatibility

**Required:** >=3.9.0
**Status:** âœ… Compatible

### 6.4 Code Generation Tools

| Tool | Version | Purpose | Status |
|------|---------|---------|--------|
| build_runner | ^2.4.13 | Code generation orchestration | âœ… Available |
| riverpod_generator | ^3.0.0 | Generate provider code | âœ… Available |
| freezed | ^3.2.3 | Generate immutable classes | âœ… Available |
| json_serializable | ^6.8.0 | Generate JSON serialization | âœ… Available |
| mockito | ^5.4.4 | Generate test mocks | âœ… Available |

**Status:** âœ… All tools compatible

### 6.5 Linting and Analysis

| Tool | Version | Purpose | Status |
|------|---------|---------|--------|
| very_good_analysis | ^10.0.0 | Comprehensive linting rules | âœ… Available |
| riverpod_lint | ^3.0.3 | Riverpod-specific linting | âœ… Available |

**Status:** âœ… All linters configured

---

## 7. Risk Analysis and Mitigation

### 7.1 Technical Risks

| Risk | Severity | Probability | Impact | Mitigation |
|------|----------|-------------|--------|------------|
| **Firestore Read Costs** | Medium | High | Budget impact | Use caching via Riverpod, minimize unnecessary reads |
| **Race Condition on Like** | Medium | Low | Incorrect counts | Use `FieldValue.increment()` for atomic operations |
| **Backward Compatibility** | Low | Medium | Existing data breaks | Add default values in `fromJson` |
| **Code Generation Errors** | Low | Low | Build failures | Follow exact patterns, test after generation |
| **Provider State Management** | Medium | Low | UI inconsistency | Follow existing patterns, comprehensive tests |

#### Mitigation Strategies

**Risk 1: Firestore Read Costs**
- **Strategy:** Riverpod caches provider data automatically
- **Action:** Use `ref.watch()` instead of repeated repository calls
- **Monitoring:** Track Firestore usage in Firebase Console

**Risk 2: Race Condition on Like**
- **Strategy:** Use Firestore `FieldValue.increment(1)`
- **Action:** Atomic server-side increment
- **Verification:** Unit tests verify correct increment behavior

**Risk 3: Backward Compatibility**
- **Strategy:** Default values in JSON deserialization
- **Action:** `likeCount: json['likeCount'] as int? ?? 0`
- **Testing:** Unit tests with missing fields

**Risk 4: Code Generation Errors**
- **Strategy:** Follow exact patterns from existing code
- **Action:** Copy-paste-modify from working examples
- **Validation:** Immediate compilation after generation

**Risk 5: Provider State Management**
- **Strategy:** Follow hooks_riverpod 3.x patterns
- **Action:** Use existing providers as templates
- **Testing:** Comprehensive provider tests

### 7.2 Implementation Risks

| Risk | Severity | Probability | Impact | Mitigation |
|------|----------|-------------|--------|------------|
| **Breaking Existing Tests** | Low | Medium | CI/CD failure | Run tests incrementally, fix immediately |
| **UI Regression** | Low | Low | User experience degradation | Manual testing, widget tests |
| **State Management Bugs** | Medium | Low | Incorrect UI state | Provider tests, state transition verification |
| **Performance Issues** | Low | Low | Slow UI | Profile with DevTools, optimize as needed |

#### Mitigation Strategies

**Risk 1: Breaking Existing Tests**
- **Strategy:** Incremental test execution
- **Action:** Run tests after each major change
- **Recovery:** Immediate fix before proceeding

**Risk 2: UI Regression**
- **Strategy:** Widget tests + manual testing
- **Action:** Verify wireframe compliance
- **Checklist:** All UI components functional

**Risk 3: State Management Bugs**
- **Strategy:** Comprehensive provider tests
- **Action:** Test all state transitions
- **Verification:** Loading â†’ Data â†’ Error flows

**Risk 4: Performance Issues**
- **Strategy:** Flutter DevTools profiling
- **Action:** Monitor rebuild frequency
- **Optimization:** Use `const` constructors

### 7.3 Risk Matrix

```
Severity vs Probability

High    â”‚                    â”‚
        â”‚                    â”‚
        â”‚                    â”‚
Medium  â”‚  Firestore Costs   â”‚ Race Condition
        â”‚  State Mgmt Bugs   â”‚ Backward Compat
        â”‚                    â”‚ Breaking Tests
Low     â”‚  Code Gen Errors   â”‚
        â”‚  UI Regression     â”‚
        â”‚  Performance       â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Low              Med              High
                    Probability
```

**Overall Risk Level:** LOW to MEDIUM (Acceptable with mitigations)

---

## 8. Quality Assurance Steps

### 8.1 Pre-Implementation Checklist

- [ ] Investigation report reviewed and understood
- [ ] Architecture compliance verified
- [ ] Style guide reviewed
- [ ] Development environment set up
- [ ] FVM Flutter version correct
- [ ] All dependencies installed

### 8.2 During Implementation Checklist

**After Each Task:**
- [ ] Code compiles without errors
- [ ] Japanese doc comments added
- [ ] Follows naming conventions
- [ ] Uses `const` where possible
- [ ] Explicit types specified

**After Phase 1 (Data Layer):**
- [ ] `fvm flutter pub run build_runner build --delete-conflicting-outputs`
- [ ] `fvm flutter test test/features/haiku/data/`
- [ ] All data layer tests pass

**After Phase 2 (Presentation Layer):**
- [ ] `fvm flutter pub run build_runner build --delete-conflicting-outputs`
- [ ] `fvm flutter test test/features/haiku/presentation/`
- [ ] All presentation layer tests pass

### 8.3 Pre-Commit Checklist

**Mandatory Quality Gates:**

1. **Code Generation**
   ```bash
   fvm flutter pub run build_runner build --delete-conflicting-outputs
   ```
   - [ ] All files generated successfully
   - [ ] No generation errors

2. **Static Analysis**
   ```bash
   fvm flutter analyze
   ```
   - [ ] Zero analysis errors
   - [ ] Zero linter warnings

3. **Code Formatting**
   ```bash
   dart format --set-exit-if-changed .
   ```
   - [ ] All files properly formatted
   - [ ] No formatting changes needed

4. **Unit Tests**
   ```bash
   fvm flutter test
   ```
   - [ ] All tests passing
   - [ ] No test failures
   - [ ] No skipped tests

5. **Test Coverage**
   ```bash
   fvm flutter test --coverage
   ```
   - [ ] Coverage â‰¥85% for new code
   - [ ] All critical paths tested

6. **Manual Testing**
   - [ ] App runs without errors
   - [ ] Detail page navigation works
   - [ ] Like button functional
   - [ ] Loading states display correctly
   - [ ] Error states display correctly
   - [ ] UI matches wireframe

### 8.4 Code Review Checklist

**Architecture:**
- [ ] No Feature-to-Feature dependencies
- [ ] Follows three-layer architecture
- [ ] Shared components used appropriately
- [ ] App layer not modified unnecessarily

**Code Quality:**
- [ ] Follows style guide
- [ ] Japanese doc comments on public APIs
- [ ] Meaningful variable/function names
- [ ] No magic numbers or strings
- [ ] Proper error handling

**State Management:**
- [ ] Uses `@riverpod` annotation
- [ ] Follows AsyncValue patterns
- [ ] Provider invalidation correct
- [ ] No unnecessary rebuilds

**Testing:**
- [ ] Comprehensive test coverage
- [ ] Unit tests for data layer
- [ ] Provider tests for state management
- [ ] Widget tests for UI
- [ ] Edge cases covered

**Performance:**
- [ ] Uses `const` constructors
- [ ] No unnecessary rebuilds
- [ ] Efficient Firestore queries
- [ ] Proper caching via providers

### 8.5 Definition of Done

A task is considered complete when:

1. âœ… Code implemented according to specification
2. âœ… All quality gates passed (analyze, format, test)
3. âœ… Comprehensive tests written and passing
4. âœ… Japanese documentation added
5. âœ… Code generation successful
6. âœ… Manual testing completed
7. âœ… Wireframe compliance verified
8. âœ… No console errors or warnings
9. âœ… Code review checklist satisfied
10. âœ… Changes committed with proper message

---

## 9. Implementation Timeline

### 9.1 Time Estimates

| Phase | Tasks | Est. Time | Cumulative |
|-------|-------|-----------|------------|
| **Phase 1: Data Layer** | 4 tasks | 60 min | 1h 00m |
| **Phase 2: Presentation** | 4 tasks | 85 min | 2h 25m |
| **Phase 3: QA** | 4 tasks | 60 min | 3h 25m |
| **Buffer** | Contingency | 35 min | 4h 00m |

**Total Estimated Time:** 3-4 hours

### 9.2 Detailed Timeline

#### Phase 1: Data Layer Foundation (60 minutes)

| Task | Time | Cumulative |
|------|------|------------|
| 1.1: Update HaikuModel | 10 min | 0:10 |
| 1.2: Add Repository Method | 15 min | 0:25 |
| 1.3: Update HaikuProvider | 15 min | 0:40 |
| 1.4: Add Repository Tests | 20 min | 1:00 |

**Checkpoint:** Run tests, verify data layer complete

#### Phase 2: Presentation Layer (85 minutes)

| Task | Time | Cumulative |
|------|------|------------|
| 2.1: Create HaikuDetailState | 10 min | 1:10 |
| 2.2: Create HaikuDetailProvider | 20 min | 1:30 |
| 2.3: Update HaikuDetailPage | 30 min | 2:00 |
| 2.4: Add Provider Tests | 25 min | 2:25 |

**Checkpoint:** Run tests, verify presentation layer complete

#### Phase 3: Testing and QA (60 minutes)

| Task | Time | Cumulative |
|------|------|------------|
| 3.1: Add Widget Tests | 30 min | 2:55 |
| 3.2: Run Code Generation | 5 min | 3:00 |
| 3.3: Run Quality Checks | 10 min | 3:10 |
| 3.4: Manual Testing | 15 min | 3:25 |

**Checkpoint:** All quality gates passed

#### Buffer Time (35 minutes)

- Debugging unexpected issues
- Fixing test failures
- Resolving code generation errors
- Additional manual testing

### 9.3 Milestones

| Milestone | Description | Time |
|-----------|-------------|------|
| **M1: Data Layer Complete** | All data layer changes implemented and tested | 1h 00m |
| **M2: Presentation Complete** | All UI and providers implemented | 2h 25m |
| **M3: Testing Complete** | All tests passing, coverage met | 3h 10m |
| **M4: QA Complete** | Manual testing done, ready for commit | 3h 25m |
| **M5: Implementation Done** | All quality gates passed | 4h 00m |

---

## 10. Success Criteria

### 10.1 Functional Requirements

- âœ… **F1:** User can navigate to post detail screen from post list
- âœ… **F2:** Detail screen displays haiku image (4:5 aspect ratio)
- âœ… **F3:** Detail screen displays author nickname (or "åŒ¿å")
- âœ… **F4:** Detail screen displays like count
- âœ… **F5:** User can tap like button to increment count
- âœ… **F6:** Like count persists in Firestore
- âœ… **F7:** User can navigate back to post list
- âœ… **F8:** SNS share buttons present (X, Instagram)
- âœ… **F9:** Loading state displays during data fetch
- âœ… **F10:** Error state displays on fetch failure

### 10.2 Non-Functional Requirements

**Performance:**
- âœ… Page loads in <2 seconds on good connection
- âœ… Like button responds in <500ms
- âœ… No UI jank or frame drops

**Reliability:**
- âœ… Handles network errors gracefully
- âœ… Handles missing data gracefully
- âœ… Atomic like increment (no race conditions)

**Maintainability:**
- âœ… Code follows architecture guidelines
- âœ… Comprehensive test coverage (â‰¥85%)
- âœ… Clear Japanese documentation

**Usability:**
- âœ… UI matches wireframe design
- âœ… Intuitive navigation
- âœ… Clear error messages

### 10.3 Quality Gates

All of the following must pass:

1. **Code Quality**
   - âœ… `fvm flutter analyze` - Zero errors
   - âœ… `dart format` - All files formatted
   - âœ… No linter warnings

2. **Testing**
   - âœ… `fvm flutter test` - All tests passing
   - âœ… Unit tests for data layer
   - âœ… Provider tests for state management
   - âœ… Widget tests for UI
   - âœ… Test coverage â‰¥85%

3. **Code Generation**
   - âœ… All `.g.dart` files generated
   - âœ… All `.freezed.dart` files generated
   - âœ… No generation errors

4. **Architecture**
   - âœ… No Feature-to-Feature dependencies
   - âœ… Three-layer architecture followed
   - âœ… Shared components used correctly

5. **Documentation**
   - âœ… Japanese doc comments on public APIs
   - âœ… File headers present
   - âœ… Clear method documentation

6. **Manual Testing**
   - âœ… All functional requirements verified
   - âœ… UI matches wireframe
   - âœ… No console errors

### 10.4 Acceptance Criteria (from GitHub Issue #44)

- âœ… Post detail screen accessible at `/posts/:postId`
- âœ… Displays post data from Firestore
- âœ… Shows author nickname, haiku text, image, and like count
- âœ… Like button increments count
- âœ… Navigation back to post list works
- âœ… Loading state with CircularProgressIndicator
- âœ… Error handling with retry option
- âœ… Unit tests for `PostRepository.getPostById()` and provider logic
- âœ… Widget tests for UI state displays
- âœ… Code quality checks pass

### 10.5 Definition of Done

The implementation is complete when:

1. âœ… All functional requirements met
2. âœ… All non-functional requirements met
3. âœ… All quality gates passed
4. âœ… All acceptance criteria satisfied
5. âœ… Wireframe compliance verified
6. âœ… No known bugs or issues
7. âœ… Code review completed
8. âœ… Documentation complete
9. âœ… Ready for pull request

---

## Appendix A: Command Reference

### Development Commands

```bash
# Install dependencies
fvm flutter pub get

# Run code generation
fvm flutter pub run build_runner build --delete-conflicting-outputs

# Run code generation (watch mode)
fvm flutter pub run build_runner watch --delete-conflicting-outputs

# Run static analysis
fvm flutter analyze

# Format code
dart format --set-exit-if-changed .

# Run all tests
fvm flutter test

# Run specific test file
fvm flutter test test/features/haiku/data/repositories/haiku_repository_test.dart

# Run tests with coverage
fvm flutter test --coverage

# Generate HTML coverage report
genhtml coverage/lcov.info -o coverage/html
open coverage/html/index.html

# Run app
fvm flutter run -d chrome
```

### Git Commands

```bash
# Check current branch
git status

# View changes
git diff

# Stage changes
git add .

# Commit changes (Angular style)
git commit -m "feat(haiku): implement post detail screen with like functionality"

# Push to remote
git push origin feat/shousaigamen
```

---

## Appendix B: File Templates

### Freezed State Template

```dart
// FLUTTER HACKATHON THEMA - DO NOT DELETE THIS FILE
// This file is managed by AI development rules (CLAUDE.md)
//
// Architecture: Three-Layer (App â†’ Feature â†’ Shared)
// State Management: hooks_riverpod 3.x with @riverpod annotation (MANDATORY)
// Router: go_router 16.x (MANDATORY)
// Code Generation: build_runner, riverpod_generator, freezed (REQUIRED)
// Testing: Comprehensive coverage required
//
// Development Rules:
// - Use @riverpod annotation for all providers
// - Use HookConsumerWidget when using hooks
// - Documentation comments in Japanese (///)
// - Follow three-layer architecture strictly
// - No direct Feature-to-Feature dependencies
// - All changes must pass: analyze, format, test
//

import 'package:freezed_annotation/freezed_annotation.dart';

part 'example_state.freezed.dart';

/// [State description in Japanese]
@freezed
class ExampleState with _$ExampleState {
  const factory ExampleState.initial() = _Initial;
  const factory ExampleState.loading() = _Loading;
  const factory ExampleState.success(Data data) = _Success;
  const factory ExampleState.error(String message) = _Error;
}
```

### Riverpod Provider Template

```dart
// FLUTTER HACKATHON THEMA - DO NOT DELETE THIS FILE
// [Standard file header]

import 'package:riverpod_annotation/riverpod_annotation.dart';

part 'example_provider.g.dart';

/// [Provider description in Japanese]
@riverpod
FutureOr<ReturnType> exampleProvider(Ref ref) async {
  // Implementation
}

/// [Notifier description in Japanese]
@riverpod
class ExampleNotifier extends _$ExampleNotifier {
  @override
  FutureOr<StateType> build() {
    // Initial state
  }

  /// [Method description in Japanese]
  Future<void> exampleMethod() async {
    state = const AsyncValue.loading();
    state = await AsyncValue.guard(() async {
      // Implementation
    });
  }
}
```

---

## Appendix C: Testing Patterns

### Repository Test Pattern

```dart
class TestExampleRepository extends ExampleRepository {
  TestExampleRepository({required FakeFirebaseFirestore fakeFirestore})
    : _fakeFirestore = fakeFirestore;

  final FakeFirebaseFirestore _fakeFirestore;

  @override
  FirebaseFirestore get firestore => _fakeFirestore;
}

void main() {
  group('ExampleRepository', () {
    late FakeFirebaseFirestore fakeFirestore;
    late TestExampleRepository repository;

    setUp(() {
      fakeFirestore = FakeFirebaseFirestore();
      repository = TestExampleRepository(fakeFirestore: fakeFirestore);
    });

    test('description', () async {
      // Arrange
      // Act
      // Assert
    });
  });
}
```

### Provider Test Pattern

```dart
@GenerateMocks([ExampleRepository])
void main() {
  group('ExampleNotifier', () {
    late MockExampleRepository mockRepository;
    late ProviderContainer container;

    setUp(() {
      mockRepository = MockExampleRepository();
      container = ProviderContainer(
        overrides: [
          exampleRepositoryProvider.overrideWithValue(mockRepository),
        ],
      );
    });

    tearDown(() {
      container.dispose();
    });

    test('description', () async {
      // Arrange
      when(mockRepository.method(any)).thenAnswer((_) async => result);

      // Act
      final result = await container.read(exampleProvider.future);

      // Assert
      expect(result, expectedValue);
      verify(mockRepository.method(any)).called(1);
    });
  });
}
```

### Widget Test Pattern

```dart
void main() {
  group('ExamplePage', () {
    testWidgets('description', (tester) async {
      // Arrange
      await tester.pumpWidget(
        ProviderScope(
          overrides: [
            exampleProvider.overrideWith((ref) => Future.value(data)),
          ],
          child: const MaterialApp(
            home: ExamplePage(),
          ),
        ),
      );

      await tester.pumpAndSettle();

      // Assert
      expect(find.text('Expected Text'), findsOneWidget);
    });
  });
}
```

---

## Appendix D: Troubleshooting

### Common Issues and Solutions

#### Issue 1: Code Generation Fails
**Symptoms:** `build_runner` errors, missing `.g.dart` files

**Solutions:**
1. Clean build cache:
   ```bash
   fvm flutter clean
   fvm flutter pub get
   ```
2. Delete conflicting outputs:
   ```bash
   fvm flutter pub run build_runner build --delete-conflicting-outputs
   ```
3. Check for syntax errors in source files
4. Verify `part` directives match filename

#### Issue 2: Tests Failing
**Symptoms:** `flutter test` shows failures

**Solutions:**
1. Run code generation first:
   ```bash
   fvm flutter pub run build_runner build --delete-conflicting-outputs
   ```
2. Check mock generation:
   ```bash
   ls test/**/*.mocks.dart
   ```
3. Verify provider overrides in tests
4. Check for async timing issues

#### Issue 3: Analyze Errors
**Symptoms:** `flutter analyze` shows errors

**Solutions:**
1. Check for missing imports
2. Verify type annotations
3. Run format:
   ```bash
   dart format .
   ```
4. Check for unused imports

#### Issue 4: Firestore Errors
**Symptoms:** Firestore read/write failures

**Solutions:**
1. Check Firestore rules
2. Verify collection/document paths
3. Check data model matches Firestore structure
4. Verify `fromJson`/`toJson` implementation

---

**End of Implementation Plan**

Generated by: Claude Code
Date: 2025-11-30
Branch: feat/shousaigamen
Next Phase: IMPLEMENT
Estimated Time: 3-4 hours
