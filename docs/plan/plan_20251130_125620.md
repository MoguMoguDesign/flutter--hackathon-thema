# Implementation Plan: Issue #31 - Realtime Haiku Preview

**Plan Date**: 2025-11-30 12:56:20
**Branch**: feature/realtime-haiku-preview
**Issue**: [#31 - ä¿³å¥å…¥åŠ›ä¸­ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç¸¦æ›¸ããƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º](https://github.com/MoguMoguDesign/flutter--hackathon-thema/issues/31)
**Investigation**: docs/investigate/investigate_20251130_125010.md

## Executive Summary

This plan details the implementation of realtime vertical haiku preview during text input. The enhancement will display the vertical preview as users type, improving UX and allowing immediate visual feedback.

**Scope**: UI enhancement in Feature layer (haiku presentation)
**Effort**: Low (1-2 hours)
**Risk**: Low (minimal code changes, no breaking changes)
**Priority**: HIGH (high user value, low implementation cost)

---

## Table of Contents

1. [Implementation Strategy](#implementation-strategy)
2. [Detailed Task Breakdown](#detailed-task-breakdown)
3. [File Change Plan](#file-change-plan)
4. [Test Strategy](#test-strategy)
5. [Tech Stack Compatibility](#tech-stack-compatibility)
6. [Architecture Compliance](#architecture-compliance)
7. [Risk Analysis](#risk-analysis)
8. [Quality Gates](#quality-gates)
9. [Implementation Checklist](#implementation-checklist)

---

## Implementation Strategy

### Overview

Modify the `HaikuPreview` widget instantiation in `haiku_input_page.dart` to pass the current input text based on the active step. This leverages the existing `useEffect` listener that already monitors `inputController` changes.

### Key Approach

**No New State or Listeners Required**
- Existing `useEffect` (lines 56-64) already monitors `inputController.text`
- Widget rebuilds automatically when text changes
- Simply modify parameter values passed to `HaikuPreview`

**Conditional Display Logic**
```dart
// Step-based conditional rendering
currentStep.value == 0 ? inputController.text : firstLine.value
currentStep.value == 1 ? inputController.text : secondLine.value
currentStep.value == 2 ? inputController.text : thirdLine.value
```

### Benefits

1. **Minimal Code Changes**: Only 5-10 lines modified
2. **No Architectural Changes**: Stays within Feature layer
3. **No Breaking Changes**: All existing functionality preserved
4. **Leverages Existing Infrastructure**: Uses current listener and state
5. **Performance Efficient**: Already rebuilding on text change

---

## Detailed Task Breakdown

### Phase 1: Code Modification (Priority: P0 - Critical)

#### Task 1.1: Modify HaikuPreview Widget Parameters
**File**: `lib/features/haiku/presentation/pages/haiku_input_page.dart`
**Lines**: 204-209
**Estimated Time**: 15 minutes

**Current Code**:
```dart
HaikuPreview(
  firstLine: firstLine.value,
  secondLine: currentStep.value >= 1 ? secondLine.value : '',
  thirdLine: currentStep.value >= 2 ? thirdLine.value : '',
),
```

**New Code**:
```dart
HaikuPreview(
  firstLine: currentStep.value == 0
    ? inputController.text
    : firstLine.value,
  secondLine: currentStep.value == 1
    ? inputController.text
    : (currentStep.value >= 1 ? secondLine.value : ''),
  thirdLine: currentStep.value == 2
    ? inputController.text
    : (currentStep.value >= 2 ? thirdLine.value : ''),
),
```

**Acceptance Criteria**:
- [ ] Code compiles without errors
- [ ] Follows project style guide (lowerCamelCase, proper indentation)
- [ ] Maintains existing step-based conditional logic
- [ ] All three steps (ä¸Šäº”, ä¸­ä¸ƒ, ä¸‹äº”) display input correctly

---

### Phase 2: Test Implementation (Priority: P0 - Critical)

#### Task 2.1: Realtime Preview Tests
**File**: `test/features/haiku/presentation/pages/haiku_input_page_test.dart`
**Estimated Time**: 30 minutes

**Test Cases to Add**:

##### Test 2.1.1: Step 0 Realtime Preview
```dart
testWidgets('ã‚¹ãƒ†ãƒƒãƒ—0ã§å…¥åŠ›ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆãŒfirstLineã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã•ã‚Œã‚‹', (tester) async {
  await setLargeTestSurface(tester);
  await pumpTestWidget(tester, const HaikuInputPage());

  // Type single character
  await tester.enterText(find.byType(AppTextField), 'ã‚');
  await tester.pump();

  var preview = tester.widget<HaikuPreview>(find.byType(HaikuPreview));
  expect(preview.firstLine, equals('ã‚'));
  expect(preview.secondLine, isEmpty);
  expect(preview.thirdLine, isEmpty);

  // Type multiple characters
  await tester.enterText(find.byType(AppTextField), 'ã‚ã„ã†');
  await tester.pump();

  preview = tester.widget<HaikuPreview>(find.byType(HaikuPreview));
  expect(preview.firstLine, equals('ã‚ã„ã†'));
  expect(preview.secondLine, isEmpty);
  expect(preview.thirdLine, isEmpty);

  await resetTestSurface(tester);
});
```

##### Test 2.1.2: Step 1 Realtime Preview
```dart
testWidgets('ã‚¹ãƒ†ãƒƒãƒ—1ã§å…¥åŠ›ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆãŒsecondLineã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã•ã‚Œã‚‹', (tester) async {
  await setLargeTestSurface(tester);
  await pumpTestWidget(tester, const HaikuInputPage());

  // Complete step 0
  await tester.enterText(find.byType(AppTextField), 'ã‚ã„ã†');
  await tester.pump();
  await tester.tap(find.byType(AppFilledButton));
  await tester.pumpAndSettle();

  // Type in step 1
  await tester.enterText(find.byType(AppTextField), 'ã‹ã');
  await tester.pump();

  final preview = tester.widget<HaikuPreview>(find.byType(HaikuPreview));
  expect(preview.firstLine, equals('ã‚ã„ã†')); // Confirmed value
  expect(preview.secondLine, equals('ã‹ã')); // Realtime input
  expect(preview.thirdLine, isEmpty);

  await resetTestSurface(tester);
});
```

##### Test 2.1.3: Step 2 Realtime Preview
```dart
testWidgets('ã‚¹ãƒ†ãƒƒãƒ—2ã§å…¥åŠ›ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆãŒthirdLineã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã•ã‚Œã‚‹', (tester) async {
  await setLargeTestSurface(tester);
  await pumpTestWidget(tester, const HaikuInputPage());

  // Complete step 0
  await tester.enterText(find.byType(AppTextField), 'ã‚ã„ã†');
  await tester.pump();
  await tester.tap(find.byType(AppFilledButton));
  await tester.pumpAndSettle();

  // Complete step 1
  await tester.enterText(find.byType(AppTextField), 'ã‹ããã‘ã“');
  await tester.pump();
  await tester.tap(find.byType(AppFilledButton));
  await tester.pumpAndSettle();

  // Type in step 2
  await tester.enterText(find.byType(AppTextField), 'ã•ã—ã™');
  await tester.pump();

  final preview = tester.widget<HaikuPreview>(find.byType(HaikuPreview));
  expect(preview.firstLine, equals('ã‚ã„ã†')); // Confirmed value
  expect(preview.secondLine, equals('ã‹ããã‘ã“')); // Confirmed value
  expect(preview.thirdLine, equals('ã•ã—ã™')); // Realtime input

  await resetTestSurface(tester);
});
```

**Acceptance Criteria**:
- [ ] All 3 realtime preview tests pass
- [ ] Tests verify preview updates on each character input
- [ ] Tests confirm previous steps maintain confirmed values
- [ ] Tests use existing test infrastructure (setLargeTestSurface, pumpTestWidget)

#### Task 2.2: Step Transition Tests
**File**: `test/features/haiku/presentation/pages/haiku_input_page_test.dart`
**Estimated Time**: 20 minutes

**Test Cases to Add**:

##### Test 2.2.1: Confirmed Value Preservation
```dart
testWidgets('æ±ºå®šãƒœã‚¿ãƒ³æŠ¼ä¸‹å¾Œã€å…¥åŠ›ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆãŒç¢ºå®šå€¤ã¨ã—ã¦ä¿å­˜ã•ã‚Œã‚‹', (tester) async {
  await setLargeTestSurface(tester);
  await pumpTestWidget(tester, const HaikuInputPage());

  // Type and confirm step 0
  await tester.enterText(find.byType(AppTextField), 'ã‚ã„ã†');
  await tester.pump();

  // Verify realtime display
  var preview = tester.widget<HaikuPreview>(find.byType(HaikuPreview));
  expect(preview.firstLine, equals('ã‚ã„ã†'));

  // Confirm
  await tester.tap(find.byType(AppFilledButton));
  await tester.pumpAndSettle();

  // Verify confirmed value is preserved
  preview = tester.widget<HaikuPreview>(find.byType(HaikuPreview));
  expect(preview.firstLine, equals('ã‚ã„ã†'));
  expect(preview.secondLine, isEmpty);

  await resetTestSurface(tester);
});
```

##### Test 2.2.2: Input Cleared on Step Transition
```dart
testWidgets('ã‚¹ãƒ†ãƒƒãƒ—é·ç§»æ™‚ã€æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹', (tester) async {
  await setLargeTestSurface(tester);
  await pumpTestWidget(tester, const HaikuInputPage());

  // Complete step 0
  await tester.enterText(find.byType(AppTextField), 'ã‚ã„ã†');
  await tester.pump();
  await tester.tap(find.byType(AppFilledButton));
  await tester.pumpAndSettle();

  // Verify input field is cleared
  final textField = tester.widget<TextField>(find.byType(TextField));
  expect(textField.controller?.text, isEmpty);

  // Verify preview shows only confirmed firstLine
  final preview = tester.widget<HaikuPreview>(find.byType(HaikuPreview));
  expect(preview.firstLine, equals('ã‚ã„ã†'));
  expect(preview.secondLine, isEmpty);

  await resetTestSurface(tester);
});
```

**Acceptance Criteria**:
- [ ] Confirmed values are preserved after step transition
- [ ] Input field clears when moving to next step
- [ ] Preview shows confirmed values, not cleared input

#### Task 2.3: Edge Case Tests
**File**: `test/features/haiku/presentation/pages/haiku_input_page_test.dart`
**Estimated Time**: 15 minutes

**Test Cases to Add**:

##### Test 2.3.1: Empty Input Display
```dart
testWidgets('ç©ºã®å…¥åŠ›ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒé©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹', (tester) async {
  await setLargeTestSurface(tester);
  await pumpTestWidget(tester, const HaikuInputPage());

  // Start with empty input
  final preview = tester.widget<HaikuPreview>(find.byType(HaikuPreview));
  expect(preview.firstLine, isEmpty);
  expect(preview.secondLine, isEmpty);
  expect(preview.thirdLine, isEmpty);

  // Verify placeholder is shown
  expect(find.text('ä¿³å¥ãŒã“ã“ã«\nè¡¨ç¤ºã•ã‚Œã¾ã™'), findsOneWidget);

  await resetTestSurface(tester);
});
```

##### Test 2.3.2: Special Characters Display
```dart
testWidgets('ç‰¹æ®Šæ–‡å­—ã‚„çµµæ–‡å­—ãŒæ­£ã—ãç¸¦æ›¸ãè¡¨ç¤ºã•ã‚Œã‚‹', (tester) async {
  await setLargeTestSurface(tester);
  await pumpTestWidget(tester, const HaikuInputPage());

  // Test with emoji and special characters
  await tester.enterText(find.byType(AppTextField), 'æ¡œğŸŒ¸å’²ã');
  await tester.pump();

  final preview = tester.widget<HaikuPreview>(find.byType(HaikuPreview));
  expect(preview.firstLine, equals('æ¡œğŸŒ¸å’²ã'));

  await resetTestSurface(tester);
});
```

**Acceptance Criteria**:
- [ ] Empty input displays placeholder correctly
- [ ] Special characters (emoji, kanji, hiragana) display correctly
- [ ] No runtime errors with edge case inputs

---

### Phase 3: Quality Verification (Priority: P0 - Critical)

#### Task 3.1: Run Static Analysis
**Command**: `fvm flutter analyze`
**Estimated Time**: 2 minutes

**Acceptance Criteria**:
- [ ] Zero errors reported
- [ ] Zero warnings (if possible)
- [ ] Follows very_good_analysis linting rules

#### Task 3.2: Run Code Formatter
**Command**: `dart format --set-exit-if-changed .`
**Estimated Time**: 1 minute

**Acceptance Criteria**:
- [ ] All modified files properly formatted
- [ ] Consistent with project style guide
- [ ] No formatting changes needed

#### Task 3.3: Run All Tests
**Command**: `fvm flutter test`
**Estimated Time**: 5 minutes

**Acceptance Criteria**:
- [ ] All existing tests pass (23 tests)
- [ ] All new tests pass (5 tests)
- [ ] Total: 28+ tests passing
- [ ] Zero test failures

#### Task 3.4: Run Specific Test File
**Command**: `fvm flutter test test/features/haiku/presentation/pages/haiku_input_page_test.dart`
**Estimated Time**: 2 minutes

**Acceptance Criteria**:
- [ ] All haiku input page tests pass
- [ ] New realtime preview tests included
- [ ] Test execution completes successfully

---

### Phase 4: Manual Testing (Priority: P1 - High)

#### Task 4.1: Device Testing
**Estimated Time**: 10 minutes

**Test Scenarios**:
1. **iOS Simulator**:
   - [ ] Realtime preview works on step 0, 1, 2
   - [ ] Japanese IME input works correctly
   - [ ] Step transitions preserve confirmed values

2. **Android Emulator** (if available):
   - [ ] Realtime preview works on all steps
   - [ ] Japanese IME input works correctly
   - [ ] No performance issues

3. **Web Browser** (if applicable):
   - [ ] Realtime preview displays correctly
   - [ ] Input handling works as expected

**Acceptance Criteria**:
- [ ] Realtime preview visible on all tested platforms
- [ ] No visual glitches or rendering issues
- [ ] Smooth input experience with no lag

#### Task 4.2: User Flow Testing
**Estimated Time**: 5 minutes

**Test Flow**:
1. Open haiku input page
2. Type "å¤æ± ã‚„" in step 0
   - Verify: Realtime vertical display updates character by character
3. Press "æ¬¡ã®è¡Œã¸"
   - Verify: "å¤æ± ã‚„" preserved in first line
   - Verify: Input field cleared
4. Type "è›™é£›ã³è¾¼ã‚€" in step 1
   - Verify: Realtime display in second line
   - Verify: First line still shows "å¤æ± ã‚„"
5. Press "æ¬¡ã®è¡Œã¸"
6. Type "æ°´ã®éŸ³" in step 2
   - Verify: All three lines display correctly
7. Press "æ±ºå®š"
   - Verify: All values confirmed

**Acceptance Criteria**:
- [ ] Complete user flow works end-to-end
- [ ] All steps display realtime preview
- [ ] Confirmed values persist correctly

---

## File Change Plan

### Files to Modify

#### 1. lib/features/haiku/presentation/pages/haiku_input_page.dart

**Change Type**: MODIFICATION
**Lines Affected**: 204-209 (approximately 6 lines)
**Architecture Layer**: Feature â†’ Presentation
**Reason**: Add realtime preview logic to HaikuPreview widget parameters

**Before**:
```dart
HaikuPreview(
  firstLine: firstLine.value,
  secondLine: currentStep.value >= 1 ? secondLine.value : '',
  thirdLine: currentStep.value >= 2 ? thirdLine.value : '',
),
```

**After**:
```dart
HaikuPreview(
  firstLine: currentStep.value == 0
    ? inputController.text
    : firstLine.value,
  secondLine: currentStep.value == 1
    ? inputController.text
    : (currentStep.value >= 1 ? secondLine.value : ''),
  thirdLine: currentStep.value == 2
    ? inputController.text
    : (currentStep.value >= 2 ? thirdLine.value : ''),
),
```

**Impact Analysis**:
- **Breaking Changes**: None
- **Backward Compatibility**: Fully compatible
- **Side Effects**: None (existing behavior preserved)
- **Dependencies**: No new dependencies

#### 2. test/features/haiku/presentation/pages/haiku_input_page_test.dart

**Change Type**: ADDITION
**Lines Added**: Approximately 150-200 lines (5 new test groups)
**Architecture Layer**: Feature â†’ Test
**Reason**: Add comprehensive widget tests for realtime preview feature

**New Test Groups**:
1. `Realtime Preview Display` (3 tests)
2. `Step Transition Behavior` (2 tests)
3. `Edge Cases` (2 tests)

**Impact Analysis**:
- **Breaking Changes**: None (additive only)
- **Test Coverage**: Increases from 23 to 28+ tests
- **Existing Tests**: No modifications to existing tests
- **Dependencies**: Uses existing test infrastructure

### Files to Read (No Changes)

1. `lib/features/haiku/presentation/widgets/haiku_preview.dart`
   - Already reactive, no changes needed

2. `test/features/haiku/presentation/widgets/haiku_preview_test.dart`
   - Existing tests sufficient

### Code Generation Requirements

**Required**: NO
**Reason**:
- No Riverpod provider changes
- No Freezed model changes
- No JSON serialization changes
- No go_router configuration changes

**Commands to Skip**:
- ~~`fvm flutter pub run build_runner build --delete-conflicting-outputs`~~

---

## Test Strategy

### Test Coverage Goals

**Target Coverage**: Comprehensive (100% of new functionality)
**Test Types**: Widget tests only (no unit or integration tests needed)
**Total New Tests**: 5-7 tests

### Test Structure

```
test/features/haiku/presentation/pages/haiku_input_page_test.dart
â”œâ”€â”€ Existing Tests (23) âœ“ All Passing
â””â”€â”€ New Test Groups
    â”œâ”€â”€ Realtime Preview Display
    â”‚   â”œâ”€â”€ Step 0 realtime preview
    â”‚   â”œâ”€â”€ Step 1 realtime preview
    â”‚   â””â”€â”€ Step 2 realtime preview
    â”œâ”€â”€ Step Transition Behavior
    â”‚   â”œâ”€â”€ Confirmed value preservation
    â”‚   â””â”€â”€ Input cleared on transition
    â””â”€â”€ Edge Cases
        â”œâ”€â”€ Empty input display
        â””â”€â”€ Special characters display
```

### Test Infrastructure

**Reuse Existing Patterns**:
1. `setLargeTestSurface()` - Prevents overflow
2. `resetTestSurface()` - Cleanup after tests
3. `pumpTestWidget()` - ProviderScope wrapper

**No New Infrastructure Needed**

### Test Execution Plan

**Pre-Implementation**:
```bash
fvm flutter test test/features/haiku/presentation/pages/haiku_input_page_test.dart
# Expected: 23/23 passing
```

**Post-Implementation**:
```bash
fvm flutter test test/features/haiku/presentation/pages/haiku_input_page_test.dart
# Expected: 28+/28+ passing
```

**Full Test Suite**:
```bash
fvm flutter test
# Expected: All tests passing
```

---

## Tech Stack Compatibility

### Dependencies Verification

**Current Tech Stack** (from pubspec.yaml):
- âœ“ `flutter_hooks: ^0.21.2` - Used for useTextEditingController
- âœ“ `hooks_riverpod: ^3.0.3` - Used for HookConsumerWidget
- âœ“ `go_router: ^16.2.4` - Not affected by this change
- âœ“ `freezed_annotation: ^3.1.0` - Not used in this feature
- âœ“ `riverpod_annotation: ^3.0.3` - Not used in this feature

**Compatibility Assessment**: âœ“ FULLY COMPATIBLE
- No dependency updates required
- No version conflicts
- Existing hooks and state management patterns sufficient

### State Management Pattern

**Current Pattern**: Flutter Hooks + Local State
```dart
final currentStep = useState(0);
final firstLine = useState('');
final secondLine = useState('');
final thirdLine = useState('');
final inputController = useTextEditingController();
final isValid = useState(false);
```

**Changes Required**: NONE
- Reuses existing `inputController`
- Reuses existing `currentStep.value`
- No new state variables needed
- No new hooks needed

### Architecture Pattern

**Current Pattern**: Three-Layer Architecture
- App Layer â†’ Feature Layer â†’ Shared Layer
- Feature: `lib/features/haiku/presentation/pages/`
- Shared: `lib/shared/presentation/widgets/`

**Compliance**: âœ“ FULLY COMPLIANT
- Changes stay within Feature layer
- No cross-feature dependencies
- Correct dependency direction (Feature â†’ Shared)

---

## Architecture Compliance

### Three-Layer Architecture

**Layer**: Feature Layer (Presentation)
**Location**: `lib/features/haiku/presentation/pages/haiku_input_page.dart`

**Dependency Direction**:
```
haiku_input_page.dart
  â†“ uses
shared/presentation/widgets/
  - AppTextField
  - AppFilledButton
  - AppBackButton
  - AppScaffoldWithBackground
```

**Compliance Check**:
- âœ“ Feature â†’ Shared (allowed)
- âœ“ No Feature â†’ Feature (correct)
- âœ“ No Shared â†’ Feature (correct)
- âœ“ No circular dependencies

### Code Style Compliance

**Style Guide**: docs/STYLE_GUIDE.md

**Naming Conventions**:
- âœ“ lowerCamelCase for variables: `inputController.text`
- âœ“ lowerCamelCase for parameters: `firstLine`, `secondLine`, `thirdLine`
- âœ“ Explicit types: `String firstLine.value`
- âœ“ Descriptive names: Clear intent from variable names

**Code Formatting**:
- âœ“ Proper indentation (2 spaces)
- âœ“ Ternary operator formatting
- âœ“ Line length < 80 characters (when possible)
- âœ“ Consistent bracket placement

**Documentation**:
- âœ“ Existing documentation maintained
- âœ“ No new public APIs (no new docs needed)
- âœ“ Japanese comments preserved

---

## Risk Analysis

### Risk Assessment Matrix

| Risk | Probability | Impact | Severity | Mitigation |
|------|------------|--------|----------|------------|
| Breaking existing functionality | Low | High | Medium | Comprehensive testing (28+ tests) |
| Performance degradation | Very Low | Medium | Low | Already rebuilding on text change |
| Japanese IME issues | Low | Medium | Low | Manual testing on devices |
| Test failures | Low | Medium | Low | Follow existing test patterns |
| Style guide violations | Very Low | Low | Low | Run `dart format` |
| Architecture violations | Very Low | High | Low | Stay within Feature layer |

### Risk Mitigation Strategies

#### 1. Breaking Existing Functionality
**Mitigation**:
- Run all 23 existing tests before and after changes
- No modifications to existing test cases
- Preserve all existing conditional logic
- Test all steps (0, 1, 2, 3) individually

**Validation**:
```bash
fvm flutter test test/features/haiku/presentation/pages/haiku_input_page_test.dart
```

#### 2. Performance Degradation
**Mitigation**:
- Leverage existing rebuild mechanism (already happening)
- No new listeners or state variables
- HaikuPreview is lightweight (StatelessWidget)
- Flutter's efficient widget diffing

**Validation**:
- Manual testing on devices
- Monitor for any UI lag during input

#### 3. Japanese IME Issues
**Mitigation**:
- Test with Japanese keyboard on iOS/Android
- Verify IME composition events work correctly
- Test with various Japanese input methods

**Validation**:
- Manual testing with Japanese keyboard
- Test hiragana, katakana, kanji input

#### 4. Test Failures
**Mitigation**:
- Follow existing test patterns exactly
- Reuse test infrastructure (setLargeTestSurface, pumpTestWidget)
- Verify widget properties using same approach
- Run tests incrementally during development

**Validation**:
```bash
# Run specific test file during development
fvm flutter test test/features/haiku/presentation/pages/haiku_input_page_test.dart

# Run full suite before commit
fvm flutter test
```

### Rollback Plan

If critical issues arise during implementation:

**Step 1**: Revert code changes
```bash
git checkout HEAD -- lib/features/haiku/presentation/pages/haiku_input_page.dart
```

**Step 2**: Verify tests pass
```bash
fvm flutter test
```

**Step 3**: Document issue
- Create GitHub issue with details
- Investigate root cause
- Plan alternative approach

---

## Quality Gates

All quality gates must pass before merging:

### 1. Static Analysis
```bash
fvm flutter analyze
```
**Requirement**: Zero errors, zero warnings
**Estimated Time**: 2 minutes

### 2. Code Formatting
```bash
dart format --set-exit-if-changed .
```
**Requirement**: No formatting changes needed
**Estimated Time**: 1 minute

### 3. Test Suite
```bash
fvm flutter test
```
**Requirement**: All tests passing (28+ tests)
**Estimated Time**: 5 minutes

### 4. Test Coverage
```bash
fvm flutter test --coverage
```
**Requirement**: New code covered by tests
**Estimated Time**: 5 minutes

### 5. Manual Testing
**Requirement**: Realtime preview works on all steps
**Platforms**: iOS Simulator, Android Emulator (if available)
**Estimated Time**: 10 minutes

### 6. Architecture Review
**Requirement**:
- âœ“ Three-layer architecture maintained
- âœ“ No Feature â†’ Feature dependencies
- âœ“ Changes in correct layer (Feature â†’ Presentation)

### 7. Documentation Review
**Requirement**:
- âœ“ Investigation document exists
- âœ“ Plan document complete
- âœ“ Code comments maintained
- âœ“ No new public APIs requiring docs

---

## Implementation Checklist

### Pre-Implementation

- [ ] Review investigation document: `docs/investigate/investigate_20251130_125010.md`
- [ ] Review this plan document: `docs/plan/plan_20251130_125620.md`
- [ ] Verify branch: `feature/realtime-haiku-preview`
- [ ] Pull latest changes from main
- [ ] Run existing tests to establish baseline

### Implementation Phase

#### Code Changes
- [ ] Modify `haiku_input_page.dart` lines 204-209
- [ ] Verify code compiles: `fvm flutter pub get`
- [ ] Run formatter: `dart format lib/features/haiku/presentation/pages/haiku_input_page.dart`

#### Test Implementation
- [ ] Add Test 2.1.1: Step 0 realtime preview
- [ ] Add Test 2.1.2: Step 1 realtime preview
- [ ] Add Test 2.1.3: Step 2 realtime preview
- [ ] Add Test 2.2.1: Confirmed value preservation
- [ ] Add Test 2.2.2: Input cleared on transition
- [ ] Add Test 2.3.1: Empty input display
- [ ] Add Test 2.3.2: Special characters display

### Quality Verification

#### Automated Checks
- [ ] Run static analysis: `fvm flutter analyze` â†’ 0 errors
- [ ] Run formatter check: `dart format --set-exit-if-changed .` â†’ No changes
- [ ] Run all tests: `fvm flutter test` â†’ All passing
- [ ] Run specific test: `fvm flutter test test/features/haiku/presentation/pages/haiku_input_page_test.dart` â†’ All passing

#### Manual Testing
- [ ] Test on iOS Simulator
- [ ] Test Japanese IME input
- [ ] Test all steps (0, 1, 2, 3)
- [ ] Test step transitions
- [ ] Test special characters and emojis
- [ ] Verify no performance issues

### Documentation
- [ ] Investigation document completed
- [ ] Plan document completed
- [ ] Code comments maintained
- [ ] No new public APIs (no docs needed)

### Final Checks
- [ ] All quality gates passed
- [ ] No breaking changes introduced
- [ ] Architecture compliance verified
- [ ] Ready for commit

---

## Post-Implementation Tasks

### Git Workflow

#### 1. Review Changes
```bash
git status
git diff
```

#### 2. Stage Changes
```bash
git add lib/features/haiku/presentation/pages/haiku_input_page.dart
git add test/features/haiku/presentation/pages/haiku_input_page_test.dart
```

#### 3. Create Commit (Angular-style)
```bash
git commit -m "feat(haiku): add realtime preview during haiku input

Enhance UX by displaying vertical haiku preview in realtime as users type.
Preview updates character-by-character based on current step.

Changes:
- Modify HaikuPreview parameters to show inputController.text
- Add conditional logic based on currentStep.value
- Add 5 widget tests for realtime preview behavior

Closes #31

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

#### 4. Push to Remote
```bash
git push -u origin feature/realtime-haiku-preview
```

### Pull Request Creation

**PR Title**: `feat(haiku): ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿³å¥ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º`

**PR Description**:
```markdown
## Summary
ä¿³å¥å…¥åŠ›ä¸­ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¸¦æ›¸ããƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

## Changes
- `haiku_input_page.dart`: HaikuPreviewã«å…¥åŠ›ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
- `haiku_input_page_test.dart`: 5ã¤ã®æ–°ã—ã„Widget testã‚’è¿½åŠ 

## Test Plan
- âœ“ æ—¢å­˜ã®23ãƒ†ã‚¹ãƒˆãŒå…¨ã¦ãƒ‘ã‚¹
- âœ“ æ–°è¦5ãƒ†ã‚¹ãƒˆãŒå…¨ã¦ãƒ‘ã‚¹
- âœ“ é™çš„è§£æã§ã‚¨ãƒ©ãƒ¼ãªã—
- âœ“ iOSã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§å‹•ä½œç¢ºèªæ¸ˆã¿

## Related Issue
Closes #31

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
```

---

## Success Criteria

Implementation is considered successful when:

1. **Functionality**:
   - âœ“ Realtime preview displays on steps 0, 1, 2
   - âœ“ Confirmed values preserved on step transitions
   - âœ“ All existing functionality maintained

2. **Quality**:
   - âœ“ All 28+ tests passing
   - âœ“ Zero static analysis errors
   - âœ“ Code properly formatted
   - âœ“ Architecture compliance verified

3. **User Experience**:
   - âœ“ No performance degradation
   - âœ“ Japanese IME works correctly
   - âœ“ Smooth input experience
   - âœ“ Visual feedback is immediate

4. **Documentation**:
   - âœ“ Investigation document complete
   - âœ“ Plan document complete
   - âœ“ PR description clear
   - âœ“ Commit message follows conventions

---

## Estimated Timeline

| Phase | Tasks | Estimated Time |
|-------|-------|----------------|
| **Code Modification** | Modify haiku_input_page.dart | 15 minutes |
| **Test Implementation** | Add 5 widget tests | 65 minutes |
| **Quality Verification** | Run all quality gates | 15 minutes |
| **Manual Testing** | Device and user flow testing | 15 minutes |
| **Git & PR** | Commit, push, create PR | 10 minutes |
| **Total** | | **2 hours** |

**Recommended Approach**: Complete in single focused session to maintain context.

---

## Conclusion

This implementation plan provides a comprehensive roadmap for adding realtime haiku preview functionality. The approach is:

- **Low Risk**: Minimal code changes, no breaking changes
- **High Value**: Significant UX improvement
- **Well Tested**: Comprehensive widget test coverage
- **Architecture Compliant**: Stays within Feature layer boundaries
- **Production Ready**: All quality gates defined and testable

The implementation should proceed as planned with high confidence of success.

---

**Plan Created By**: Claude Code (Sonnet 4.5)
**Plan Date**: 2025-11-30 12:56:20
**Status**: READY FOR IMPLEMENTATION
