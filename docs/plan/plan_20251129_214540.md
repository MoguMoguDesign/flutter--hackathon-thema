# Implementation Plan: Image Generation API Integration

**Date**: 2025-11-29 21:45:40
**Branch**: feature/image-generation-api
**Issue**: [#14 画像生成（nanobanana API連携） 3時間](https://github.com/MoguMoguDesign/flutter--hackathon-thema/issues/14)
**Investigation**: docs/investigate/investigate_20251129_213937.md

---

## Executive Summary

This plan implements AI image generation functionality for the haiku application using Gemini API. The implementation follows the project's three-layer architecture (App -> Feature -> Shared) with comprehensive test coverage.

**Estimated Tasks**: 15 implementation tasks + 5 test tasks
**Key Dependencies**: http package

---

## Implementation Strategy

### Architecture Overview

```
App Layer
    |
    v
Feature Layer (haiku)
    |-- GeneratingPage (UI)
    |-- PreviewPage (UI)
    |-- ImageGenerationProvider (State Management)
    |-- HaikuPromptService (Business Logic)
    |
    v
Shared Layer
    |-- GeminiService (HTTP Client)
    |-- ImageGenerationRepository (Data Access)
    |-- ImageGenerationResult (Model)
```

### Technology Decisions

| Component | Technology | Reason |
|-----------|------------|--------|
| API | Gemini API | 60+ RPM rate limit, base64 direct output |
| HTTP Client | http package | Lightweight, sufficient for needs |
| State Management | @riverpod annotation | Project standard |
| Models | Freezed | Immutable state classes |
| Image Storage | Uint8List in memory | MVP simplicity |

---

## Task Breakdown (Priority Order)

### Phase 1: Infrastructure Setup (P0 - Critical)

#### Task 1.1: Add http dependency
**Priority**: P0 - Critical
**File**: `pubspec.yaml`
**Action**: Modify
**Estimated Size**: XS

```yaml
dependencies:
  http: ^1.2.0
```

**Acceptance Criteria**:
- [ ] http package added to pubspec.yaml
- [ ] `fvm flutter pub get` succeeds

---

### Phase 2: Shared Layer Implementation (P0 - Critical)

#### Task 2.1: Create GeminiService
**Priority**: P0 - Critical
**File**: `lib/shared/service/gemini_service.dart`
**Action**: Create
**Estimated Size**: M

**Responsibilities**:
- HTTP client wrapper for Gemini API
- Request formatting with proper headers
- Response parsing (extract base64 image)
- Timeout handling (60 seconds)
- Error transformation

**Interface**:
```dart
/// Gemini API クライアントサービス
///
/// 画像生成 API へのアクセスを提供する。
class GeminiService {
  GeminiService({http.Client? httpClient});

  /// 指定されたプロンプトから画像を生成する
  ///
  /// [prompt] 画像生成のプロンプト
  /// [aspectRatio] アスペクト比（デフォルト: 4:5）
  ///
  /// Returns: 生成された画像のbase64データとMIMEタイプ
  /// Throws: [GeminiApiException] API エラー発生時
  Future<({String base64Data, String mimeType})> generateImage({
    required String prompt,
    String aspectRatio = '4:5',
  });
}
```

**Error Types**:
- `GeminiApiException.network` - Network error
- `GeminiApiException.timeout` - Timeout (60s)
- `GeminiApiException.invalidResponse` - Invalid response format
- `GeminiApiException.apiError` - API returned error

**Acceptance Criteria**:
- [ ] HTTP POST to Gemini endpoint
- [ ] API key from --dart-define
- [ ] 60 second timeout
- [ ] Base64 extraction from JSON response
- [ ] Proper error handling with typed exceptions
- [ ] Japanese doc comments

---

#### Task 2.2: Create GeminiApiException
**Priority**: P0 - Critical
**File**: `lib/shared/service/gemini_api_exception.dart`
**Action**: Create
**Estimated Size**: S

**Implementation**:
```dart
/// Gemini API 例外クラス
///
/// API 呼び出し時のエラーを表現する。
sealed class GeminiApiException implements Exception {
  const GeminiApiException(this.message);

  final String message;

  /// ネットワークエラー
  const factory GeminiApiException.network(String message) = _NetworkException;

  /// タイムアウトエラー
  const factory GeminiApiException.timeout(String message) = _TimeoutException;

  /// API エラー
  const factory GeminiApiException.apiError(String message) = _ApiException;

  /// 不正なレスポンス形式
  const factory GeminiApiException.invalidResponse(String message) = _InvalidResponseException;
}
```

**Acceptance Criteria**:
- [ ] Sealed class with factory constructors
- [ ] Japanese doc comments
- [ ] Message property for each error type

---

#### Task 2.3: Create ImageGenerationResult Model
**Priority**: P0 - Critical
**File**: `lib/shared/models/image_generation_result.dart`
**Action**: Create
**Estimated Size**: S

**Implementation**:
```dart
import 'dart:typed_data';
import 'package:freezed_annotation/freezed_annotation.dart';

part 'image_generation_result.freezed.dart';

/// 画像生成結果モデル
///
/// Gemini API から返された画像データを保持する。
@freezed
class ImageGenerationResult with _$ImageGenerationResult {
  /// 画像生成結果を作成する
  ///
  /// [imageData] 画像のバイナリデータ
  /// [mimeType] 画像のMIMEタイプ
  const factory ImageGenerationResult({
    required Uint8List imageData,
    required String mimeType,
  }) = _ImageGenerationResult;
}
```

**Acceptance Criteria**:
- [ ] Freezed model with Uint8List imageData
- [ ] mimeType field
- [ ] Japanese doc comments
- [ ] Generated files (.freezed.dart)

---

#### Task 2.4: Create ImageGenerationRepository
**Priority**: P0 - Critical
**File**: `lib/shared/data/repositories/image_generation_repository.dart`
**Action**: Create
**Estimated Size**: M

**Implementation**:
```dart
import 'package:riverpod_annotation/riverpod_annotation.dart';

part 'image_generation_repository.g.dart';

/// 画像生成リポジトリ
///
/// 画像生成サービスへのアクセスを抽象化する。
class ImageGenerationRepository {
  ImageGenerationRepository({required GeminiService geminiService})
      : _geminiService = geminiService;

  final GeminiService _geminiService;

  /// 指定されたプロンプトから画像を生成する
  ///
  /// [prompt] 画像生成のプロンプト
  ///
  /// Returns: [ImageGenerationResult] 生成結果
  /// Throws: [GeminiApiException] エラー発生時
  Future<ImageGenerationResult> generateImage({
    required String prompt,
  }) async {
    final result = await _geminiService.generateImage(prompt: prompt);
    final imageData = base64.decode(result.base64Data);
    return ImageGenerationResult(
      imageData: imageData,
      mimeType: result.mimeType,
    );
  }
}

/// 画像生成リポジトリのプロバイダー
@riverpod
ImageGenerationRepository imageGenerationRepository(
  ImageGenerationRepositoryRef ref,
) {
  return ImageGenerationRepository(
    geminiService: ref.watch(geminiServiceProvider),
  );
}
```

**Acceptance Criteria**:
- [ ] Uses GeminiService via DI
- [ ] Converts base64 to Uint8List
- [ ] Returns ImageGenerationResult
- [ ] Riverpod provider with @riverpod annotation
- [ ] Japanese doc comments

---

#### Task 2.5: Create GeminiService Provider
**Priority**: P0 - Critical
**File**: `lib/shared/service/gemini_service.dart`
**Action**: Modify (add provider)
**Estimated Size**: XS

**Implementation**:
```dart
/// Gemini サービスのプロバイダー
@riverpod
GeminiService geminiService(GeminiServiceRef ref) {
  return GeminiService();
}
```

**Acceptance Criteria**:
- [ ] Provider defined with @riverpod
- [ ] Generated .g.dart file

---

### Phase 3: Feature Layer Implementation (P0 - Critical)

#### Task 3.1: Create HaikuPromptService
**Priority**: P0 - Critical
**File**: `lib/features/haiku/service/haiku_prompt_service.dart`
**Action**: Create
**Estimated Size**: S

**Implementation**:
```dart
/// 俳句プロンプト生成サービス
///
/// 俳句を画像生成用プロンプトに変換する。
class HaikuPromptService {
  /// 俳句から画像生成プロンプトを生成する
  ///
  /// [firstLine] 上の句
  /// [secondLine] 中の句
  /// [thirdLine] 下の句
  ///
  /// Returns: Gemini API 用のプロンプト文字列
  String generatePrompt({
    required String firstLine,
    required String secondLine,
    required String thirdLine,
  }) {
    final haiku = '$firstLine\n$secondLine\n$thirdLine';
    return '''
「$haiku」

上記の俳句から連想される情景を浮世絵風に描いてください。

指示:
- 葛飾北斎や歌川広重の画風を参考にした伝統的な日本美術スタイル
- 藍、朱、緑青、黄土など日本の伝統色を使用
- 木版画の摺り跡と和紙の風合いを表現
- 俳句の文字列を画像内に縦書きで配置
- 五七五の区切りで改行して表示
- 余白を大切にした構図
''';
  }
}
```

**Acceptance Criteria**:
- [ ] Combines 3 haiku lines
- [ ] Generates ukiyo-e style prompt
- [ ] Includes haiku text embedding instruction
- [ ] Japanese doc comments

---

#### Task 3.2: Create ImageGenerationState
**Priority**: P0 - Critical
**File**: `lib/features/haiku/presentation/state/image_generation_state.dart`
**Action**: Create
**Estimated Size**: S

**Implementation**:
```dart
import 'dart:typed_data';
import 'package:freezed_annotation/freezed_annotation.dart';

part 'image_generation_state.freezed.dart';

/// 画像生成状態
///
/// 画像生成の進行状態を表現する。
@freezed
class ImageGenerationState with _$ImageGenerationState {
  /// 初期状態
  const factory ImageGenerationState.initial() = _Initial;

  /// 生成中状態
  ///
  /// [progress] 進捗率（0.0 - 1.0）
  const factory ImageGenerationState.loading(double progress) = _Loading;

  /// 生成成功状態
  ///
  /// [imageData] 生成された画像データ
  const factory ImageGenerationState.success(Uint8List imageData) = _Success;

  /// エラー状態
  ///
  /// [message] エラーメッセージ
  const factory ImageGenerationState.error(String message) = _Error;
}
```

**Acceptance Criteria**:
- [ ] 4 states: initial, loading, success, error
- [ ] loading with progress double
- [ ] success with Uint8List imageData
- [ ] error with message string
- [ ] Freezed generation

---

#### Task 3.3: Create ImageGenerationProvider
**Priority**: P0 - Critical
**File**: `lib/features/haiku/presentation/providers/image_generation_provider.dart`
**Action**: Create
**Estimated Size**: M

**Implementation**:
```dart
import 'package:riverpod_annotation/riverpod_annotation.dart';

part 'image_generation_provider.g.dart';

/// 画像生成プロバイダー
///
/// 俳句から画像を生成する状態管理を提供する。
@riverpod
class ImageGeneration extends _$ImageGeneration {
  @override
  ImageGenerationState build() {
    return const ImageGenerationState.initial();
  }

  /// 俳句から画像を生成する
  ///
  /// [firstLine] 上の句
  /// [secondLine] 中の句
  /// [thirdLine] 下の句
  Future<void> generate({
    required String firstLine,
    required String secondLine,
    required String thirdLine,
  }) async {
    state = const ImageGenerationState.loading(0.0);

    try {
      // プロンプト生成
      final promptService = HaikuPromptService();
      final prompt = promptService.generatePrompt(
        firstLine: firstLine,
        secondLine: secondLine,
        thirdLine: thirdLine,
      );

      state = const ImageGenerationState.loading(0.3);

      // 画像生成
      final repository = ref.read(imageGenerationRepositoryProvider);
      final result = await repository.generateImage(prompt: prompt);

      state = ImageGenerationState.success(result.imageData);
    } on GeminiApiException catch (e) {
      state = ImageGenerationState.error(_mapErrorMessage(e));
    } catch (e) {
      state = const ImageGenerationState.error('予期しないエラーが発生しました');
    }
  }

  String _mapErrorMessage(GeminiApiException e) {
    return switch (e) {
      _NetworkException() => 'ネットワーク接続を確認してください',
      _TimeoutException() => '生成に時間がかかりすぎました。再試行してください',
      _ApiException() => '画像生成に失敗しました。再試行してください',
      _InvalidResponseException() => '予期しないエラーが発生しました',
    };
  }

  /// 状態をリセットする
  void reset() {
    state = const ImageGenerationState.initial();
  }
}
```

**Acceptance Criteria**:
- [ ] @riverpod annotation
- [ ] generate() method with 3 haiku lines
- [ ] Progress updates during generation
- [ ] Error mapping to Japanese messages
- [ ] reset() method

---

#### Task 3.4: Modify GeneratingPage
**Priority**: P0 - Critical
**File**: `lib/features/haiku/presentation/pages/generating_page.dart`
**Action**: Modify
**Estimated Size**: L

**Changes**:
1. Replace mock simulation with actual API call
2. Use ImageGenerationProvider for state
3. Navigate to PreviewPage on success
4. Handle error state with retry option

**Key Code Changes**:
```dart
// Before: HookWidget
// After: HookConsumerWidget

class GeneratingPage extends HookConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final generationState = ref.watch(imageGenerationProvider);

    // Trigger generation on mount
    useEffect(() {
      ref.read(imageGenerationProvider.notifier).generate(
        firstLine: firstLine,
        secondLine: secondLine,
        thirdLine: thirdLine,
      );
      return null;
    }, []);

    // Handle state changes
    ref.listen(imageGenerationProvider, (previous, next) {
      next.whenOrNull(
        success: (imageData) {
          // Navigate to preview with image data
          PreviewRoute(
            firstLine: firstLine,
            secondLine: secondLine,
            thirdLine: thirdLine,
            imageData: imageData,  // Changed from imageUrl
          ).go(context);
        },
        error: (message) {
          // Show error dialog
          _showErrorDialog(context, message);
        },
      );
    });

    // Update progress based on state
    final progress = generationState.maybeWhen(
      loading: (p) => p,
      orElse: () => 0.0,
    );

    // Rest of UI...
  }
}
```

**Acceptance Criteria**:
- [ ] Uses HookConsumerWidget
- [ ] Watches ImageGenerationProvider
- [ ] Triggers generation on mount
- [ ] Navigates to preview on success
- [ ] Shows error dialog on failure
- [ ] Progress bar reflects actual state

---

#### Task 3.5: Modify PreviewPage
**Priority**: P0 - Critical
**File**: `lib/features/haiku/presentation/pages/preview_page.dart`
**Action**: Modify
**Estimated Size**: M

**Changes**:
1. Change imageUrl parameter to imageData (Uint8List)
2. Use Image.memory() instead of Image.network()
3. Update regenerate flow

```dart
// Before
final String imageUrl;

// After
final Uint8List imageData;

// Image display
Image.memory(
  imageData,
  fit: BoxFit.cover,
)
```

**Acceptance Criteria**:
- [ ] imageData parameter (Uint8List)
- [ ] Image.memory() for display
- [ ] Regenerate navigates to GeneratingPage

---

#### Task 3.6: Update Routes
**Priority**: P0 - Critical
**File**: `lib/app/app_router/routes.dart`
**Action**: Modify
**Estimated Size**: S

**Changes**:
```dart
// Update PreviewRoute
@TypedGoRoute<PreviewRoute>(path: '/create/preview')
class PreviewRoute extends GoRouteData with $PreviewRoute {
  const PreviewRoute({
    required this.firstLine,
    required this.secondLine,
    required this.thirdLine,
    required this.imageData,  // Changed from imageUrl
  });

  final String firstLine;
  final String secondLine;
  final String thirdLine;
  final Uint8List imageData;  // Changed from String imageUrl

  // ...
}
```

**Note**: Uint8List may need special handling for route parameters. Consider:
- Store in provider and pass reference
- Or use base64 string encoding

**Acceptance Criteria**:
- [ ] PreviewRoute accepts Uint8List or image reference
- [ ] Route builder updated
- [ ] Code generation successful

---

### Phase 4: API Key Configuration (P1 - High)

#### Task 4.1: API Key Configuration
**Priority**: P1 - High
**Files**: Multiple
**Action**: Create/Modify
**Estimated Size**: S

**Implementation**:

1. Add constant file:
```dart
// lib/shared/constants/api_config.dart

/// API 設定
///
/// 環境変数から API キーを取得する。
class ApiConfig {
  ApiConfig._();

  /// Gemini API キー
  ///
  /// --dart-define=GEMINI_API_KEY=xxx で設定
  static const String geminiApiKey = String.fromEnvironment(
    'GEMINI_API_KEY',
    defaultValue: '',
  );

  /// API キーが設定されているかチェック
  static bool get hasGeminiApiKey => geminiApiKey.isNotEmpty;
}
```

2. Update GeminiService to use ApiConfig

**Acceptance Criteria**:
- [ ] API key from --dart-define
- [ ] Fallback for missing key
- [ ] No hardcoded keys in code

---

### Phase 5: Testing (P0 - Critical)

#### Task 5.1: GeminiService Unit Tests
**Priority**: P0 - Critical
**File**: `test/shared/service/gemini_service_test.dart`
**Action**: Create
**Estimated Size**: L

**Test Cases**:
```dart
void main() {
  group('GeminiService', () {
    group('generateImage', () {
      test('returns image data on successful response', () async {});
      test('throws NetworkException on network error', () async {});
      test('throws TimeoutException after 60 seconds', () async {});
      test('throws InvalidResponseException on malformed JSON', () async {});
      test('throws ApiError on API error response', () async {});
    });
  });
}
```

**Acceptance Criteria**:
- [ ] Mock http.Client
- [ ] Test success case
- [ ] Test all error cases
- [ ] 60 second timeout test

---

#### Task 5.2: ImageGenerationRepository Unit Tests
**Priority**: P0 - Critical
**File**: `test/shared/data/repositories/image_generation_repository_test.dart`
**Action**: Create
**Estimated Size**: M

**Test Cases**:
```dart
void main() {
  group('ImageGenerationRepository', () {
    test('returns ImageGenerationResult on success', () async {});
    test('converts base64 to Uint8List correctly', () async {});
    test('propagates GeminiApiException', () async {});
  });
}
```

**Acceptance Criteria**:
- [ ] Mock GeminiService
- [ ] Test base64 conversion
- [ ] Test error propagation

---

#### Task 5.3: HaikuPromptService Unit Tests
**Priority**: P0 - Critical
**File**: `test/features/haiku/service/haiku_prompt_service_test.dart`
**Action**: Create
**Estimated Size**: S

**Test Cases**:
```dart
void main() {
  group('HaikuPromptService', () {
    group('generatePrompt', () {
      test('combines three lines into prompt', () {});
      test('includes ukiyo-e style instructions', () {});
      test('includes vertical text instruction', () {});
    });
  });
}
```

**Acceptance Criteria**:
- [ ] Verify prompt contains all 3 lines
- [ ] Verify style instructions
- [ ] Verify text embedding instruction

---

#### Task 5.4: ImageGenerationProvider Unit Tests
**Priority**: P0 - Critical
**File**: `test/features/haiku/presentation/providers/image_generation_provider_test.dart`
**Action**: Create
**Estimated Size**: L

**Test Cases**:
```dart
void main() {
  group('ImageGenerationProvider', () {
    group('generate', () {
      test('transitions from initial to loading to success', () async {});
      test('transitions to error on API failure', () async {});
      test('maps network error to Japanese message', () async {});
      test('maps timeout error to Japanese message', () async {});
    });

    group('reset', () {
      test('returns to initial state', () {});
    });
  });
}
```

**Acceptance Criteria**:
- [ ] Test state transitions
- [ ] Test error message mapping
- [ ] Use Riverpod test utilities

---

#### Task 5.5: GeneratingPage Widget Tests
**Priority**: P1 - High
**File**: `test/features/haiku/presentation/pages/generating_page_test.dart`
**Action**: Create
**Estimated Size**: M

**Test Cases**:
```dart
void main() {
  group('GeneratingPage', () {
    testWidgets('shows loading indicator while generating', (tester) async {});
    testWidgets('shows progress bar with correct value', (tester) async {});
    testWidgets('navigates to preview on success', (tester) async {});
    testWidgets('shows error dialog on failure', (tester) async {});
  });
}
```

**Acceptance Criteria**:
- [ ] Mock provider with ProviderScope override
- [ ] Test loading state UI
- [ ] Test navigation on success
- [ ] Test error dialog

---

## File Change Summary

### New Files (12 files)

| File | Layer | Type |
|------|-------|------|
| `lib/shared/service/gemini_service.dart` | Shared | Service |
| `lib/shared/service/gemini_api_exception.dart` | Shared | Exception |
| `lib/shared/models/image_generation_result.dart` | Shared | Model |
| `lib/shared/data/repositories/image_generation_repository.dart` | Shared | Repository |
| `lib/shared/constants/api_config.dart` | Shared | Config |
| `lib/features/haiku/service/haiku_prompt_service.dart` | Feature | Service |
| `lib/features/haiku/presentation/state/image_generation_state.dart` | Feature | State |
| `lib/features/haiku/presentation/providers/image_generation_provider.dart` | Feature | Provider |
| `test/shared/service/gemini_service_test.dart` | Test | Unit |
| `test/shared/data/repositories/image_generation_repository_test.dart` | Test | Unit |
| `test/features/haiku/service/haiku_prompt_service_test.dart` | Test | Unit |
| `test/features/haiku/presentation/providers/image_generation_provider_test.dart` | Test | Unit |

### Modified Files (4 files)

| File | Changes |
|------|---------|
| `pubspec.yaml` | Add http: ^1.2.0 |
| `lib/features/haiku/presentation/pages/generating_page.dart` | Replace mock with real API |
| `lib/features/haiku/presentation/pages/preview_page.dart` | Change imageUrl to imageData |
| `lib/app/app_router/routes.dart` | Update PreviewRoute params |

### Generated Files (Auto-generated)

| File | Generator |
|------|-----------|
| `lib/shared/models/image_generation_result.freezed.dart` | Freezed |
| `lib/shared/data/repositories/image_generation_repository.g.dart` | Riverpod |
| `lib/shared/service/gemini_service.g.dart` | Riverpod |
| `lib/features/haiku/presentation/state/image_generation_state.freezed.dart` | Freezed |
| `lib/features/haiku/presentation/providers/image_generation_provider.g.dart` | Riverpod |
| `lib/app/app_router/routes.g.dart` | go_router_builder |

---

## Dependency Graph

```
pubspec.yaml
    |
    v
[1] GeminiApiException (no deps)
    |
    v
[2] GeminiService (depends on http, ApiConfig, Exception)
    |
    v
[3] ImageGenerationResult (no deps, Freezed)
    |
    v
[4] ImageGenerationRepository (depends on GeminiService, Result)
    |
    v
[5] HaikuPromptService (no deps)
    |
    v
[6] ImageGenerationState (no deps, Freezed)
    |
    v
[7] ImageGenerationProvider (depends on Repository, PromptService, State)
    |
    v
[8] GeneratingPage (depends on Provider)
    |
    v
[9] Routes + PreviewPage (depends on GeneratingPage changes)
```

---

## Verification Commands

### After Each Task

```bash
# Code generation
fvm flutter pub run build_runner build --delete-conflicting-outputs

# Static analysis
fvm flutter analyze

# Format check
dart format --set-exit-if-changed .
```

### After All Tasks

```bash
# Run all tests
fvm flutter test

# Run with coverage
fvm flutter test --coverage

# Manual test
fvm flutter run --dart-define=GEMINI_API_KEY=AIzaSyATSjXts7-jC-6KQTHmo7uDv_taJZmsokM
```

---

## Risk Analysis

### Risk 1: Uint8List in Route Parameters

**Risk**: go_router may not support Uint8List directly in route parameters
**Mitigation**:
- Option A: Store image in provider, pass reference ID
- Option B: Use base64 encoding (less efficient)
- **Recommendation**: Option A - use provider for image storage

### Risk 2: Memory Usage

**Risk**: Large image data in memory
**Mitigation**:
- Clear provider state when navigating away
- Limit to single image at a time
- Consider image compression if needed

### Risk 3: API Key Security

**Risk**: API key exposure
**Mitigation**:
- Use --dart-define for runtime injection
- Never commit keys to repository
- Add documentation for key management

---

## Acceptance Criteria Summary

### Functional Requirements

- [ ] Image generated from haiku using Gemini API
- [ ] Loading indicator with progress
- [ ] Error messages in Japanese
- [ ] Regenerate functionality works
- [ ] Generated image displayed in preview

### Technical Requirements

- [ ] All static analysis passes (`fvm flutter analyze`)
- [ ] All tests pass (`fvm flutter test`)
- [ ] Code formatted (`dart format --set-exit-if-changed .`)
- [ ] Three-layer architecture followed
- [ ] Japanese doc comments on public APIs

### Test Coverage

- [ ] GeminiService: 5 test cases
- [ ] ImageGenerationRepository: 3 test cases
- [ ] HaikuPromptService: 3 test cases
- [ ] ImageGenerationProvider: 5 test cases
- [ ] GeneratingPage: 4 widget tests

---

## Conclusion

```
status: SUCCESS
next: IMPLEMENT
details: "Flutter implementation plan creation complete. Comprehensive coverage supported. Details recorded in plan_20251129_214540.md. Moving to implementation phase."
```

---

## Implementation Order Checklist

```
[ ] Task 1.1: Add http dependency
[ ] Task 2.2: Create GeminiApiException
[ ] Task 2.1: Create GeminiService
[ ] Task 2.3: Create ImageGenerationResult Model
[ ] Task 2.4: Create ImageGenerationRepository
[ ] Task 2.5: Create GeminiService Provider
[ ] Task 4.1: API Key Configuration
[ ] Task 3.1: Create HaikuPromptService
[ ] Task 3.2: Create ImageGenerationState
[ ] Task 3.3: Create ImageGenerationProvider
[ ] Task 3.4: Modify GeneratingPage
[ ] Task 3.5: Modify PreviewPage
[ ] Task 3.6: Update Routes
[ ] Run build_runner
[ ] Task 5.1: GeminiService Unit Tests
[ ] Task 5.2: ImageGenerationRepository Unit Tests
[ ] Task 5.3: HaikuPromptService Unit Tests
[ ] Task 5.4: ImageGenerationProvider Unit Tests
[ ] Task 5.5: GeneratingPage Widget Tests
[ ] Final verification commands
[ ] Manual testing
```
