# Implementation Plan: Firebase Functions を利用した Gemini API 呼び出しのセキュア化

**Issue**: #66
**Branch**: `feature/firebase-functions-gemini-api`
**Investigation**: `docs/investigate/investigate_20251201_issue66.md`
**Date**: 2025-12-01

---

## 1. 実装戦略

### 1.1 概要

Firebase Functions を中間層として導入し、Gemini API キーをサーバーサイドで管理することでセキュリティを強化する。画像生成、Storage保存、Firestore保存を一括でサーバー側で実行し、クライアントにはURLのみを返却する。

### 1.2 実装アプローチ

**段階的実装**: 4フェーズに分割し、各フェーズで動作確認を行いながら進める

1. **Phase 1**: 認証基盤 (匿名認証)
2. **Phase 2**: Firebase Functions (サーバーサイド)
3. **Phase 3**: Flutter統合 (クライアントサイド)
4. **Phase 4**: クリーンアップと最終検証

### 1.3 アーキテクチャ適合性

| レイヤー | 変更内容 | 依存方向 |
|---------|---------|---------|
| App Layer | `main.dart` で認証初期化 | App -> Shared |
| Feature Layer (haiku) | Provider/State/Page 更新 | Feature -> Shared |
| Shared Layer | AuthService, FunctionsService 追加 | 独立 |

三層アーキテクチャの依存方向 (App -> Feature -> Shared) を維持。

---

## 2. 詳細タスク一覧

### Phase 1: 認証基盤 (優先度: 高)

| # | タスク | 見積 | 依存 |
|---|-------|------|------|
| 1.1 | Firebase Console で匿名認証を有効化 | 手動 | - |
| 1.2 | `firebase_auth` パッケージを追加 | 5分 | - |
| 1.3 | `AuthService` クラス実装 | 30分 | 1.2 |
| 1.4 | `AuthService` テスト実装 | 30分 | 1.3 |
| 1.5 | `main.dart` で認証初期化追加 | 15分 | 1.3 |
| 1.6 | 認証フロー動作確認 | 15分 | 1.5 |

### Phase 2: Firebase Functions (優先度: 高)

| # | タスク | 見積 | 依存 |
|---|-------|------|------|
| 2.1 | Firebase Functions プロジェクト初期化 (Python) | 15分 | - |
| 2.2 | Python 仮想環境と依存関係設定 | 10分 | 2.1 |
| 2.3 | `generate_and_save_image` Function 実装 | 60分 | 2.2 |
| 2.4 | Secret Manager に API キー登録 | 10分 | 2.3 |
| 2.5 | Functions エミュレーターでテスト | 30分 | 2.4 |
| 2.6 | Functions デプロイ | 15分 | 2.5 |

### Phase 3: Flutter統合 (優先度: 高)

| # | タスク | 見積 | 依存 |
|---|-------|------|------|
| 3.1 | `cloud_functions` パッケージを追加 | 5分 | 2.6 |
| 3.2 | `FirebaseFunctionsService` 実装 | 45分 | 3.1 |
| 3.3 | `FirebaseFunctionsService` テスト実装 | 45分 | 3.2 |
| 3.4 | `ImageGenerationState` を URL ベースに変更 | 30分 | 3.2 |
| 3.5 | `ImageGenerationState` テスト更新 | 20分 | 3.4 |
| 3.6 | `ImageGenerationRepository` 更新 | 30分 | 3.4 |
| 3.7 | `ImageGenerationRepository` テスト更新 | 30分 | 3.6 |
| 3.8 | `ImageGenerationProvider` 更新 | 30分 | 3.6 |
| 3.9 | `ImageGenerationProvider` テスト更新 | 30分 | 3.8 |
| 3.10 | `PreviewPage` を `Image.network` に変更 | 30分 | 3.8 |
| 3.11 | `PreviewPage` テスト更新 | 30分 | 3.10 |
| 3.12 | `ImageSaveProvider` 簡略化 | 20分 | 3.10 |
| 3.13 | `ImageSaveProvider` テスト更新 | 20分 | 3.12 |

### Phase 4: クリーンアップ (優先度: 中)

| # | タスク | 見積 | 依存 |
|---|-------|------|------|
| 4.1 | 旧 `GeminiService` 削除 | 10分 | 3.13 |
| 4.2 | `gemini_service_test.dart` 削除 | 5分 | 4.1 |
| 4.3 | `image_generation_repository_web.dart` 削除 | 5分 | 4.1 |
| 4.4 | `image_generation_repository_stub.dart` 削除 | 5分 | 4.3 |
| 4.5 | `ApiConfig` から API キー設定削除 | 10分 | 4.1 |
| 4.6 | `api_config_test.dart` 更新 | 15分 | 4.5 |
| 4.7 | 全テスト実行 + 静的解析 | 15分 | 4.6 |
| 4.8 | 動作検証 (Web) | 30分 | 4.7 |
| 4.9 | ドキュメント更新 | 20分 | 4.8 |

---

## 3. ファイル変更計画

### 3.1 新規作成ファイル

#### Shared Layer

| ファイル | 説明 |
|---------|------|
| `lib/shared/service/auth_service.dart` | 匿名認証サービス |
| `lib/shared/service/auth_service.g.dart` | 自動生成 (Riverpod) |
| `lib/shared/service/firebase_functions_service.dart` | Functions呼び出しサービス |
| `lib/shared/service/firebase_functions_service.g.dart` | 自動生成 (Riverpod) |
| `lib/shared/service/firebase_functions_exception.dart` | Functions例外クラス |
| `test/shared/service/auth_service_test.dart` | AuthServiceテスト |
| `test/shared/service/firebase_functions_service_test.dart` | FunctionsServiceテスト |

#### Firebase Functions (プロジェクトルート)

| ファイル | 説明 |
|---------|------|
| `functions/main.py` | Functions エントリーポイント |
| `functions/requirements.txt` | Python 依存関係 |
| `functions/.env.example` | 環境変数サンプル |
| `functions/.gitignore` | Git除外設定 |

### 3.2 変更ファイル

#### App Layer

| ファイル | 変更内容 |
|---------|---------|
| `lib/main.dart` | 匿名認証の初期化処理を追加 |
| `pubspec.yaml` | `firebase_auth`, `cloud_functions` 追加 |

#### Feature Layer (haiku)

| ファイル | 変更内容 |
|---------|---------|
| `lib/features/haiku/presentation/state/image_generation_state.dart` | `Uint8List` -> `String` (URL) |
| `lib/features/haiku/presentation/state/image_generation_state.freezed.dart` | 自動再生成 |
| `lib/features/haiku/presentation/providers/image_generation_provider.dart` | Functions経由に変更 |
| `lib/features/haiku/presentation/providers/image_generation_provider.g.dart` | 自動再生成 |
| `lib/features/haiku/presentation/providers/image_save_provider.dart` | 簡略化 (Storage保存不要) |
| `lib/features/haiku/presentation/providers/image_save_provider.g.dart` | 自動再生成 |
| `lib/features/haiku/presentation/pages/preview_page.dart` | `Image.network` に変更 |

#### Shared Layer

| ファイル | 変更内容 |
|---------|---------|
| `lib/shared/data/repositories/image_generation_repository.dart` | Functions経由に変更 |
| `lib/shared/data/repositories/image_generation_repository.g.dart` | 自動再生成 |
| `lib/shared/constants/api_config.dart` | APIキー関連を削除 |
| `lib/shared/models/image_generation_result.dart` | URL フィールド追加 |
| `lib/shared/models/image_generation_result.freezed.dart` | 自動再生成 |

#### テストファイル

| ファイル | 変更内容 |
|---------|---------|
| `test/shared/constants/api_config_test.dart` | APIキーテスト削除 |
| `test/features/haiku/presentation/providers/image_generation_provider_test.dart` | 新規作成または更新 |
| `test/features/haiku/presentation/providers/image_save_provider_test.dart` | 簡略化対応 |

### 3.3 削除ファイル

| ファイル | 理由 |
|---------|------|
| `lib/shared/service/gemini_service.dart` | Functions に移行 |
| `lib/shared/service/gemini_service.g.dart` | 上記に伴い削除 |
| `lib/shared/service/gemini_api_exception.dart` | FunctionsExceptionに統合 |
| `lib/shared/data/repositories/image_generation_repository_web.dart` | Web専用実装不要 |
| `lib/shared/data/repositories/image_generation_repository_stub.dart` | Stub不要 |
| `test/shared/service/gemini_service_test.dart` | 上記に伴い削除 |
| `test/shared/service/gemini_api_exception_test.dart` | 上記に伴い削除 |

---

## 4. 実装詳細

### 4.1 AuthService (匿名認証)

```dart
// lib/shared/service/auth_service.dart
import 'package:firebase_auth/firebase_auth.dart';
import 'package:riverpod_annotation/riverpod_annotation.dart';

part 'auth_service.g.dart';

/// 認証サービス
///
/// Firebase Authentication を使用した認証機能を提供する。
/// 匿名認証によりユーザー登録不要でアプリを利用可能にする。
class AuthService {
  /// コンストラクタ
  ///
  /// [firebaseAuth] テスト時にモックを注入可能
  AuthService({FirebaseAuth? firebaseAuth})
    : _auth = firebaseAuth ?? FirebaseAuth.instance;

  final FirebaseAuth _auth;

  /// 現在のユーザーを取得
  User? get currentUser => _auth.currentUser;

  /// 認証済みかどうか
  bool get isAuthenticated => currentUser != null;

  /// 匿名認証でサインイン
  ///
  /// 既にサインイン済みの場合は何もしない。
  /// Returns: 認証されたユーザー
  Future<User> ensureAuthenticated() async {
    if (isAuthenticated) {
      return currentUser!;
    }

    final credential = await _auth.signInAnonymously();
    return credential.user!;
  }

  /// サインアウト
  Future<void> signOut() async {
    await _auth.signOut();
  }
}

/// AuthService プロバイダー
@riverpod
AuthService authService(Ref ref) {
  return AuthService();
}
```

### 4.2 FirebaseFunctionsService

```dart
// lib/shared/service/firebase_functions_service.dart
import 'package:cloud_functions/cloud_functions.dart';
import 'package:riverpod_annotation/riverpod_annotation.dart';

import 'firebase_functions_exception.dart';

part 'firebase_functions_service.g.dart';

/// Firebase Functions 呼び出しサービス
///
/// 画像生成 Function への呼び出しを提供する。
class FirebaseFunctionsService {
  /// コンストラクタ
  ///
  /// [functions] テスト時にモックを注入可能
  FirebaseFunctionsService({FirebaseFunctions? functions})
    : _functions = functions ?? FirebaseFunctions.instance;

  final FirebaseFunctions _functions;

  /// 画像を生成して保存する
  ///
  /// [prompt] 画像生成プロンプト
  /// [haikuId] 俳句ID (オプション)
  /// [firstLine] 上の句
  /// [secondLine] 中の句
  /// [thirdLine] 下の句
  ///
  /// Returns: 生成された画像のURL
  Future<String> generateAndSaveImage({
    required String prompt,
    String? haikuId,
    String? firstLine,
    String? secondLine,
    String? thirdLine,
  }) async {
    try {
      final callable = _functions.httpsCallable(
        'generateAndSaveImage',
        options: HttpsCallableOptions(timeout: const Duration(seconds: 120)),
      );

      final result = await callable.call<Map<String, dynamic>>({
        'prompt': prompt,
        'haikuId': haikuId,
        'firstLine': firstLine,
        'secondLine': secondLine,
        'thirdLine': thirdLine,
      });

      final data = result.data;
      if (data['success'] != true || data['imageUrl'] == null) {
        throw const FunctionsException('画像生成に失敗しました');
      }

      return data['imageUrl'] as String;
    } on FirebaseFunctionsException catch (e) {
      throw FunctionsException(_mapFirebaseError(e));
    } catch (e) {
      if (e is FunctionsException) rethrow;
      throw FunctionsException('予期しないエラー: $e');
    }
  }

  String _mapFirebaseError(FirebaseFunctionsException e) {
    return switch (e.code) {
      'unauthenticated' => '認証が必要です。アプリを再起動してください',
      'permission-denied' => 'アクセス権限がありません',
      'resource-exhausted' => 'リクエスト上限に達しました。しばらく待ってから再試行してください',
      'deadline-exceeded' => '処理がタイムアウトしました。再試行してください',
      'internal' => 'サーバーエラーが発生しました',
      _ => '画像生成に失敗しました。再試行してください',
    };
  }
}

/// FirebaseFunctionsService プロバイダー
@riverpod
FirebaseFunctionsService firebaseFunctionsService(Ref ref) {
  return FirebaseFunctionsService();
}
```

### 4.3 ImageGenerationState (URL ベース)

```dart
// lib/features/haiku/presentation/state/image_generation_state.dart
import 'package:freezed_annotation/freezed_annotation.dart';

part 'image_generation_state.freezed.dart';

/// 画像生成状態
///
/// 画像生成の進行状況と結果を管理する。
/// URL ベースで画像を参照する。
@freezed
sealed class ImageGenerationState with _$ImageGenerationState {
  /// 初期状態
  const factory ImageGenerationState.initial() = _Initial;

  /// 読み込み中
  ///
  /// [progress] 進捗率 (0.0 - 1.0)
  const factory ImageGenerationState.loading(double progress) = _Loading;

  /// 成功
  ///
  /// [imageUrl] 生成された画像のURL (Firebase Storage)
  const factory ImageGenerationState.success(String imageUrl) = _Success;

  /// エラー
  ///
  /// [message] エラーメッセージ
  const factory ImageGenerationState.error(String message) = _Error;
}
```

### 4.4 main.dart (認証初期化)

```dart
// lib/main.dart (変更部分)
import 'package:flutterhackthema/shared/service/auth_service.dart';

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();

  try {
    debugPrint('Firebase初期化開始');
    await Firebase.initializeApp(
      options: DefaultFirebaseOptions.currentPlatform,
    );
    debugPrint('Firebase初期化完了');

    // 匿名認証でサインイン
    debugPrint('匿名認証開始');
    final authService = AuthService();
    await authService.ensureAuthenticated();
    debugPrint('匿名認証完了');

    // Firestoreキャッシュ設定
    // ... (既存コード)
  } catch (e, stackTrace) {
    debugPrint('Firebase initialization error: $e');
    debugPrint('Stack trace: $stackTrace');
  }

  runApp(const ProviderScope(child: MainApp()));
}
```

### 4.5 Firebase Functions (Python)

#### requirements.txt

```text
# functions/requirements.txt
firebase-functions>=0.4.0
firebase-admin>=6.0.0
google-generativeai>=0.8.0
```

#### main.py

```python
# functions/main.py
"""Firebase Functions for Haiku Image Generation.

Gemini APIを使用して俳句画像を生成し、
Firebase StorageとFirestoreに保存する。
"""

import base64
import time
from typing import Any

import google.generativeai as genai
from firebase_admin import firestore, initialize_app, storage
from firebase_functions import https_fn, options
from firebase_functions.params import SecretParam

# Firebase Admin SDKを初期化
initialize_app()

# Secret Managerから取得するAPIキー
GEMINI_API_KEY = SecretParam("GEMINI_API_KEY")


@https_fn.on_call(
    secrets=[GEMINI_API_KEY],
    timeout_sec=120,
    memory=options.MemoryOption.MB_512,
)
def generate_and_save_image(req: https_fn.CallableRequest) -> dict[str, Any]:
    """画像を生成してFirebase Storageに保存する。

    Args:
        req: Firebase Functionsのリクエストオブジェクト

    Returns:
        生成された画像のURLを含む辞書

    Raises:
        HttpsError: 認証エラー、入力エラー、または内部エラー
    """
    # 認証チェック
    if req.auth is None:
        raise https_fn.HttpsError(
            code=https_fn.FunctionsErrorCode.UNAUTHENTICATED,
            message="認証が必要です",
        )

    user_id = req.auth.uid
    data = req.data

    # 入力バリデーション
    prompt = data.get("prompt")
    if not prompt:
        raise https_fn.HttpsError(
            code=https_fn.FunctionsErrorCode.INVALID_ARGUMENT,
            message="プロンプトが必要です",
        )

    haiku_id = data.get("haikuId")
    first_line = data.get("firstLine", "")
    second_line = data.get("secondLine", "")
    third_line = data.get("thirdLine", "")

    try:
        # 1. Gemini APIで画像生成
        genai.configure(api_key=GEMINI_API_KEY.value)
        model = genai.GenerativeModel("gemini-2.0-flash-exp-image-generation")

        response = model.generate_content(
            contents=prompt,
            generation_config=genai.GenerationConfig(
                response_modalities=["IMAGE", "TEXT"],
            ),
        )

        # 2. 画像データを取得
        image_data = None
        mime_type = "image/jpeg"

        for part in response.candidates[0].content.parts:
            if hasattr(part, "inline_data") and part.inline_data:
                image_data = base64.b64decode(part.inline_data.data)
                mime_type = part.inline_data.mime_type or mime_type
                break

        if image_data is None:
            raise https_fn.HttpsError(
                code=https_fn.FunctionsErrorCode.INTERNAL,
                message="画像生成に失敗しました",
            )

        # 3. Firebase Storageに保存
        bucket = storage.bucket()
        timestamp = int(time.time() * 1000)
        effective_haiku_id = haiku_id or f"haiku_{timestamp}"
        file_name = f"haiku_images/{user_id}/{effective_haiku_id}_{timestamp}.jpg"

        blob = bucket.blob(file_name)
        blob.upload_from_string(
            image_data,
            content_type=mime_type,
        )
        blob.metadata = {
            "firstLine": first_line,
            "secondLine": second_line,
            "thirdLine": third_line,
        }
        blob.patch()
        blob.make_public()

        image_url = blob.public_url

        # 4. Firestoreにメタデータ保存
        db = firestore.client()
        db.collection("generated_images").add({
            "userId": user_id,
            "haikuId": effective_haiku_id,
            "imageUrl": image_url,
            "prompt": prompt,
            "firstLine": first_line,
            "secondLine": second_line,
            "thirdLine": third_line,
            "createdAt": firestore.SERVER_TIMESTAMP,
        })

        # 5. URLを返却
        return {
            "imageUrl": image_url,
            "success": True,
        }

    except https_fn.HttpsError:
        raise
    except Exception as e:
        print(f"Image generation error: {e}")
        raise https_fn.HttpsError(
            code=https_fn.FunctionsErrorCode.INTERNAL,
            message="画像生成に失敗しました",
        ) from e
```

---

## 5. テスト戦略

### 5.1 テストカバレッジ目標

| カテゴリ | 目標 |
|---------|------|
| Unit Tests | 80%以上 |
| Widget Tests | 主要UI100% |
| Integration Tests | 主要フロー |

### 5.2 新規テスト

#### AuthService テスト

```dart
// test/shared/service/auth_service_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:mockito/mockito.dart';
import 'package:firebase_auth/firebase_auth.dart';

// テスト内容:
// - ensureAuthenticated: 未認証時に匿名認証を実行
// - ensureAuthenticated: 認証済み時は何もしない
// - signOut: サインアウト処理
// - isAuthenticated: 認証状態の確認
```

#### FirebaseFunctionsService テスト

```dart
// test/shared/service/firebase_functions_service_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:mockito/mockito.dart';

// テスト内容:
// - generateAndSaveImage: 正常系 - URLを返す
// - generateAndSaveImage: 認証エラー時の例外
// - generateAndSaveImage: タイムアウト時の例外
// - generateAndSaveImage: サーバーエラー時の例外
```

### 5.3 更新テスト

| テストファイル | 更新内容 |
|--------------|---------|
| `image_generation_provider_test.dart` | Functionsモック、URL状態対応 |
| `image_save_provider_test.dart` | 簡略化対応 |
| `api_config_test.dart` | APIキーテスト削除 |

### 5.4 テスト実行コマンド

```bash
# 全テスト実行
fvm flutter test

# カバレッジ付き
fvm flutter test --coverage

# 特定テスト
fvm flutter test test/shared/service/auth_service_test.dart
```

---

## 6. リスク分析と対策

| リスク | 影響度 | 発生確率 | 対策 |
|-------|-------|---------|------|
| Functions コールドスタート遅延 | 中 | 高 | タイムアウト120秒、ローディングUI改善 |
| Firebase Blaze プラン必須 | 低 | 確定 | 無料枠で十分対応可能 (月200万回) |
| Secret Manager 設定ミス | 高 | 中 | デプロイ前にエミュレーターで検証 |
| 既存テスト破損 | 中 | 中 | 段階的実装、各フェーズでテスト実行 |
| 画像URL の CORS 問題 | 中 | 低 | Storage の公開設定で対応済み |
| 匿名ユーザー UID 消失 | 低 | 中 | 将来的に正式認証リンク機能を検討 |

---

## 7. 検証項目

### 7.1 フェーズ別検証

#### Phase 1 完了時
- [ ] Firebase Console で匿名認証が有効
- [ ] アプリ起動時に匿名ユーザーが作成される
- [ ] `fvm flutter test` 全パス

#### Phase 2 完了時
- [ ] Functions エミュレーターで動作確認
- [ ] Secret Manager に API キー登録済み
- [ ] Functions デプロイ成功

#### Phase 3 完了時
- [ ] 画像生成が Functions 経由で動作
- [ ] 生成画像が Storage に保存される
- [ ] PreviewPage で URL から画像表示
- [ ] `fvm flutter test` 全パス

#### Phase 4 完了時
- [ ] 旧コード削除完了
- [ ] `fvm flutter analyze` エラーなし
- [ ] `dart format --set-exit-if-changed .` パス
- [ ] `fvm flutter test` 全パス
- [ ] Web ビルド成功、動作確認

### 7.2 最終確認コマンド

```bash
# 依存関係更新
fvm flutter pub get

# コード生成
fvm flutter pub run build_runner build --delete-conflicting-outputs

# 静的解析
fvm flutter analyze

# フォーマット
dart format --set-exit-if-changed .

# テスト
fvm flutter test

# Web ビルド
fvm flutter build web
```

---

## 8. 実装スケジュール

| フェーズ | タスク数 | 見積時間 |
|---------|---------|---------|
| Phase 1 | 6 | 約1.5時間 |
| Phase 2 | 6 | 約2.5時間 |
| Phase 3 | 13 | 約6時間 |
| Phase 4 | 9 | 約2時間 |
| **合計** | **34** | **約12時間** |

---

## 9. 成果物

### 9.1 コード成果物

- 認証サービス (`AuthService`)
- Functions サービス (`FirebaseFunctionsService`)
- 更新された画像生成フロー
- Firebase Functions (`generateAndSaveImage`)

### 9.2 ドキュメント成果物

- 実装ドキュメント (`docs/implement/implement_{TIMESTAMP}.md`)
- テスト結果 (`docs/test/test_{TIMESTAMP}.md`)

---

## 10. 結論

```
status: SUCCESS
next: IMPLEMENT
details: "Flutter実装計画作成完了。包括的カバレッジ対応。詳細はplan_20251201_issue66.mdに記録。実装フェーズへ移行。"
```

### 推奨次ステップ

1. `/implement` コマンドで実装フェーズを開始
2. Phase 1 (認証基盤) から順次実装
3. 各フェーズ完了時にテスト実行

---

## 11. 参考リンク

- [GitHub Issue #66](https://github.com/MoguMoguDesign/flutter--hackathon-thema/issues/66)
- [Investigation Document](./investigate/investigate_20251201_issue66.md)
- [Firebase Functions v2 (Python)](https://firebase.google.com/docs/functions/get-started?gen=2nd&hl=ja#python)
- [Firebase Functions Python SDK](https://firebase.google.com/docs/reference/functions/python)
- [Firebase Anonymous Auth](https://firebase.google.com/docs/auth/flutter/anonymous-auth)
- [Cloud Functions for Flutter](https://firebase.google.com/docs/functions/callable)
- [Google Generative AI Python SDK](https://ai.google.dev/gemini-api/docs/quickstart?lang=python)
