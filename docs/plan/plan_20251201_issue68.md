# Implementation Plan: Issue #68 - Haiku List Sort by Date

## Plan Summary

- **Issue**: #68 - みんなの投稿一覧を投稿日時の降順で表示する
- **Branch**: `feature/haiku-list-sort-by-date`
- **Date**: 2025-12-01
- **Investigation**: `docs/investigate/investigate_20251201_issue68.md`
- **Estimated Effort**: Low complexity

---

## 1. Implementation Strategy

### Overview

Modify `haikuListStreamProvider` to pass a Firestore query with `orderBy('createdAt', descending: true)` to the existing `watchAll()` method.

### Approach

The implementation leverages existing infrastructure:
- `FirestoreRepository.watchAll()` already accepts an optional `query` parameter
- `HaikuModel` already has a `createdAt` field
- No new dependencies or architectural changes required

---

## 2. Task Breakdown

### Priority: High (P1)

| # | Task | Priority | Estimated Lines |
|---|------|----------|-----------------|
| 1 | Modify `haikuListStreamProvider` to add orderBy query | P1 | ~3 lines |
| 2 | Update Japanese documentation comments | P1 | ~2 lines |
| 3 | Run code generation (`build_runner`) | P1 | Command |
| 4 | Add unit test for `haikuListStreamProvider` | P1 | ~30 lines |
| 5 | Run verification commands | P1 | Commands |

---

## 3. File Change Plan

### 3.1 Files to Modify

#### `lib/features/haiku/presentation/providers/haiku_provider.dart`

**Current Code (Lines 39-43):**
```dart
/// 俳句一覧のストリームプロバイダー
///
/// Firestoreから俳句一覧をリアルタイムで監視します
@riverpod
Stream<List<HaikuModel>> haikuListStream(Ref ref) {
  final repository = ref.watch(haikuRepositoryProvider);
  return repository.watchAll();
}
```

**New Code:**
```dart
/// 俳句一覧のストリームプロバイダー
///
/// Firestoreから俳句一覧をリアルタイムで監視します。
/// 投稿日時の降順（新しい順）でソートされます。
@riverpod
Stream<List<HaikuModel>> haikuListStream(Ref ref) {
  final repository = ref.watch(haikuRepositoryProvider);
  final query = repository.collection.orderBy('createdAt', descending: true);
  return repository.watchAll(query: query);
}
```

**Changes:**
- Add `query` variable with `orderBy('createdAt', descending: true)`
- Pass `query` parameter to `watchAll()`
- Update documentation comment to mention sort order

### 3.2 Files to Update (Tests)

#### `test/features/haiku/presentation/providers/haiku_provider_test.dart`

**Add new test group for `haikuListStreamProvider`:**

```dart
group('haikuListStreamProvider', () {
  late MockHaikuRepository mockRepository;
  late ProviderContainer container;

  setUp(() {
    mockRepository = MockHaikuRepository();
    container = ProviderContainer(
      overrides: [haikuRepositoryProvider.overrideWithValue(mockRepository)],
    );
  });

  tearDown(() {
    container.dispose();
  });

  test('returns stream from repository watchAll with orderBy query', () {
    // Arrange
    final testHaikus = [
      HaikuModel(
        id: '1',
        firstLine: '古池や',
        secondLine: '蛙飛び込む',
        thirdLine: '水の音',
        createdAt: DateTime(2025, 12, 1),
      ),
    ];
    when(mockRepository.watchAll(query: anyNamed('query')))
        .thenAnswer((_) => Stream.value(testHaikus));
    when(mockRepository.collection).thenReturn(/* mock collection */);

    // Act
    final stream = container.read(haikuListStreamProvider.future);

    // Assert
    verify(mockRepository.watchAll(query: anyNamed('query'))).called(1);
  });
});
```

### 3.3 Files Unchanged

- `lib/features/haiku/data/repositories/haiku_repository.dart` - No changes needed
- `lib/shared/data/repositories/firestore_repository.dart` - No changes needed
- `lib/features/haiku/data/models/haiku_model.dart` - No changes needed
- `lib/features/haiku/presentation/pages/haiku_list_page.dart` - No changes needed

---

## 4. Architecture Compliance

### Layer Analysis

| Layer | Component | Status |
|-------|-----------|--------|
| Feature | `haiku_provider.dart` | Modification |
| Feature | `haiku_provider_test.dart` | Test Update |
| Shared | `firestore_repository.dart` | No Change |

### Dependency Check

```
App Layer
  ↓
Feature Layer (haiku)
  - haiku_provider.dart (MODIFY)
  ↓
Shared Layer
  - firestore_repository.dart (NO CHANGE)
```

**Result**: Dependencies remain correct (Feature → Shared). No Feature-to-Feature dependencies introduced.

---

## 5. Test Strategy

### 5.1 Unit Tests (Mandatory)

| Test Case | Description | Status |
|-----------|-------------|--------|
| `haikuListStreamProvider uses orderBy query` | Verify watchAll is called with query parameter | NEW |
| Existing `HaikuNotifier` tests | Ensure no regression | EXISTING |

### 5.2 Test Implementation

**File**: `test/features/haiku/presentation/providers/haiku_provider_test.dart`

Add test group:
```dart
group('haikuListStreamProvider', () {
  test('calls watchAll with orderBy createdAt descending query', () async {
    // Test implementation
  });
});
```

### 5.3 Manual Testing

| Test Case | Steps | Expected Result |
|-----------|-------|-----------------|
| Sort order verification | 1. Open haiku list page<br>2. Create new haiku<br>3. Verify it appears at top | Newest haiku at top |
| Empty state | 1. Clear all haikus<br>2. Open list page | Empty state displayed |
| Multiple haikus | 1. Create multiple haikus<br>2. Verify order | Sorted by date descending |

---

## 6. Tech Stack Compatibility

| Package | Version | Compatible |
|---------|---------|------------|
| hooks_riverpod | ^3.0.3 | Yes |
| riverpod_annotation | ^2.6.1 | Yes |
| cloud_firestore | ^5.6.7 | Yes |
| go_router | ^16.2.4 | N/A |
| freezed | ^3.2.3 | N/A |

**Note**: This change only uses Firestore query API and Riverpod, both fully compatible.

---

## 7. Risk Analysis

| Risk | Level | Mitigation |
|------|-------|------------|
| Breaking existing functionality | Low | Change is additive, not modifying existing logic |
| Firestore index requirement | Low | Single-field sort uses automatic indexes |
| Performance impact | None | Server-side sorting is efficient |
| Test coverage gap | Medium | Add new test for `haikuListStreamProvider` |
| Code generation issues | Low | Run `build_runner` after changes |

---

## 8. Implementation Steps

### Step 1: Modify Provider (5 min)

```bash
# Edit haiku_provider.dart
# Add orderBy query to haikuListStreamProvider
```

### Step 2: Run Code Generation (2 min)

```bash
fvm flutter pub run build_runner build --delete-conflicting-outputs
```

### Step 3: Add Unit Test (10 min)

```bash
# Edit haiku_provider_test.dart
# Add test group for haikuListStreamProvider
```

### Step 4: Verification Commands (5 min)

```bash
# Static analysis
fvm flutter analyze

# Format check
dart format --set-exit-if-changed .

# Run tests
fvm flutter test

# Run specific test file
fvm flutter test test/features/haiku/presentation/providers/haiku_provider_test.dart
```

### Step 5: Manual Testing (5 min)

- Run app on emulator/device
- Verify haiku list is sorted by date (newest first)
- Create new haiku and verify it appears at top

### Step 6: Commit (2 min)

```bash
git add .
git commit -m "feat(haiku): add descending sort by createdAt to haiku list

- Modify haikuListStreamProvider to pass orderBy query
- Add unit test for sort order verification
- Closes #68"
```

---

## 9. Acceptance Criteria

- [ ] Haiku list displays posts in descending order by creation date
- [ ] `haikuListStreamProvider` passes `orderBy('createdAt', descending: true)` query
- [ ] Unit test added for `haikuListStreamProvider`
- [ ] All existing tests pass
- [ ] `fvm flutter analyze` reports no issues
- [ ] `dart format --set-exit-if-changed .` passes
- [ ] Manual testing confirms newest posts appear first

---

## 10. Rollback Plan

If issues arise:

1. Revert the single line change in `haikuListStreamProvider`
2. Run `build_runner` to regenerate
3. Remove added test (optional)

The change is isolated and easily reversible.

---

## 11. Conclusion

```
status: SUCCESS
next: IMPLEMENT
details: "Flutter implementation plan creation complete.
         Simple modification to haikuListStreamProvider required.
         Comprehensive test coverage supported.
         Details recorded in plan_20251201_issue68.md.
         Moving to implementation phase."
```

---

## Appendix: Code Changes Summary

### haiku_provider.dart (Diff)

```diff
 /// 俳句一覧のストリームプロバイダー
 ///
-/// Firestoreから俳句一覧をリアルタイムで監視します
+/// Firestoreから俳句一覧をリアルタイムで監視します。
+/// 投稿日時の降順（新しい順）でソートされます。
 @riverpod
 Stream<List<HaikuModel>> haikuListStream(Ref ref) {
   final repository = ref.watch(haikuRepositoryProvider);
-  return repository.watchAll();
+  final query = repository.collection.orderBy('createdAt', descending: true);
+  return repository.watchAll(query: query);
 }
```

**Total Lines Changed**: ~5 lines
**New Test Lines**: ~30 lines
