# Implementation Plan: Firebase Storage Image Display Fix

## Issue Reference
- **Issue**: [#61](https://github.com/MoguMoguDesign/flutter--hackathon-thema/issues/61)
- **Title**: Firebase Storageの画像がみんなの投稿一覧で表示されない
- **Branch**: `fix/firebase-storage-image-display`
- **Date**: 2025-11-30
- **Investigation Doc**: `docs/investigate/investigate_20251130_issue61.md`

---

## 1. Executive Summary

### 1.1 Problem
みんなの投稿一覧(`HaikuListPage`)で、Firebase Storageに保存された俳句画像が表示されない。

### 1.2 Root Cause
Firebase Storage Security Rules (`storage.rules`) が全ての読み取り操作に認証を要求しているため、公開コンテンツである俳句画像にアクセスできない。

### 1.3 Solution Overview
1. `storage.rules` を更新して `haiku_images/` への公開読み取りを許可
2. エラーログを追加して問題のデバッグを容易化
3. ウィジェットテストを追加してカバレッジを向上

---

## 2. Implementation Strategy

### 2.1 Approach
**Minimal Invasive Fix** - 最小限の変更で問題を解決し、既存コードへの影響を最小化する。

### 2.2 Architecture Compliance

| Check | Status | Notes |
|-------|--------|-------|
| Three-Layer Architecture | OK | Feature層のみ変更 |
| Riverpod Patterns | OK | Provider変更なし |
| Feature Independence | OK | Feature間依存なし |
| Shared Layer | OK | 変更なし |

---

## 3. Task Breakdown

### Phase 1: Core Fix (Priority: High)

#### Task 1.1: Update Firebase Storage Security Rules
- **File**: `storage.rules`
- **Type**: Modify
- **Priority**: Critical
- **Estimated Effort**: 5 min

**Changes**:
```javascript
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // 俳句画像: 読み取りは全員、書き込みは認証済みユーザーのみ
    match /haiku_images/{allPaths=**} {
      allow read: if true;  // 公開読み取り
      allow write: if request.auth != null;  // 認証済みのみ書き込み
    }

    // デフォルトルール: 認証済みユーザーのみ読み書き可能
    match /{allPaths=**} {
      allow read, write: if request.auth != null;
    }
  }
}
```

**Rationale**:
- `haiku_images/` パスへの公開読み取りを許可
- 書き込みは引き続き認証が必要
- 他のストレージパスは認証必須のまま

#### Task 1.2: Add Error Logging to HaikuCard
- **File**: `lib/features/haiku/presentation/widgets/haiku_card.dart`
- **Type**: Modify
- **Priority**: High
- **Estimated Effort**: 10 min

**Changes**:
1. `Logger` をインポート
2. `static final Logger _logger` を追加
3. `errorBuilder` にログ出力を追加

```dart
import 'package:logger/logger.dart';

class HaikuCard extends StatelessWidget {
  // 追加: ロガーインスタンス
  static final Logger _logger = Logger();

  // ...existing code...

  // 変更: errorBuilder内にログを追加
  errorBuilder: (context, error, stackTrace) {
    _logger.e(
      'Failed to load haiku image',
      error: error,
      stackTrace: stackTrace,
    );
    _logger.d('ImageURL: ${haiku.imageUrl}');
    return _buildFallbackCard();
  },
}
```

#### Task 1.3: Add Error Logging to HaikuDetailPage
- **File**: `lib/features/haiku/presentation/pages/haiku_detail_page.dart`
- **Type**: Modify
- **Priority**: High
- **Estimated Effort**: 10 min

**Changes**:
1. `Logger` をインポート（既存のインポートを確認）
2. `static final Logger _logger` を追加
3. `errorBuilder` にログ出力を追加

```dart
import 'package:logger/logger.dart';

class HaikuDetailPage extends HookConsumerWidget {
  // 追加: ロガーインスタンス
  static final Logger _logger = Logger();

  // ...existing code...

  // 変更: errorBuilder内にログを追加
  errorBuilder: (context, error, stackTrace) {
    _logger.e(
      'Failed to load haiku detail image',
      error: error,
      stackTrace: stackTrace,
    );
    return _buildFallbackImage(haiku);
  },
}
```

### Phase 2: Test Coverage (Priority: High)

#### Task 2.1: Create HaikuCard Widget Tests
- **File**: `test/features/haiku/presentation/widgets/haiku_card_test.dart`
- **Type**: Create
- **Priority**: High
- **Estimated Effort**: 30 min

**Test Cases**:

```dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:flutterhackthema/features/haiku/data/models/haiku_model.dart';
import 'package:flutterhackthema/features/haiku/presentation/widgets/haiku_card.dart';

void main() {
  group('HaikuCard', () {
    // テスト用のモックデータ
    final testHaiku = HaikuModel(
      id: 'test-id',
      firstLine: '古池や',
      secondLine: '蛙飛び込む',
      thirdLine: '水の音',
      createdAt: DateTime.now(),
      imageUrl: null,
    );

    final testHaikuWithImage = testHaiku.copyWith(
      imageUrl: 'https://example.com/test-image.jpg',
    );

    testWidgets('imageUrlがnullの場合、フォールバックカードが表示される', (tester) async {
      bool tapped = false;

      await tester.pumpWidget(
        MaterialApp(
          home: Scaffold(
            body: HaikuCard(
              haiku: testHaiku,
              onTap: () => tapped = true,
            ),
          ),
        ),
      );

      // フォールバックカードの俳句テキストが表示される
      expect(find.text('古池や'), findsOneWidget);
      expect(find.text('蛙飛び込む'), findsOneWidget);
      expect(find.text('水の音'), findsOneWidget);
    });

    testWidgets('カードタップでonTapコールバックが呼ばれる', (tester) async {
      bool tapped = false;

      await tester.pumpWidget(
        MaterialApp(
          home: Scaffold(
            body: HaikuCard(
              haiku: testHaiku,
              onTap: () => tapped = true,
            ),
          ),
        ),
      );

      await tester.tap(find.byType(GestureDetector));
      await tester.pump();

      expect(tapped, isTrue);
    });

    testWidgets('カードのスタイルが正しく適用される', (tester) async {
      await tester.pumpWidget(
        MaterialApp(
          home: Scaffold(
            body: HaikuCard(
              haiku: testHaiku,
              onTap: () {},
            ),
          ),
        ),
      );

      // ClipRRectが存在する
      expect(find.byType(ClipRRect), findsOneWidget);

      // AspectRatioが4:5で設定されている
      final aspectRatio = tester.widget<AspectRatio>(find.byType(AspectRatio));
      expect(aspectRatio.aspectRatio, equals(4 / 5));
    });

    testWidgets('フォールバックカードの背景色が正しい', (tester) async {
      await tester.pumpWidget(
        MaterialApp(
          home: Scaffold(
            body: HaikuCard(
              haiku: testHaiku,
              onTap: () {},
            ),
          ),
        ),
      );

      // フォールバックカードのContainerを検索
      final containers = tester.widgetList<Container>(find.byType(Container));
      bool foundFallbackColor = false;
      for (final container in containers) {
        if (container.color == Colors.grey.shade300) {
          foundFallbackColor = true;
          break;
        }
      }
      expect(foundFallbackColor, isTrue);
    });

    testWidgets('imageUrlがある場合、Image.networkが使用される', (tester) async {
      await tester.pumpWidget(
        MaterialApp(
          home: Scaffold(
            body: HaikuCard(
              haiku: testHaikuWithImage,
              onTap: () {},
            ),
          ),
        ),
      );

      // Image.network が存在する（ローディング中はCircularProgressIndicatorが表示される可能性）
      expect(find.byType(Image), findsOneWidget);
    });
  });
}
```

### Phase 3: Documentation & Deployment (Priority: Medium)

#### Task 3.1: Create CORS Configuration File (Optional - Web Only)
- **File**: `cors.json`
- **Type**: Create
- **Priority**: Medium (Web platform only)
- **Estimated Effort**: 5 min

```json
[
  {
    "origin": ["*"],
    "method": ["GET"],
    "maxAgeSeconds": 3600
  }
]
```

**Note**: This file is for Firebase Storage CORS configuration. Apply with:
```bash
gsutil cors set cors.json gs://[YOUR-BUCKET-NAME]
```

---

## 4. File Change Summary

### 4.1 Files to Modify

| File | Layer | Change Type | Description |
|------|-------|-------------|-------------|
| `storage.rules` | Config | Security Rules | 公開読み取りルール追加 |
| `haiku_card.dart` | Feature/Presentation | Widget | ログ出力追加 |
| `haiku_detail_page.dart` | Feature/Presentation | Page | ログ出力追加 |

### 4.2 Files to Create

| File | Layer | Type | Description |
|------|-------|------|-------------|
| `haiku_card_test.dart` | Test | Widget Test | HaikuCardのテスト |
| `cors.json` | Config | JSON | CORS設定（オプション） |

### 4.3 Files to Delete

None

---

## 5. Test Strategy

### 5.1 Unit Tests

| Component | Test File | Status | Priority |
|-----------|-----------|--------|----------|
| HaikuModel | `haiku_model_test.dart` | Existing | - |
| HaikuRepository | `haiku_repository_test.dart` | Existing | - |
| HaikuImageStorageRepository | `haiku_image_storage_repository_test.dart` | Existing | - |

### 5.2 Widget Tests

| Component | Test File | Status | Priority |
|-----------|-----------|--------|----------|
| HaikuCard | `haiku_card_test.dart` | **To Create** | High |
| HaikuPreview | `haiku_preview_test.dart` | Existing | - |

### 5.3 Integration Tests

| Flow | Status | Priority |
|------|--------|----------|
| Image Loading Flow | Optional | Low |

### 5.4 Test Coverage Goals

- **New Tests**: 5+ test cases for HaikuCard
- **Total Coverage**: Maintain 155+ passing tests

---

## 6. Verification Commands

### 6.1 Development Phase

```bash
# Code generation (if needed)
fvm flutter pub run build_runner build --delete-conflicting-outputs

# Static analysis
fvm flutter analyze

# Format check
dart format --set-exit-if-changed .

# Run all tests
fvm flutter test

# Run specific test file
fvm flutter test test/features/haiku/presentation/widgets/haiku_card_test.dart
```

### 6.2 Post-Deployment

```bash
# Deploy storage rules to Firebase
firebase deploy --only storage

# Verify CORS (Web only)
gsutil cors get gs://[YOUR-BUCKET-NAME]
```

---

## 7. Risk Analysis

### 7.1 Risk Matrix

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Security exposure (images) | Low | Low | Only haiku images are public |
| Breaking existing tests | Very Low | Medium | No test modifications |
| Storage rules deployment failure | Low | High | Test in Firebase emulator first |
| CORS issues on Web | Medium | Medium | CORS configuration provided |

### 7.2 Rollback Plan

1. **Storage Rules**: Revert to previous rules in Firebase Console
2. **Code Changes**: Git revert the commit
3. **CORS**: Remove CORS configuration from bucket

---

## 8. Implementation Order

### 8.1 Execution Sequence

```
Step 1: Update storage.rules
    ↓
Step 2: Add error logging to haiku_card.dart
    ↓
Step 3: Add error logging to haiku_detail_page.dart
    ↓
Step 4: Create haiku_card_test.dart
    ↓
Step 5: Run verification commands
    ↓
Step 6: Commit changes
    ↓
Step 7: Deploy storage rules to Firebase
    ↓
Step 8: Verify fix in app
```

### 8.2 Estimated Total Time

| Phase | Time |
|-------|------|
| Phase 1: Core Fix | 25 min |
| Phase 2: Test Coverage | 30 min |
| Phase 3: Deployment | 10 min |
| **Total** | **~65 min** |

---

## 9. Acceptance Criteria

### 9.1 Functional Requirements

- [ ] 俳句画像が `HaikuListPage` で正しく表示される
- [ ] 俳句画像が `HaikuDetailPage` で正しく表示される
- [ ] 画像読み込みエラー時にログが出力される
- [ ] 画像がない場合にフォールバックカードが表示される

### 9.2 Technical Requirements

- [ ] `fvm flutter analyze` がエラーなし
- [ ] `dart format --set-exit-if-changed .` が成功
- [ ] `fvm flutter test` が全テスト成功（155+テスト）
- [ ] 新規テスト（HaikuCard）が5ケース以上

### 9.3 Security Requirements

- [ ] `haiku_images/` のみ公開読み取り許可
- [ ] 書き込みは認証必須
- [ ] 他のストレージパスは認証必須のまま

---

## 10. Dependencies

### 10.1 Package Dependencies

| Package | Version | Usage |
|---------|---------|-------|
| logger | ^2.6.2 | Error logging (existing) |
| flutter_test | SDK | Widget testing (existing) |

### 10.2 External Dependencies

| Dependency | Required |
|------------|----------|
| Firebase Console Access | Yes |
| gsutil (for CORS) | Optional (Web only) |

---

## 11. Conclusion

### 11.1 Summary

このプランは、Firebase Storage Security Rulesの更新とエラーログの追加により、俳句画像表示問題を解決します。さらに、HaikuCardのウィジェットテストを追加してテストカバレッジを向上させます。

### 11.2 Next Phase

**Status**: `SUCCESS`
**Next**: `IMPLEMENT`
**Details**: Flutter implementation plan creation complete. Comprehensive coverage supported.

---

## 12. Appendix

### 12.1 Related Files Reference

```
lib/features/haiku/
├── data/
│   ├── models/
│   │   └── haiku_model.dart
│   └── repositories/
│       ├── haiku_repository.dart
│       └── haiku_image_storage_repository.dart
├── presentation/
│   ├── pages/
│   │   ├── haiku_list_page.dart
│   │   └── haiku_detail_page.dart
│   ├── providers/
│   │   ├── haiku_provider.dart
│   │   └── haiku_detail_provider.dart
│   └── widgets/
│       └── haiku_card.dart  ← Modify
└── service/
    └── haiku_prompt_service.dart

test/features/haiku/
├── data/
│   └── repositories/
│       └── haiku_repository_test.dart
└── presentation/
    └── widgets/
        └── haiku_card_test.dart  ← Create
```

### 12.2 Style Guide Compliance Checklist

- [x] Japanese documentation comments (`///`)
- [x] lowerCamelCase for variables
- [x] PascalCase for classes
- [x] snake_case for file names
- [x] Logger usage (not print)
- [x] const constructors where possible
- [x] Explicit types (no var/dynamic)
