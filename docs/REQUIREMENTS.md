
## 俳句×AI画像生成アプリ 要件定義書（修正版）

### 1. ログイン画面

| 項目 | 内容 |
|------|------|
| 目的 | ユーザー認証 |
| 認証方式 | Firebase Auth（メール/パスワード） |
| UI要素 | メール入力欄、パスワード入力欄、「ログイン」ボタン、「新規登録」リンク |
| ログイン処理 | 認証成功→みんなの投稿一覧へ遷移 |
| エラー処理 | 認証失敗時エラーメッセージ表示 |

### 1-2. 新規登録画面

| 項目 | 内容 |
|------|------|
| UI要素 | メール入力欄、パスワード入力欄、パスワード確認欄、「登録」ボタン |
| バリデーション | メール形式、パスワード6文字以上、確認一致 |
| 処理 | 登録成功→自動ログイン→みんなの投稿一覧へ遷移 |

---

### 2. みんなの投稿一覧画面（ホーム）

| 項目 | 内容 |
|------|------|
| 目的 | 他ユーザーの俳句×画像投稿を閲覧 |
| レイアウト | Pinterestライク縦長フィード（Staggered Grid） |
| 画像サイズ | 4:5（Instagram縦長フィード比率） |
| 表示内容 | 生成画像、俳句テキスト、投稿日時 |
| ソート | 新着順（createdAt DESC） |
| ページネーション | 無限スクロール |
| 下部ナビ | 「みんなの投稿」「自分の投稿」タブ切り替え |

---

### 3. 自分の投稿一覧画面（マイページ）

| 項目 | 内容 |
|------|------|
| 目的 | 自分が投稿した俳句×画像を一覧表示 |
| レイアウト | 2カラムグリッド |
| 表示内容 | 生成画像サムネイル、俳句テキスト、投稿日時 |
| フィルタ | `authorId == currentUser.uid` |
| FAB | 右下にフローティングアクションボタン（+アイコン） |
| FAB押下 | 新規投稿作成画面へ遷移 |

---

### 4. 新規投稿作成画面

#### 4-1. 俳句入力

| 項目 | 内容 |
|------|------|
| 入力方式 | テキストフィールド（横書き。縦書きはNice to Have） |
| バリデーション | 空文字禁止、文字数上限100文字 |
| プレースホルダー | 「俳句を入力してください」 |
| ボタン | 「画像を生成する」 |

#### 4-2. 画像生成（アプリから直接API呼び出し）

| 項目 | 内容 |
|------|------|
| 処理フロー | Flutter → 画像生成API（DALL-E / Gemini等）→ 画像データ（Base64 or URL）取得 |
| UI | ローディングインジケーター + 「生成中...」 |
| タイムアウト | 60秒 |
| 結果 | 生成画像をメモリ上に保持（まだ保存しない） |

#### 4-3. 画像プレビュー・確認

| 項目 | 内容 |
|------|------|
| 表示 | 生成された画像（4:5）+ 入力した俳句テキスト |
| ボタン | 「投稿する」「再生成する」「キャンセル」 |
| 再生成 | 同じ俳句で再度API呼び出し |
| キャンセル | 入力画面に戻る（画像破棄） |

#### 4-4. 投稿処理（「投稿する」タップ時）

| 項目 | 内容 |
|------|------|
| Step 1 | 画像をFirebase Storageにアップロード |
| Step 2 | アップロード完了後、Storage URLを取得 |
| Step 3 | Firestoreにドキュメント作成 |
| 完了後 | トースト表示→自分の投稿一覧へ遷移 |

---

### 5. アーキテクチャ図

```
┌─────────────────────────────────────────────────────────┐
│                      Flutter App                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  [俳句入力] → [画像生成API直接呼び出し] → [プレビュー]  │
│                      ↓                                  │
│              画像データ（メモリ保持）                    │
│                      ↓                                  │
│            「投稿する」タップ                            │
│                      ↓                                  │
│         ┌─────────────────────────┐                     │
│         │  Firebase Storage      │ ← 画像アップロード  │
│         └─────────────────────────┘                     │
│                      ↓ URL取得                          │
│         ┌─────────────────────────┐                     │
│         │  Firestore             │ ← 投稿データ保存    │
│         └─────────────────────────┘                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
                      ↑
          画像生成API（DALL-E / Gemini / Imagen）
```

---

### 6. データ設計（Firestore）

```
/posts/{postId}
  - authorId: string        // Firebase Auth UID
  - authorEmail: string     // 表示用（任意）
  - haikuText: string       // 俳句テキスト
  - imageUrl: string        // Firebase Storage URL
  - createdAt: timestamp    // 作成日時
```

```
/users/{userId}
  - email: string           // メールアドレス
  - createdAt: timestamp    // 登録日時
```

---

### 7. 画面遷移図

```
[ログイン画面] ←→ [新規登録画面]
       ↓ ログイン成功
[みんなの投稿一覧（ホーム）] ←→ [自分の投稿一覧（マイページ）]
                                        ↓ FAB タップ
                                  [新規投稿作成]
                                      ↓ 俳句入力
                                      ↓ 「画像生成」タップ
                                  [画像生成中（API呼び出し）]
                                      ↓
                                  [プレビュー・確認]
                                   ↓         ↓
                            「再生成」   「投稿する」
                                 ↓              ↓
                           [再度API]    [Storage保存→Firestore保存]
                                              ↓
                                    [自分の投稿一覧へ戻る]
```

---

### 8. MVP優先度（修正版）

| 優先度 | 機能 | 備考 |
|--------|------|------|
| 🔴 Must | メール/パスワード認証 | ログイン・新規登録 |
| 🔴 Must | みんなの投稿一覧 | 縦長フィード表示 |
| 🔴 Must | 俳句入力→画像生成 | アプリから直接API呼び出し |
| 🔴 Must | プレビュー→Storage保存→投稿 | 確認後に保存 |
| 🔴 Must | 自分の投稿一覧 | FAB配置 |
| 🟡 Should | 再生成機能 | 同じ俳句で別画像 |
| 🟢 Nice | 縦書き入力 | mongolパッケージ |
| ⚪ Future | SNSシェア | Instagram連携 |
