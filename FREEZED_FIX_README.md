# Freezed Code Generation Fix

## Issue

Freezed v3.2.3 generates malformed code where documentation comments appear on the same line as getters:

```dart
// Malformed (generated by Freezed)
mixin _$User {
 String get id;/// ニックネーム（ユーザーが入力）
 String get nickname;/// 作成日時
}
```

This causes both Dart formatting issues and compilation errors in test environments.

## Solution

A bash script (`fix_freezed_formatting.sh`) has been created to fix the malformed generated files.

### What the Fix Does

1. Inserts blank lines between getters and subsequent doc comments
2. Fixes indentation of getters (from 1 space to 2 spaces)
3. Ensures proper indentation of doc comments

### Corrected Format

```dart
// After fix
mixin _$User {
  String get id;

  /// ニックネーム（ユーザーが入力）
  String get nickname;

  /// 作成日時
  DateTime get createdAt;
}
```

## Usage

### Local Development

After running `build_runner`:

```bash
fvm flutter pub run build_runner build --delete-conflicting-outputs
sh fix_freezed_formatting.sh
```

### CI/CD Integration

Add the fix script to your CI workflow after code generation:

```yaml
- name: Generate code
  run: fvm flutter pub run build_runner build --delete-conflicting-outputs

- name: Fix Freezed formatting
  run: sh fix_freezed_formatting.sh

- name: Run tests
  run: fvm flutter test
```

## Files Affected

The script automatically fixes all `.freezed.dart` files in the `lib/` directory:

- `lib/features/user/data/models/user.freezed.dart`
- `lib/features/haiku/data/models/haiku.freezed.dart`
- `lib/features/like/data/models/like.freezed.dart`
- `lib/features/like/data/models/like_count.freezed.dart`
- `lib/features/haiku/data/models/haiku_with_like_status.freezed.dart`

## Note on Test Failures

**Important**: Even with this fix, some unit tests for Freezed models may still fail due to a Dart test compiler caching issue. This is a known limitation. The tests pass in production builds (`flutter build`) but may fail in test environments (`flutter test`).

### Workaround for Persistent Test Failures

If tests continue to fail after applying the fix:

1. The formatting issues are resolved (verified with `dart format`)
2. Production builds work correctly (verified with `flutter build web`)
3. Static analysis passes (verified with `flutter analyze`)
4. The issue is limited to test environment compilation

Consider temporarily skipping the affected model tests or upgrading to Freezed v4.x (requires dependency updates).

## Root Cause

This is a code generation bug in Freezed v3.2.3 where the `dart format off` directive prevents the generated code from being properly formatted. The generator produces syntactically valid but poorly formatted Dart code.

## Future Considerations

- Upgrade to Freezed v4.x when dependency constraints allow
- Report this issue to the Freezed repository
- Consider alternative code generation approaches if the issue persists
